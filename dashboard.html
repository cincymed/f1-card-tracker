<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Card Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .card-table { width: 100%; border-collapse: collapse; }
        .card-table th, .card-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #334155; }
        .card-table th { background: #0f172a; font-weight: bold; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 10; }
        .card-table th:hover { background: #1e293b; }
        .card-table tr.data-row:hover { background: #1e293b; cursor: pointer; }
        .card-table tr.data-row:active { background: #334155; }
        .section-header { cursor: pointer; user-select: none; }
        .section-header:hover { background: rgba(59, 130, 246, 0.1) !important; }
        .section-header td { position: sticky; z-index: 5; }
        .sort-arrow { display: inline-block; margin-left: 4px; font-size: 10px; opacity: 0.5; }
        .sort-arrow.active { opacity: 1; color: #60a5fa; }
        .filter-input { background: #1e293b; border: 1px solid #475569; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 100%; margin-top: 4px; }
        .filter-input::placeholder { color: #64748b; }
        .filter-input:focus { outline: none; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
    <div id="root"></div>

    <script src="card-database.js"></script>
    <script src="chatbot-component.js"></script>

    <script>
        const MONGODB_API = 'https://f1-card-tracker-backend-1.onrender.com/api/collection';
        window.API_URL = 'https://f1-card-tracker-backend-1.onrender.com/api/recognize';
        const userId = 'cincymed-f1-collection';
        const cardDatabase = COMPLETE_CARD_DATABASE || [];
        const token = localStorage.getItem('f1-token');

        // Dashboard state
        let dashboardState = {
            sortColumn: 'num',
            sortDirection: 'asc',
            filters: { num: '', name: '', team: '', variants: '', total: '' },
            collapsedSections: {},  // Track which sections are collapsed
            allExpanded: false      // Global expand/collapse state
        };

        // Initialize all sections as collapsed
        const allSubsets = [...new Set(cardDatabase.map(c => c.subset))];
        allSubsets.forEach(subset => {
            dashboardState.collapsedSections[subset] = true; // collapsed by default
        });

        function getAuthHeaders() {
          return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          };
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${MONGODB_API}/${userId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const collection = data.cards || {};

                const historyResponse = await fetch(`${MONGODB_API}/${userId}/history`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const historyData = await historyResponse.json();
                const priceHistory = historyData.priceHistory || [];

                const stats = calculateStats(collection);

                // Override the latest snapshot's totalValue with the live-calculated value
                // so graph and snapshot table match the Current Value display
                if (priceHistory.length > 0) {
                    const latest = priceHistory[priceHistory.length - 1];
                    latest.totalValue = stats.currentValue;
                }

                // Store globally for re-renders
                window.dashboardData = { collection, stats, priceHistory };

                renderDashboard(collection, stats, priceHistory);

                // Make dashboard state accessible globally
                window.currentAppState = {
                    isDashboard: true,
                    collection,
                    stats,
                    priceHistory
                };

                // Initialize universal chatbot with dashboard context
                window.generateContextInfo = () => {
                    const state = window.currentAppState;
                    let contextInfo = "You are an AI assistant integrated into an F1 card collection dashboard. ";

                    if (state.isDashboard && state.stats) {
                        contextInfo += `The user is currently viewing their collection dashboard. `;
                        contextInfo += `Their collection contains ${state.stats.uniqueCards} unique cards and ${state.stats.totalCards} total cards from the 2025 Topps Chrome F1 set (${state.stats.totalSetCards} total cards in the set). `;
                        contextInfo += `Collection completion: ${((state.stats.uniqueCards / state.stats.totalSetCards) * 100).toFixed(1)}%. `;

                        const topVariants = Object.entries(state.stats.cardsByVariant || {})
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3)
                            .map(([variant, count]) => `${variant} (${count})`)
                            .join(', ');

                        if (topVariants) {
                            contextInfo += `Top variants owned: ${topVariants}. `;
                        }
                    }

                    contextInfo += `Be helpful and knowledgeable about F1 cards, collecting, dashboard analytics, and collection building strategies. Keep responses concise and relevant.`;
                    return contextInfo;
                };

                if (!window.chatbotContextProvider) {
                    window.initializeChatbot();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('root').innerHTML = '<div class="p-8"><p class="text-red-400">Failed to load collection</p></div>';
            }
        }

        // Get analyses for a card: prefer collection data (from MongoDB), fall back to localStorage
        function getCardAnalyses(cardNum, collection) {
            const cardKey = `card-${cardNum}`;
            // Check MongoDB-loaded collection first
            const mongoAnalyses = (collection[cardKey] || {})._analyses;
            if (mongoAnalyses && Object.keys(mongoAnalyses).length > 0) return mongoAnalyses;
            // Fall back to localStorage
            try {
                const local = JSON.parse(localStorage.getItem('f1-collection-pro-v2') || '{}');
                return (local[cardKey] || {})._analyses || {};
            } catch (e) {
                return {};
            }
        }

        // Extract max PSA 9 value from analysis text, fallback to Raw max
        function extractMaxPSA9Value(analysisText) {
            if (!analysisText) return 0;
            const clean = analysisText.replace(/\*\*/g, '').replace(/\*/g, '').replace(/[â€“â€”]/g, '-');
            const psa9Match = clean.match(/\bPSA\s*9\b[^:\n]{0,25}:\s*~?(?:approximately\s+)?\$?([\d,]+)\s*-\s*~?\$?([\d,]+)/i);
            if (psa9Match) return parseInt(psa9Match[2].replace(/,/g, ''));
            // Fallback to Raw max if no PSA 9 data
            const rawMatch = clean.match(/\bRaw\b[^:\n]{0,25}:\s*~?(?:approximately\s+)?\$?([\d,]+)\s*-\s*~?\$?([\d,]+)/i);
            if (rawMatch) return parseInt(rawMatch[2].replace(/,/g, ''));
            return 0;
        }

        // Extract max PSA 10 value from analysis text
        function extractMaxPSA10Value(analysisText) {
            if (!analysisText) return 0;
            const clean = analysisText.replace(/\*\*/g, '').replace(/\*/g, '').replace(/[â€“â€”]/g, '-');
            const psa10Match = clean.match(/\bPSA\s*10\b[^:\n]{0,25}:\s*~?(?:approximately\s+)?\$?([\d,]+)\s*-\s*~?\$?([\d,]+)/i);
            if (psa10Match) return parseInt(psa10Match[2].replace(/,/g, ''));
            return 0;
        }

        // Calculate $-$$$$$ value tier for a card
        function calculateCardValue(cardNum, collection) {
            const cardKey = `card-${cardNum}`;
            const cardInventory = collection[cardKey] || {};
            const analyses = getCardAnalyses(cardNum, collection);

            let totalMaxValue = 0;

            Object.keys(cardInventory).forEach(variant => {
                if (variant.startsWith('_')) return;
                const count = cardInventory[variant];
                if (count === 0) return;
                const variantAnalyses = analyses[variant] || [];
                if (variantAnalyses.length === 0) return;
                const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                const maxVal = extractMaxPSA9Value(latestAnalysis.analysis);
                if (maxVal > 0) totalMaxValue += maxVal * count;
            });

            if (totalMaxValue === 0) return '';
            if (totalMaxValue < 5) return '$';
            if (totalMaxValue < 15) return '$$';
            if (totalMaxValue < 30) return '$$$';
            if (totalMaxValue <= 150) return '$$$$';
            return '$$$$$';
        }

        // Calculate raw dollar value for a card (PSA 9 max)
        function calculateCardRawValue(cardNum, collection) {
            const cardKey = `card-${cardNum}`;
            const cardInventory = collection[cardKey] || {};
            const analyses = getCardAnalyses(cardNum, collection);
            let total = 0;
            Object.keys(cardInventory).forEach(variant => {
                if (variant.startsWith('_')) return;
                const count = cardInventory[variant];
                if (count === 0) return;
                const variantAnalyses = analyses[variant] || [];
                if (variantAnalyses.length === 0) return;
                const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                const maxVal = extractMaxPSA9Value(latestAnalysis.analysis);
                if (maxVal > 0) total += maxVal * count;
            });
            return total;
        }

        // Calculate total collection value as sum of max PSA 9 values
        function calculateTotalCollectionValue(collection) {
            let total = 0;
            Object.keys(collection).forEach(cardKey => {
                if (cardKey.startsWith('_') || !cardKey.startsWith('card-')) return;
                const cardNum = cardKey.replace('card-', '');
                const cardInventory = collection[cardKey];
                const analyses = getCardAnalyses(cardNum, collection);

                Object.keys(cardInventory).forEach(variant => {
                    if (variant.startsWith('_')) return;
                    const count = cardInventory[variant];
                    if (count === 0) return;
                    const variantAnalyses = analyses[variant] || [];
                    if (variantAnalyses.length === 0) return;
                    const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                    const maxVal = extractMaxPSA9Value(latestAnalysis.analysis);
                    if (maxVal > 0) total += maxVal * count;
                });
            });
            return total;
        }

        // Calculate total collection value as sum of max PSA 10 values
        function calculateTotalCollectionPSA10Value(collection) {
            let total = 0;
            Object.keys(collection).forEach(cardKey => {
                if (cardKey.startsWith('_') || !cardKey.startsWith('card-')) return;
                const cardNum = cardKey.replace('card-', '');
                const cardInventory = collection[cardKey];
                const analyses = getCardAnalyses(cardNum, collection);

                Object.keys(cardInventory).forEach(variant => {
                    if (variant.startsWith('_')) return;
                    const count = cardInventory[variant];
                    if (count === 0) return;
                    const variantAnalyses = analyses[variant] || [];
                    if (variantAnalyses.length === 0) return;
                    const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                    const maxVal = extractMaxPSA10Value(latestAnalysis.analysis);
                    if (maxVal > 0) total += maxVal * count;
                });
            });
            return total;
        }

        function calculateStats(collection) {
            let totalCards = 0;
            let uniqueCards = 0;
            const cardsByVariant = {};

            Object.keys(collection).forEach(cardKey => {
                if (!cardKey.startsWith('card-')) return;
                const variants = collection[cardKey];

                Object.keys(variants).forEach(variant => {
                    if (variant === '_analyses' || variant.startsWith('_')) return;

                    const count = variants[variant];
                    if (count > 0) {
                        totalCards += count;
                        cardsByVariant[variant] = (cardsByVariant[variant] || 0) + count;
                    }
                });

                if (Object.keys(variants).some(k => !k.startsWith('_') && variants[k] > 0)) {
                    uniqueCards++;
                }
            });

            const currentValue = calculateTotalCollectionValue(collection);
            const currentPSA10Value = calculateTotalCollectionPSA10Value(collection);

            return {
                totalCards,
                uniqueCards,
                cardsByVariant,
                totalSetCards: cardDatabase.length,
                currentValue,
                currentPSA10Value
            };
        }

        function getCardsInCollection(collection) {
            return Object.keys(collection)
                .filter(key => !key.startsWith('_'))
                .map(key => key.replace('card-', ''))
                .sort((a, b) => {
                    const numA = parseInt(a) || 999999;
                    const numB = parseInt(b) || 999999;
                    return numA - numB;
                });
        }

        function getCardData(cardNum, collection) {
            const card = cardDatabase.find(c => c.num === cardNum);
            if (!card) return null;
            const cardKey = `card-${cardNum}`;
            const variants = collection[cardKey] || {};
            const totalCount = Object.keys(variants)
                .filter(k => !k.startsWith('_'))
                .reduce((sum, v) => sum + (variants[v] || 0), 0);
            const variantList = Object.keys(variants)
                .filter(k => !k.startsWith('_') && variants[k] > 0)
                .map(v => `${v} (${variants[v]})`)
                .join(', ');
            const valueTier = calculateCardValue(cardNum, collection);
            const rawValue = calculateCardRawValue(cardNum, collection);
            return { card, totalCount, variantList, subset: card.subset, valueTier, rawValue };
        }

        function sortCards(cards, column, direction) {
            return [...cards].sort((a, b) => {
                let valA, valB;
                switch(column) {
                    case 'num':
                        valA = parseInt(a.card.num) || 999999;
                        valB = parseInt(b.card.num) || 999999;
                        break;
                    case 'name':
                        valA = a.card.name.toLowerCase();
                        valB = b.card.name.toLowerCase();
                        break;
                    case 'team':
                        valA = (a.card.team || '').toLowerCase();
                        valB = (b.card.team || '').toLowerCase();
                        break;
                    case 'variants':
                        valA = a.variantList.toLowerCase();
                        valB = b.variantList.toLowerCase();
                        break;
                    case 'total':
                        valA = a.totalCount;
                        valB = b.totalCount;
                        break;
                    case 'value':
                        valA = (a.valueTier || '').length;
                        valB = (b.valueTier || '').length;
                        break;
                    default:
                        valA = parseInt(a.card.num) || 999999;
                        valB = parseInt(b.card.num) || 999999;
                }
                if (typeof valA === 'string') {
                    const cmp = valA.localeCompare(valB);
                    return direction === 'asc' ? cmp : -cmp;
                }
                return direction === 'asc' ? valA - valB : valB - valA;
            });
        }

        function filterCards(cards, filters) {
            return cards.filter(item => {
                if (filters.num && !item.card.num.toLowerCase().includes(filters.num.toLowerCase())) return false;
                if (filters.name && !item.card.name.toLowerCase().includes(filters.name.toLowerCase())) return false;
                if (filters.team && !(item.card.team || '').toLowerCase().includes(filters.team.toLowerCase())) return false;
                if (filters.variants && !item.variantList.toLowerCase().includes(filters.variants.toLowerCase())) return false;
                if (filters.total && item.totalCount < parseInt(filters.total)) return false;
                return true;
            });
        }

        // Navigate to main UI and filter by variant
        function navigateToVariant(variant) {
            localStorage.setItem('filterVariantOnLoad', JSON.stringify({
                variant: variant,
                timestamp: Date.now()
            }));
            window.location.href = 'index.html';
        }

        // Navigate to main UI and open card detail
        function openCardDetail(cardNum) {
            const card = cardDatabase.find(c => c.num === cardNum);
            if (card) {
                localStorage.setItem('openCardOnLoad', JSON.stringify({
                    cardNum: cardNum,
                    card: card,
                    timestamp: Date.now(),
                    returnTo: 'dashboard'
                }));
                window.location.href = 'index.html';
            }
        }

        // Toggle section collapse
        function toggleSection(subset) {
            dashboardState.collapsedSections[subset] = !dashboardState.collapsedSections[subset];
            reRender();
        }

        // Expand all sections
        function expandAllSections() {
            dashboardState.allExpanded = true;
            Object.keys(dashboardState.collapsedSections).forEach(key => {
                dashboardState.collapsedSections[key] = false;
            });
            reRender();
        }

        // Collapse all sections
        function collapseAllSections() {
            dashboardState.allExpanded = false;
            Object.keys(dashboardState.collapsedSections).forEach(key => {
                dashboardState.collapsedSections[key] = true;
            });
            reRender();
        }

        // Sort by column
        function sortByColumn(column) {
            if (dashboardState.sortColumn === column) {
                dashboardState.sortDirection = dashboardState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                dashboardState.sortColumn = column;
                dashboardState.sortDirection = 'asc';
            }
            reRender();
        }

        // Update filter
        function updateFilter(column, value) {
            dashboardState.filters[column] = value;
            dashboardState._activeFilterColumn = column;
            const el = document.activeElement;
            dashboardState._cursorPosition = el ? el.selectionStart : null;
            reRender();
        }

        // Re-render with current state
        function reRender() {
            if (window.dashboardData) {
                renderDashboard(
                    window.dashboardData.collection,
                    window.dashboardData.stats,
                    window.dashboardData.priceHistory
                );
            }
        }

        function renderSortArrow(column) {
            const isActive = dashboardState.sortColumn === column;
            const arrow = isActive
                ? (dashboardState.sortDirection === 'asc' ? 'â–²' : 'â–¼')
                : 'â–²â–¼';
            return `<span class="sort-arrow ${isActive ? 'active' : ''}">${arrow}</span>`;
        }

        // Render SVG value trend graph with dual PSA 9 and PSA 10 lines
        function renderValueTrendGraph(priceHistory, psa10Ratio) {
            // Deduplicate by date - keep last entry per date
            const byDate = {};
            priceHistory.forEach(e => {
                const dateStr = new Date(e.date).toLocaleDateString();
                byDate[dateStr] = e;
            });
            const data = Object.values(byDate);

            if (data.length < 2) return '<div class="text-slate-500 text-sm text-center py-8">Need at least 2 snapshots for trend graph</div>';

            const width = 440;
            const height = 180;
            const pad = { top: 15, right: 90, bottom: 28, left: 50 };
            const chartW = width - pad.left - pad.right;
            const chartH = height - pad.top - pad.bottom;

            // PSA 9 values from history, PSA 10 estimated via ratio
            const psa9Values = data.map(e => e.totalValue || 0);
            const psa10Values = data.map(e => Math.round((e.totalValue || 0) * psa10Ratio));

            const allValues = [...psa9Values, ...psa10Values];
            const minVal = Math.min(...allValues) * 0.9;
            const maxVal = Math.max(...allValues) * 1.1;
            const range = maxVal - minVal || 1;

            function toPoints(values) {
                return values.map((v, i) => {
                    const x = pad.left + (i / (data.length - 1)) * chartW;
                    const y = pad.top + chartH - ((v - minVal) / range) * chartH;
                    return { x, y };
                });
            }

            const psa9Pts = toPoints(psa9Values);
            const psa10Pts = toPoints(psa10Values);

            const psa9Line = psa9Pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
            const psa10Line = psa10Pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');

            // Fill under PSA 9
            const psa9Fill = `${pad.left},${pad.top + chartH} ${psa9Line} ${(pad.left + chartW).toFixed(1)},${pad.top + chartH}`;

            // Y-axis labels
            let yLabels = '';
            for (let i = 0; i <= 4; i++) {
                const val = minVal + range * (i / 4);
                const y = pad.top + chartH - (i / 4) * chartH;
                yLabels += `<text x="${pad.left - 5}" y="${y + 4}" fill="#64748b" font-size="9" text-anchor="end">$${Math.round(val).toLocaleString()}</text>`;
                yLabels += `<line x1="${pad.left}" y1="${y}" x2="${pad.left + chartW}" y2="${y}" stroke="#334155" stroke-width="0.5"/>`;
            }

            // X-axis date labels
            const labelIndices = [0];
            if (data.length > 2) labelIndices.push(Math.floor(data.length / 2));
            labelIndices.push(data.length - 1);
            const dateLabels = labelIndices.map(i => {
                const p = psa9Pts[i];
                return `<text x="${p.x.toFixed(1)}" y="${height - 4}" fill="#64748b" font-size="9" text-anchor="middle">${new Date(data[i].date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</text>`;
            }).join('');

            // Data point circles
            const psa9Circles = psa9Pts.map(p =>
                `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="3" fill="#22c55e" stroke="#0f172a" stroke-width="1"/>`
            ).join('');
            const psa10Circles = psa10Pts.map(p =>
                `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="3" fill="#eab308" stroke="#0f172a" stroke-width="1"/>`
            ).join('');

            // Legend (right side)
            const legendX = pad.left + chartW + 10;
            const legend = `
                <line x1="${legendX}" y1="20" x2="${legendX + 16}" y2="20" stroke="#22c55e" stroke-width="2"/>
                <circle cx="${legendX + 8}" cy="20" r="3" fill="#22c55e"/>
                <text x="${legendX + 22}" y="24" fill="#94a3b8" font-size="9">PSA 9</text>
                <line x1="${legendX}" y1="38" x2="${legendX + 16}" y2="38" stroke="#eab308" stroke-width="2"/>
                <circle cx="${legendX + 8}" cy="38" r="3" fill="#eab308"/>
                <text x="${legendX + 22}" y="42" fill="#94a3b8" font-size="9">PSA 10</text>
            `;

            return `
                <svg viewBox="0 0 ${width} ${height}" class="w-full" style="max-height: 200px;">
                    <defs>
                        <linearGradient id="trendFill9" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#22c55e" stop-opacity="0.2"/>
                            <stop offset="100%" stop-color="#22c55e" stop-opacity="0.02"/>
                        </linearGradient>
                    </defs>
                    ${yLabels}
                    <polygon points="${psa9Fill}" fill="url(#trendFill9)"/>
                    <polyline points="${psa9Line}" fill="none" stroke="#22c55e" stroke-width="2" stroke-linejoin="round"/>
                    <polyline points="${psa10Line}" fill="none" stroke="#eab308" stroke-width="2" stroke-linejoin="round" stroke-dasharray="6,3"/>
                    ${psa9Circles}
                    ${psa10Circles}
                    ${dateLabels}
                    ${legend}
                </svg>
            `;
        }

        function renderDashboard(collection, stats, priceHistory = []) {
            const completion = ((stats.uniqueCards / stats.totalSetCards) * 100).toFixed(1);

            // Get all card data
            const allCardNums = getCardsInCollection(collection);
            let allCards = allCardNums.map(num => getCardData(num, collection)).filter(Boolean);

            // Apply filters
            allCards = filterCards(allCards, dashboardState.filters);

            // Group by subset
            const subsetGroups = {};
            allCards.forEach(item => {
                const subset = item.subset || 'Unknown';
                if (!subsetGroups[subset]) subsetGroups[subset] = [];
                subsetGroups[subset].push(item);
            });

            // Sort within each group
            Object.keys(subsetGroups).forEach(subset => {
                subsetGroups[subset] = sortCards(subsetGroups[subset], dashboardState.sortColumn, dashboardState.sortDirection);
            });

            // Determine ordered subset keys (by first card number in the database)
            const subsetOrder = [];
            const seenSubsets = new Set();
            cardDatabase.forEach(card => {
                if (!seenSubsets.has(card.subset) && subsetGroups[card.subset]) {
                    subsetOrder.push(card.subset);
                    seenSubsets.add(card.subset);
                }
            });
            // Add any remaining subsets not found in the database order
            Object.keys(subsetGroups).forEach(subset => {
                if (!seenSubsets.has(subset)) {
                    subsetOrder.push(subset);
                }
            });

            // Check if any sections are expanded
            const anyExpanded = Object.values(dashboardState.collapsedSections).some(v => !v);
            const allCollapsed = Object.values(dashboardState.collapsedSections).every(v => v);

            // Build table rows with section headers
            let tableRows = '';
            subsetOrder.forEach(subset => {
                const cards = subsetGroups[subset];
                if (!cards || cards.length === 0) return;
                const isCollapsed = dashboardState.collapsedSections[subset] !== false;
                const subsetOwnedCards = cards.reduce((sum, c) => sum + c.totalCount, 0);
                const subsetTotalInSet = cardDatabase.filter(c => c.subset === subset).length;
                const sectionValue = cards.reduce((sum, c) => sum + c.rawValue, 0);

                if (isCollapsed) {
                    // Collapsed: show value in the Value column
                    tableRows += `
                        <tr class="section-header" onclick="toggleSection('${subset.replace(/'/g, "\\'")}')">
                            <td colspan="5" style="background: linear-gradient(90deg, #1e293b, #0f172a); padding: 12px 16px; border-bottom: 2px solid #3b82f6;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 14px; transition: transform 0.2s; display: inline-block; transform: rotate(0deg);">&#9654;</span>
                                    <span style="font-weight: 700; font-size: 14px; color: #93c5fd;">${subset}</span>
                                    <span style="font-size: 12px; color: #64748b; font-weight: 400;">Showing ${cards.length} of ${subsetTotalInSet} cards &middot; ${subsetOwnedCards} total copies</span>
                                </div>
                            </td>
                            <td style="background: linear-gradient(90deg, #0f172a, #0f172a); padding: 12px 16px; border-bottom: 2px solid #3b82f6; font-weight: 700; color: #22c55e; font-size: 14px; text-align: right;">
                                ${sectionValue > 0 ? '$' + sectionValue.toLocaleString() : ''}
                            </td>
                        </tr>
                    `;
                } else {
                    // Expanded: section header with value visible
                    tableRows += `
                        <tr class="section-header" onclick="toggleSection('${subset.replace(/'/g, "\\'")}')">
                            <td colspan="5" style="background: linear-gradient(90deg, #1e293b, #0f172a); padding: 12px 16px; border-bottom: 2px solid #3b82f6;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 14px; transition: transform 0.2s; display: inline-block; transform: rotate(90deg);">&#9654;</span>
                                    <span style="font-weight: 700; font-size: 14px; color: #93c5fd;">${subset}</span>
                                    <span style="font-size: 12px; color: #64748b; font-weight: 400;">Showing ${cards.length} of ${subsetTotalInSet} cards &middot; ${subsetOwnedCards} total copies</span>
                                </div>
                            </td>
                            <td style="background: linear-gradient(90deg, #0f172a, #0f172a); padding: 12px 16px; border-bottom: 2px solid #3b82f6; font-weight: 700; color: #22c55e; font-size: 14px; text-align: right;">
                                ${sectionValue > 0 ? '$' + sectionValue.toLocaleString() : ''}
                            </td>
                        </tr>
                    `;

                    cards.forEach(item => {
                        const valueColor = item.valueTier
                            ? (item.valueTier.length >= 4 ? '#fbbf24' : item.valueTier.length >= 3 ? '#22c55e' : '#94a3b8')
                            : '';
                        tableRows += `
                            <tr class="data-row" onclick="openCardDetail('${item.card.num}')">
                                <td class="font-bold">#${item.card.num}</td>
                                <td>${item.card.name}${item.card.rookie ? ' <span style="color: #fbbf24; font-size: 11px;">RC</span>' : ''}</td>
                                <td class="text-sm text-slate-400">${item.card.team || 'N/A'}</td>
                                <td class="text-sm">${item.variantList}</td>
                                <td class="font-bold text-green-400">${item.totalCount}</td>
                                <td class="font-bold text-sm" style="color: ${valueColor}">${item.valueTier || '<span style="color: #475569;">&mdash;</span>'}</td>
                            </tr>
                        `;
                    });
                }
            });

            const filters = dashboardState.filters;

            // Deduplicate price history by date (keep last entry per date)
            const historyByDate = {};
            priceHistory.forEach(e => {
                const dateStr = new Date(e.date).toLocaleDateString();
                historyByDate[dateStr] = e;
            });
            const uniqueHistory = Object.values(historyByDate).sort((a, b) => new Date(a.date) - new Date(b.date));

            const html = `
                <div class="min-h-screen p-8">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="mb-8">
                            <h1 class="text-4xl font-bold mb-2">F1 Card Collection Dashboard</h1>
                            <p class="text-slate-400 mb-3">View and analyze your 2025 Topps Chrome F1 collection</p>
                            <div class="flex items-center justify-center gap-4 bg-slate-800 border border-slate-700 rounded-lg px-6 py-6 w-full">
                                <span class="text-slate-400 text-lg">Collection Progress:</span>
                                <span class="text-4xl font-bold text-green-400">${stats.uniqueCards}</span>
                                <span class="text-slate-500 text-2xl">/</span>
                                <span class="text-4xl font-bold text-slate-300">${stats.totalSetCards}</span>
                                <span class="text-slate-400 text-lg">cards</span>
                                <span class="text-sm text-slate-500">(${stats.totalCards} total with duplicates)</span>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                <div class="text-slate-400 text-sm mb-2">Total Cards</div>
                                <div class="text-3xl font-bold text-green-400">${stats.totalCards}</div>
                                <div class="text-xs text-slate-500 mt-2">Including duplicates</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                <div class="text-slate-400 text-sm mb-2">Unique Cards</div>
                                <div class="text-3xl font-bold text-blue-400">${stats.uniqueCards}</div>
                                <div class="text-xs text-slate-500 mt-2">Different card types</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                <div class="text-slate-400 text-sm mb-2">Variants Owned</div>
                                <div class="text-3xl font-bold text-yellow-400">${Object.keys(stats.cardsByVariant).length}</div>
                                <div class="text-xs text-slate-500 mt-2">Different variants</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                <div class="text-slate-400 text-sm mb-2">Completion</div>
                                <div class="text-3xl font-bold text-purple-400">${completion}%</div>
                                <div class="text-xs text-slate-500 mt-2">of ${stats.totalSetCards} set</div>
                            </div>
                        </div>

                        <!-- Variant Breakdown -->
                        <div class="bg-slate-800 rounded-lg p-6 border border-slate-700 mb-8">
                            <h2 class="text-xl font-bold mb-4">Variant Breakdown</h2>
                            <div class="text-xs text-slate-500 mb-3">Click a variant to view those cards in the collection.</div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${Object.entries(stats.cardsByVariant)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([variant, count]) => `
                                        <div class="bg-slate-700 rounded p-3 cursor-pointer hover:bg-slate-600 transition-colors" onclick="navigateToVariant('${variant.replace(/'/g, "\\'")}')">
                                            <div class="font-semibold text-sm">${variant}</div>
                                            <div class="text-2xl font-bold text-green-400">${count}</div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>

                        <!-- Valuation History -->
                        <div class="bg-slate-800 rounded-lg p-6 border border-slate-700 mb-8">
                            <h2 class="text-xl font-bold mb-4">Valuation History</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-slate-700 rounded p-4">
                                    <div class="text-slate-400 text-sm mb-3">Current Value</div>
                                    <div class="flex justify-between items-end mb-2">
                                        <div>
                                            <div class="text-xs text-slate-400 mb-1">PSA 9 max estimates</div>
                                            <div class="text-3xl font-bold text-green-400">${stats.currentValue > 0 ? '$' + stats.currentValue.toLocaleString() : 'No data'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-slate-400 mb-1">PSA 10 max estimates</div>
                                            <div class="text-3xl font-bold text-yellow-400">${stats.currentPSA10Value > 0 ? '$' + stats.currentPSA10Value.toLocaleString() : 'No data'}</div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">Sum of max values across all owned cards</div>
                                </div>
                                <div class="bg-slate-700 rounded p-4">
                                    <div class="text-slate-400 text-sm mb-2">Value Trend</div>
                                    ${renderValueTrendGraph(priceHistory, stats.currentValue > 0 ? stats.currentPSA10Value / stats.currentValue : 1.5)}
                                </div>
                            </div>
                            ${uniqueHistory.length > 0 ? (() => {
                                const ratio = stats.currentValue > 0 ? stats.currentPSA10Value / stats.currentValue : 1.5;
                                return `
                                <div class="text-sm text-slate-400 mb-2">
                                    Total Snapshots: ${uniqueHistory.length}
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="text-slate-400 border-b border-slate-600">
                                                <th class="text-left py-2 px-2 font-medium">Date</th>
                                                <th class="text-right py-2 px-2 font-medium" style="color: #22c55e;">PSA 9</th>
                                                <th class="text-right py-2 px-2 font-medium" style="color: #eab308;">PSA 10</th>
                                                <th class="text-right py-2 px-2 font-medium text-slate-400">Cards</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${uniqueHistory.slice(-5).reverse().map(entry => {
                                                const psa9 = entry.totalValue || 0;
                                                const psa10 = Math.round(psa9 * ratio);
                                                return `
                                                    <tr class="border-b border-slate-700/50">
                                                        <td class="py-2 px-2">${new Date(entry.date).toLocaleDateString()}</td>
                                                        <td class="py-2 px-2 text-right font-semibold text-green-400">$${psa9.toLocaleString()}</td>
                                                        <td class="py-2 px-2 text-right font-semibold text-yellow-400">$${psa10.toLocaleString()}</td>
                                                        <td class="py-2 px-2 text-right text-slate-400">${entry.cardCount}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>`;
                            })() : ''}
                        </div>

                        <!-- Collection Table -->
                        <div class="bg-slate-800 rounded-lg p-6 border border-slate-700 mb-8">
                            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                                <h2 class="text-xl font-bold">Your Cards</h2>
                                <div class="flex gap-2">
                                    <button
                                        onclick="expandAllSections()"
                                        class="px-3 py-1.5 rounded text-xs font-semibold transition-all ${anyExpanded && !allCollapsed ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}"
                                    >
                                        Expand All
                                    </button>
                                    <button
                                        onclick="collapseAllSections()"
                                        class="px-3 py-1.5 rounded text-xs font-semibold transition-all ${allCollapsed ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}"
                                    >
                                        Collapse All
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-slate-500 mb-3">Click any row to view card details. Click column headers to sort. Click section headers to expand/collapse.</div>
                            <div class="overflow-x-auto">
                                <table class="card-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortByColumn('num')" style="min-width: 70px;"># ${renderSortArrow('num')}</th>
                                            <th onclick="sortByColumn('name')" style="min-width: 140px;">Driver ${renderSortArrow('name')}</th>
                                            <th onclick="sortByColumn('team')" style="min-width: 120px;">Team ${renderSortArrow('team')}</th>
                                            <th onclick="sortByColumn('variants')" style="min-width: 160px;">Variants ${renderSortArrow('variants')}</th>
                                            <th onclick="sortByColumn('total')" style="min-width: 70px;">Total ${renderSortArrow('total')}</th>
                                            <th onclick="sortByColumn('value')" style="min-width: 70px;">Value ${renderSortArrow('value')}</th>
                                        </tr>
                                        <tr style="background: #0f172a;">
                                            <th style="padding: 4px 8px;">
                                                <input type="text" class="filter-input" placeholder="Filter #" value="${filters.num}" oninput="updateFilter('num', this.value)" onclick="event.stopPropagation()">
                                            </th>
                                            <th style="padding: 4px 8px;">
                                                <input type="text" class="filter-input" placeholder="Filter driver" value="${filters.name}" oninput="updateFilter('name', this.value)" onclick="event.stopPropagation()">
                                            </th>
                                            <th style="padding: 4px 8px;">
                                                <input type="text" class="filter-input" placeholder="Filter team" value="${filters.team}" oninput="updateFilter('team', this.value)" onclick="event.stopPropagation()">
                                            </th>
                                            <th style="padding: 4px 8px;">
                                                <input type="text" class="filter-input" placeholder="Filter variant" value="${filters.variants}" oninput="updateFilter('variants', this.value)" onclick="event.stopPropagation()">
                                            </th>
                                            <th style="padding: 4px 8px;">
                                                <input type="text" class="filter-input" placeholder="Min" value="${filters.total}" oninput="updateFilter('total', this.value)" onclick="event.stopPropagation()">
                                            </th>
                                            <th style="padding: 4px 8px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows || '<tr><td colspan="6" class="text-center text-slate-400 py-8">No cards match the current filters</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Return to Collection Button - 5-sided arrow pointing left -->
                        <div class="fixed right-6 bottom-6 z-40">
                            <a
                                href="index.html"
                                class="group bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-semibold shadow-lg hover:shadow-blue-500/25 hover:shadow-xl flex flex-col items-center justify-center gap-2 transition-all duration-300 hover:scale-105"
                                style="clip-path: polygon(0 50%, 38px 0, 100% 0, 100% 100%, 38px 100%); padding-left: 38px; width: 150px; height: 120px;"
                                title="Return to main collection view"
                            >
                                <span class="text-4xl">ðŸ“‹</span>
                                <span class="text-sm font-medium">Return to<br>Collection</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;

            // Save scroll position before replacing DOM
            const scrollTop = window.scrollY || document.documentElement.scrollTop;

            document.getElementById('root').innerHTML = html;

            // Restore scroll position
            window.scrollTo(0, scrollTop);

            // Restore filter input focus if user was typing
            if (dashboardState._activeFilterColumn) {
                const columns = ['num', 'name', 'team', 'variants', 'total'];
                const idx = columns.indexOf(dashboardState._activeFilterColumn);
                const inputs = document.querySelectorAll('.filter-input');
                if (idx >= 0 && inputs[idx]) {
                    inputs[idx].focus();
                    const pos = dashboardState._cursorPosition;
                    if (pos !== null && pos !== undefined) {
                        try { inputs[idx].setSelectionRange(pos, pos); } catch(e) {}
                    }
                }
                dashboardState._activeFilterColumn = null;
                dashboardState._cursorPosition = null;
            }

            // Set sticky section header top based on thead height
            setTimeout(() => {
                const thead = document.querySelector('.card-table thead');
                if (thead) {
                    const theadHeight = thead.offsetHeight;
                    document.querySelectorAll('.section-header td').forEach(td => {
                        td.style.top = theadHeight + 'px';
                    });
                }
            }, 0);
        }

        loadDashboard();
    </script>
</body>
</html>
