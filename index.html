<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1 Card Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="F1 Card Tracker">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="F1 Tracker">
    <meta name="description" content="Track your 2025 Topps Chrome F1 card collection">
    <meta name="theme-color" content="#0f172a">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%230f172a'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='100' fill='%2360a5fa'>üèéÔ∏è</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèéÔ∏è</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22F1%20Card%20Tracker%22,%22short_name%22:%22F1%20Tracker%22,%22start_url%22:%22./%22,%22display%22:%22standalone%22,%22background_color%22:%22%230f172a%22,%22theme_color%22:%22%230f172a%22,%22orientation%22:%22portrait%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%230f172a'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='120' fill='%2360a5fa'>üèéÔ∏è</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%230f172a'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='320' fill='%2360a5fa'>üèéÔ∏è</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        html { overflow-x: hidden; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow-x: hidden; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
        @media (min-width: 768px) {
            .card-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 767px) {
            .card-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .analysis-text { white-space: pre-wrap; line-height: 1.6; }
        .analysis-text h3 { font-weight: bold; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; color: #93c5fd; }
        .analysis-text ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.5em; }
        .analysis-text li { margin-bottom: 0.25em; }
        .analysis-text strong { color: #60a5fa; font-weight: 600; }
        .needs-verification { background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); position: relative; }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fbbf24; padding: 0.5rem; rounded: 0.5rem; white-space: nowrap; font-size: 0.75rem; display: none; z-index: 1000; border: 1px solid #fbbf24; }
        .needs-verification:hover .tooltip { display: block; }
        :root {
            --page-number-top: 160px;
            --page-divider-top: 176px;
        }
        .page-number {
            position: sticky;
            left: 0;
            top: var(--page-number-top);
            z-index: 20;
            font-size: 4rem;
            font-weight: 900;
            color: #1e293b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            margin-right: 1rem;
            display: none;
            user-select: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .page-number:hover {
            opacity: 0.7;
        }
        @media (min-width: 768px) {
            .page-number {
                display: flex;
                align-items: flex-start;
            }
        }
        .page-divider {
            position: sticky;
            top: var(--page-divider-top);
            z-index: 20;
        }
        .page-container {
            position: relative;
            padding-left: 0;
        }
        .page-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #cbd5e1;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid #334155;
            transition: background 0.15s;
        }
        .page-menu-item:hover {
            background: #334155 !important;
        }
        .hamburger:hover { color: #60a5fa; transition: color 0.2s; }
        .dropdown-menu { position: absolute; top: 60px; left: 16px; background: #1e293b; border: 1px solid #475569; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 1000; min-width: 160px; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; color: #fff; border-bottom: 1px solid #475569; transition: background 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #334155; }
        .dropdown-item-delete { padding: 8px 12px; cursor: pointer; color: #fca5a5; border: 2px solid #dc2626; border-radius: 6px; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem; margin: 16px 8px 0 8px; width: calc(100% - 16px); }
        .dropdown-item-delete:hover { background: #7f1d1d; color: #fecaca; }
        
        /* Mobile-friendly touch targets */
        @media (max-width: 767px) {
            button, a { min-height: 44px; min-width: 44px; }
            button:active, a:active { transform: scale(0.98); }
            input, select, textarea { min-height: 44px; font-size: 16px; }
        }
        
        /* Prevent zoom on input focus */
        @media (max-width: 767px) {
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px;
            }
        }
        
        /* Safe area inset for notch devices */
        @media (max-width: 767px) {
            .fixed { padding-left: max(0.5rem, env(safe-area-inset-left)); padding-right: max(0.5rem, env(safe-area-inset-right)); }
            .sticky { padding-left: max(0.5rem, env(safe-area-inset-left)); padding-right: max(0.5rem, env(safe-area-inset-right)); }
        }
        
        /* Smooth momentum scrolling on mobile */
        @media (max-width: 767px) {
            * { -webkit-tap-highlight-color: transparent; }
            body, html { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
            input, textarea, select, button { -webkit-user-select: text; user-select: text; }
            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            
            /* Checkered pattern badge styles */
            .checker-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                border-radius: 9999px;
                font-weight: bold;
                box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
            }
            
            .checker-badge svg {
                width: 100%;
                height: 100%;
                border-radius: 9999px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script src="card-database.js"></script>
    <script src="chatbot-component.js"></script>
    
    <script>
    // Authentication check
    const token = localStorage.getItem('f1-token');
    if (!token) {
      window.location.href = 'login.html';
    }
    
    const userEmail = localStorage.getItem('f1-email') || 'User';

    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE = "https://f1-card-tracker-backend-1.onrender.com";
        const API_URL = API_BASE + "/api/recognize";
        const cardData = COMPLETE_CARD_DATABASE || [];

        // Helper to add auth header to all requests
        function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
        }

        const OFFICIAL_VARIANTS = [
            // Base & Standard Refractors
            'Base',
            'Refractor',
            
            // Numbered Color Refractors
            'Teal Refractor /299',
            'Pink Refractor /250',
            'Aqua Refractor /199',
            'Blue Refractor /150',
            'Green Refractor /99',
            'F1 75th Anniversary Refractor /75',
            'Gold Refractor /50',
            'Orange Refractor /25',
            'Black Refractor /10',
            'Red Refractor /5',
            
            // Checker Flag Parallels (Hobby exclusive)
            'Checker Flag',
            'Pink Checker Flag /250',
            'Aqua Checker Flag /199',
            'Blue Checker Flag /150',
            'Green Checker Flag /99',
            'Gold Checker Flag /50',
            'Orange Checker Flag /25',
            'Black Checker Flag /10',
            'Red Checker Flag /5',
            
            // RayWave Parallels (Blaster exclusive)
            'B&W RayWave',
            'Pink RayWave /250',
            'Aqua RayWave /199',
            'Blue RayWave /150',
            'Forest Green RayWave /140',
            'Green RayWave /99',
            'Gold RayWave /50',
            'Orange RayWave /25',
            'Black RayWave /10',
            'Red RayWave /5',
            
            // Lazer (Hobby exclusive)
            'B&W Lazer',
            
            // Ultra Rare
            'SuperFractor 1/1',
            
            // Special Types
            'Logofractor',
            'Sapphire Edition',
            'Padparadscha Sapphire 1/1',
            
            // Printing Plates
            'Printing Plate Cyan 1/1',
            'Printing Plate Magenta 1/1',
            'Printing Plate Yellow 1/1',
            'Printing Plate Black 1/1'
        ];

        const variants = OFFICIAL_VARIANTS;

        // Helper function to format Quick Grade Report with app-matching style and responsive design
        const formatQuickGradeReport = (gradeText) => {
            if (!gradeText) {
                console.log('QGA: No grade text provided');
                return <div className="text-slate-400">No assessment available</div>;
            }
            
            console.log('QGA: Formatting grade report, text length:', gradeText.length);
            console.log('QGA: First 200 chars:', gradeText.substring(0, 200));
            
            // Define all possible section headers
            const sectionHeaders = [
                'FINAL ASSESSMENT',
                'GRADE PROBABILITY',
                'CONDITION CHECKLIST',
                'DETAILED ANALYSIS',
                'NOTES',
                'GRADE PROBABILITY ESTIMATE',
                'SUMMARY ASSESSMENT',
                'VISUAL CHECKLIST',
                'DETAILED FINDINGS'
            ];
            
            const sections = {};
            let currentSection = '';
            const lines = gradeText.split('\n');
            
            console.log('QGA: Total lines:', lines.length);
            
            // Parse sections - capture ALL content
            lines.forEach((line, idx) => {
                const upperLine = line.toUpperCase().trim();
                
                // Check if this line is a section header
                let foundHeader = false;
                for (let header of sectionHeaders) {
                    if (upperLine.startsWith(header)) {
                        currentSection = header;
                        sections[currentSection] = [];
                        console.log('QGA: Found section header at line', idx, ':', header);
                        foundHeader = true;
                        break;
                    }
                }
                
                if (!foundHeader && currentSection && line.trim()) {
                    // Skip separator lines and clean up symbols
                    if (line.trim() !== '===================================================' && 
                        line.trim() !== '---' && 
                        line.trim() !== '====' &&
                        !line.trim().startsWith('=')) {
                        // Clean line by removing # and * symbols at start
                        let cleanLine = line.trim().replace(/^[#*\s]+/, '');
                        if (cleanLine) {
                            sections[currentSection].push(cleanLine);
                        }
                    }
                }
            });
            
            console.log('QGA: Sections found:', Object.keys(sections));
            
            // Fallback: if no sections found, treat entire text as content
            if (Object.keys(sections).length === 0) {
                console.log('QGA: No sections found, using full text as fallback');
                return (
                    <div className="text-sm space-y-2 text-slate-300 break-words leading-relaxed">
                        {lines.filter(l => l.trim()).map((line, idx) => {
                            // Clean symbols from fallback lines too
                            const cleanLine = line.trim().replace(/^[#*\s]+/, '');
                            return cleanLine ? <div key={idx}>{cleanLine}</div> : null;
                        }).filter(Boolean)}
                    </div>
                );
            }
            
            // Reorder sections: FINAL ASSESSMENT first, then others in priority
            const prioritySections = ['FINAL ASSESSMENT', 'GRADE PROBABILITY', 'CONDITION CHECKLIST', 'DETAILED ANALYSIS', 'NOTES'];
            const orderedSections = [];
            
            // Add priority sections first in order
            prioritySections.forEach(key => {
                if (sections[key] && sections[key].length > 0) {
                    orderedSections.push({ key, content: sections[key] });
                    delete sections[key];
                }
            });
            
            // Add remaining sections
            Object.keys(sections).forEach(key => {
                if (sections[key] && sections[key].length > 0) {
                    orderedSections.push({ key, content: sections[key] });
                }
            });
            
            console.log('QGA: Ordered sections:', orderedSections.length, 'sections');
            
            // Helper function to extract and left-align emojis
            const formatLineWithEmojis = (line) => {
                // Extract emojis from start of line
                const emojiMatch = line.match(/^([\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+)/u);
                if (emojiMatch) {
                    const emoji = emojiMatch[1];
                    const restOfLine = line.substring(emoji.length).trim();
                    return { emoji, text: restOfLine };
                }
                return { emoji: null, text: line };
            };
            
            // Format as JSX with improved styling
            return (
                <div className="space-y-4 text-slate-300 text-sm">
                    {orderedSections.map((section, idx) => (
                        <div key={idx} className="space-y-2">
                            {/* Section header - clean and modern */}
                            <div className="text-sm font-semibold text-blue-400 border-l-2 border-blue-400 pl-2 bg-blue-950/30 py-1 rounded-r">
                                {section.key}
                            </div>
                            
                            {/* Section content with improved formatting */}
                            <div className="space-y-1.5 ml-2">
                                {section.content.length === 0 ? (
                                    <div className="text-slate-500 italic text-xs">No content</div>
                                ) : (
                                    section.content.map((line, lineIdx) => {
                                        // Format line with emoji separation
                                        const { emoji, text } = formatLineWithEmojis(line);
                                        
                                        // Handle checklist items: "Centering: PASS/FAIL"
                                        const checklistMatch = text.match(/^([A-Za-z\s\/&]+?):\s*(PASS|FAIL|Yes|No)/i);
                                        if (checklistMatch) {
                                            const checkItem = checklistMatch[1].trim();
                                            const status = checklistMatch[2].toUpperCase();
                                            const isPass = status === 'PASS' || status === 'YES';
                                            const remainingText = text.substring(text.indexOf(':') + 1).trim();
                                            
                                            return (
                                                <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                    {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                    <div className="flex gap-2 items-baseline flex-wrap flex-1">
                                                        <span className="font-semibold text-slate-300 flex-shrink-0">{checkItem}:</span>
                                                        <span className={`font-semibold flex-shrink-0 ${isPass ? 'text-green-400' : 'text-red-400'}`}>
                                                            {status}
                                                        </span>
                                                        {remainingText && remainingText !== status && (
                                                            <span className="text-slate-400 flex-grow">{remainingText.replace(status, '').trim()}</span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        }
                                        
                                        // Handle PSA percentage lines: "PSA 10: 85%"
                                        const psaMatch = text.match(/^PSA\s+(\d+):\s*([\d.]+%)/i);
                                        if (psaMatch) {
                                            const grade = psaMatch[1];
                                            const percentage = psaMatch[2];
                                            const remainingText = text.substring(text.indexOf(':') + 1).trim();
                                            
                                            return (
                                                <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                    {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                    <div className="flex gap-2 items-baseline flex-wrap flex-1">
                                                        <span className="font-semibold text-slate-300 flex-shrink-0">PSA {grade}:</span>
                                                        <span className="text-yellow-300 font-semibold flex-shrink-0">{percentage}</span>
                                                        {remainingText && remainingText !== percentage && (
                                                            <span className="text-slate-400 flex-grow">{remainingText.replace(percentage, '').trim()}</span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        }
                                        
                                        // Handle "Estimated PSA Grade: X with Y% confidence"
                                        if (text.toLowerCase().includes('estimated psa grade') || 
                                            text.toLowerCase().includes('recommended for grading')) {
                                            const colonIdx = text.indexOf(':');
                                            if (colonIdx > -1) {
                                                const label = text.substring(0, colonIdx).trim();
                                                const value = text.substring(colonIdx + 1).trim();
                                                return (
                                                    <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                        {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                        <div className="flex gap-2 items-baseline flex-wrap flex-1">
                                                            <span className="font-semibold text-slate-300">{label}:</span>
                                                            <span className="text-blue-300 font-semibold">{value}</span>
                                                        </div>
                                                    </div>
                                                );
                                            }
                                        }
                                        
                                        // Handle key-value pairs with colons
                                        const kvMatch = text.match(/^([^:]+?):\s*(.+)$/);
                                        if (kvMatch) {
                                            const label = kvMatch[1].trim();
                                            const value = kvMatch[2].trim();
                                            
                                            return (
                                                <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                    {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                    <div className="space-y-0.5 flex-1">
                                                        <div className="font-semibold text-slate-300">{label}</div>
                                                        <div className="text-slate-400 ml-2 leading-relaxed break-words">{value}</div>
                                                    </div>
                                                </div>
                                            );
                                        }
                                        
                                        // Handle bracketed text [...]
                                        if (text.startsWith('[') && text.endsWith(']')) {
                                            const content = text.slice(1, -1).trim();
                                            return (
                                                <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                    {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                    <div className="text-slate-400 italic break-words flex-1">
                                                        {content}
                                                    </div>
                                                </div>
                                            );
                                        }
                                        
                                        // Regular text lines with emoji separation
                                        return (
                                            <div key={lineIdx} className="flex items-start gap-2 text-sm">
                                                {emoji && <span className="flex-shrink-0">{emoji}</span>}
                                                <div className="text-slate-300 leading-relaxed break-words flex-1">
                                                    {text}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };
        const renderCheckerBadge = (style, text) => {
            const color1 = style.color1 || '#475569';
            const color2 = style.color2 || '#1e293b';
            const patternId = `cross-hatch-${text}`;
            
            return (
                <svg className="checker-badge" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        {/* Cross-hatch pattern with diagonal lines */}
                        <pattern id={patternId} x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse">
                            {/* Background color */}
                            <rect width="8" height="8" fill={color1} />
                            {/* Diagonal lines for cross-hatch effect */}
                            <line x1="0" y1="0" x2="8" y2="8" stroke={color2} strokeWidth="2" />
                            <line x1="8" y1="0" x2="0" y2="8" stroke={color2} strokeWidth="2" />
                        </pattern>
                    </defs>
                    {/* Background with pattern */}
                    <rect width="100" height="100" fill={`url(#${patternId})`} />
                    {/* Text overlay */}
                    <text x="50" y="55" textAnchor="middle" dominantBaseline="middle" 
                        fontSize="28" fontWeight="bold" fill="white" 
                        style={{ textShadow: '0 2px 4px rgba(0,0,0,0.5)', stroke: 'rgba(0,0,0,0.3)', strokeWidth: '0.5' }}>
                        {text}
                    </text>
                </svg>
            );
        };
        const inferVariantFromSerial = (serialNumber) => {
            if (!serialNumber) return null;
            
            // Extract just the number from formats like "/140" or "140"
            const match = serialNumber.toString().match(/(\d+)/);
            if (!match) return null;
            const serialNum = match[1];
            
            // Map serial numbers to possible variants (in order of preference for ambiguous cases)
            const serialVariantMap = {
                '299': ['Teal Refractor /299'],
                '250': ['Pink RayWave /250', 'Pink Refractor /250', 'Pink Checker Flag /250'],
                '199': ['Aqua RayWave /199', 'Aqua Refractor /199', 'Aqua Checker Flag /199'],
                '150': ['Blue RayWave /150', 'Blue Refractor /150', 'Blue Checker Flag /150'],
                '140': ['Forest Green RayWave /140'],  // Unique to this serial!
                '99': ['Green RayWave /99', 'Green Refractor /99', 'Green Checker Flag /99'],
                '75': ['F1 75th Anniversary Refractor /75'],
                '50': ['Gold RayWave /50', 'Gold Refractor /50', 'Gold Checker Flag /50'],
                '25': ['Orange RayWave /25', 'Orange Refractor /25', 'Orange Checker Flag /25'],
                '10': ['Black RayWave /10', 'Black Refractor /10', 'Black Checker Flag /10'],
                '5': ['Red RayWave /5', 'Red Refractor /5', 'Red Checker Flag /5']
            };
            
            return serialVariantMap[serialNum] || null;
        };

        // Helper function to validate or correct variant based on serial number
        const validateVariantWithSerial = (extractedVariant, serialNumber) => {
            const possibleVariants = inferVariantFromSerial(serialNumber);
            
            if (!possibleVariants) return extractedVariant; // No mapping available
            
            // If extracted variant is in the list of valid variants for this serial, use it
            if (possibleVariants.includes(extractedVariant)) {
                return extractedVariant;
            }
            
            // Otherwise, use the first (most probable) variant for this serial
            return possibleVariants[0];
        };

        const allSubsets = [...new Set(cardData.map(c => c.subset))].sort();
        const allCardNumbers = cardData.map(c => c.num);

        // Variant color/label mapping
        const variantStyles = {
            "Base": { bg: "bg-slate-500", text: "B", color: "#64748b" },
            "Refractor": { bg: "bg-gradient-to-r from-purple-400 to-pink-400", text: "R", color: "linear-gradient(to right, #c084fc, #f0abfc)" },
            "Purple Refractor /299": { bg: "bg-purple-500", text: "PU", color: "#a855f7" },
            "Blue Refractor /150": { bg: "bg-blue-500", text: "BL", color: "#3b82f6" },
            "Green Refractor /99": { bg: "bg-green-500", text: "GR", color: "#22c55e" },
            "Gold Refractor /50": { bg: "bg-yellow-500", text: "GO", color: "#eab308" },
            "Orange Refractor /25": { bg: "bg-orange-500", text: "OR", color: "#f97316" },
            "Red Refractor /5": { bg: "bg-red-500", text: "RD", color: "#ef4444" },
            "SuperFractor 1/1": { bg: "bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500", text: "SF", color: "#ec4899" },
            "Printing Plate 1/1": { bg: "bg-slate-700", text: "PP", color: "#334155" },
            "Black Refractor /10": { bg: "bg-black", text: "BK", color: "#000000" },
            "Magenta/Pink Refractor /250": { bg: "bg-pink-500", text: "PK", color: "#ec4899" },
            "Gold Wave /75": { bg: "bg-yellow-600", text: "GW", color: "#ca8a04" },
            
            // Checker Flag variants with cross-hatch patterns
            "Checker Flag": { bg: "bg-gradient-to-br from-slate-600 to-slate-800", text: "CF", svg: true, color1: "#475569", color2: "#1e293b" },
            "Pink Checker Flag /250": { bg: "bg-gradient-to-br from-pink-600 to-pink-800", text: "PC", svg: true, color1: "#ec4899", color2: "#831843" },
            "Aqua Checker Flag /199": { bg: "bg-gradient-to-br from-cyan-600 to-cyan-800", text: "AC", svg: true, color1: "#06b6d4", color2: "#164e63" },
            "Blue Checker Flag /150": { bg: "bg-gradient-to-br from-blue-600 to-blue-800", text: "BC", svg: true, color1: "#2563eb", color2: "#1e3a8a" },
            "Green Checker Flag /99": { bg: "bg-gradient-to-br from-green-600 to-green-800", text: "GC", svg: true, color1: "#16a34a", color2: "#15803d" },
            "Gold Checker Flag /50": { bg: "bg-gradient-to-br from-yellow-600 to-yellow-800", text: "GD", svg: true, color1: "#ca8a04", color2: "#713f12" },
            "Orange Checker Flag /25": { bg: "bg-gradient-to-br from-orange-600 to-orange-800", text: "OC", svg: true, color1: "#ea580c", color2: "#7c2d12" },
            "Black Checker Flag /10": { bg: "bg-gradient-to-br from-gray-700 to-gray-900", text: "BK", svg: true, color1: "#374151", color2: "#111827" },
            "Red Checker Flag /5": { bg: "bg-gradient-to-br from-red-600 to-red-800", text: "RC", svg: true, color1: "#dc2626", color2: "#7f1d1d" },
            
            // Teal and other numbered refractors
            "Teal Refractor /299": { bg: "bg-teal-500", text: "TE", color: "#14b8a6" },
            "Pink Refractor /250": { bg: "bg-pink-500", text: "PK", color: "#ec4899" },
            "Aqua Refractor /199": { bg: "bg-cyan-500", text: "AQ", color: "#06b6d4" },
            
            // Lazer
            "B&W Lazer": { bg: "bg-gradient-to-r from-white to-gray-800", text: "LZ", color: "#ffffff" },
            
            // RayWave
            "B&W RayWave": { bg: "bg-gradient-to-r from-gray-400 to-gray-800", text: "RW", color: "#9ca3af" },
            "Pink RayWave /250": { bg: "bg-pink-600", text: "RW", color: "#be185d" },
            "Aqua RayWave /199": { bg: "bg-cyan-600", text: "RW", color: "#0891b2" },
            "Blue RayWave /150": { bg: "bg-blue-600", text: "RW", color: "#1d4ed8" },
            "Forest Green RayWave /140": { bg: "bg-emerald-700", text: "RW", color: "#046857" },
            "Green RayWave /99": { bg: "bg-green-600", text: "RW", color: "#15803d" },
            "Gold RayWave /50": { bg: "bg-yellow-600", text: "RW", color: "#ca8a04" },
            "Orange RayWave /25": { bg: "bg-orange-600", text: "RW", color: "#9a3412" },
            "Black RayWave /10": { bg: "bg-black", text: "RW", color: "#000000" },
            "Red RayWave /5": { bg: "bg-red-600", text: "RW", color: "#991b1b" },
            
            // Special editions
            "F1 75th Anniversary Refractor /75": { bg: "bg-gradient-to-r from-gold-400 to-purple-500", text: "F1", color: "#fbbf24" },
            "Logofractor": { bg: "bg-gradient-to-r from-blue-500 to-cyan-500", text: "LF", color: "#06b6d4" },
            "Sapphire Edition": { bg: "bg-blue-600", text: "SA", color: "#1d4ed8" },
            "Padparadscha Sapphire 1/1": { bg: "bg-gradient-to-r from-orange-400 to-pink-400", text: "PS", color: "#fb7185" },
            
            // Printing plates
            "Printing Plate Cyan 1/1": { bg: "bg-cyan-500", text: "C", color: "#06b6d4" },
            "Printing Plate Magenta 1/1": { bg: "bg-fuchsia-500", text: "M", color: "#d946ef" },
            "Printing Plate Yellow 1/1": { bg: "bg-yellow-400", text: "Y", color: "#facc15" },
            "Printing Plate Black 1/1": { bg: "bg-slate-900", text: "K", color: "#0f172a" }
        };

        function App() {
            const [collection, setCollection] = useState({});
            const [selectedCard, setSelectedCard] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [filterSubset, setFilterSubset] = useState("all");
            const [filterRookie, setFilterRookie] = useState("all");
            const [filterVariants, setFilterVariants] = useState([]); // Multi-select variant filter
            const [filterValues, setFilterValues] = useState([]); // Multi-select value filter
            const [showOwnedOnly, setShowOwnedOnly] = useState(false);  // Toggle to show only owned cards
            const [showImageUpload, setShowImageUpload] = useState(false);
            const [showMenuDropdown, setShowMenuDropdown] = useState(false);
            const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);  // Mobile filters dropdown
            const [uploadedImages, setUploadedImages] = useState([]);
            const [pendingImages, setPendingImages] = useState([]);  // Images waiting for confirmation
            const [showSecondImagePrompt, setShowSecondImagePrompt] = useState(false);  // Show prompt for second image
            const [recognizedCard, setRecognizedCard] = useState(null);
            const [isRecognizing, setIsRecognizing] = useState(false);
            const [recognitionError, setRecognitionError] = useState(null);
            const [serverOnline, setServerOnline] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editedCard, setEditedCard] = useState(null);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showExportBeforeDelete, setShowExportBeforeDelete] = useState(false);
            const [analyzingCards, setAnalyzingCards] = useState({});
            const [deepAnalysis, setDeepAnalysis] = useState(null);
            const [isDeepAnalyzing, setIsDeepAnalyzing] = useState(false);
            const [selectedAnalysisSource, setSelectedAnalysisSource] = useState('opus'); // 'sonnet' or 'opus'
            const [showImageViewer, setShowImageViewer] = useState(false);
            const [imageViewerZoom, setImageViewerZoom] = useState(1);
            const [imageViewerPosition, setImageViewerPosition] = useState({ x: 0, y: 0 });
            const [currentImageIndex, setCurrentImageIndex] = useState(0);  // Track current image being viewed
            const [imageViewerTouchStart, setImageViewerTouchStart] = useState({ x: 0, y: 0, distance: 0 });  // Track touch gestures
            const [manualCardNumber, setManualCardNumber] = useState(null);
            const [cardDetailEdit, setCardDetailEdit] = useState(null);
            const [originalCardDetail, setOriginalCardDetail] = useState(null);
            const [variantValidationModal, setVariantValidationModal] = useState(null);  // {cardNum, aiVariant, suggestedVariant}
            const [pendingCardToAdd, setPendingCardToAdd] = useState(null);  // {cardNum, variant, analysis}
            const [addCardCooldown, setAddCardCooldown] = useState(0);  // Rate limiting for adding cards
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);  // Mobile detection state
            const [showAddCardManual, setShowAddCardManual] = useState(false);  // Manual card addition modal
            const [manualCardData, setManualCardData] = useState({ cardNumber: '', variant: 'Base', serialNumber: '', cardTitle: '', driverName: '', value: '' });  // Card data being entered
            const [loadingCardDetails, setLoadingCardDetails] = useState(false);  // Loading state for card details
            const [collapsedSections, setCollapsedSections] = useState({});  // Track which sections are collapsed

            // Initialize universal chatbot with context provider
            useEffect(() => {
                window.initializeChatbot(() => {
                    let contextInfo = "You are an AI assistant integrated into an F1 card collection tracking application. ";
                    
                    // Add current card context if available
                    if (selectedCard) {
                        const cardKey = getCardKey(selectedCard.num);
                        const cardData = collection[cardKey] || {};
                        const totalCount = Object.keys(cardData).filter(k => !k.startsWith('_')).reduce((sum, v) => sum + (cardData[v] || 0), 0);
                        
                        contextInfo += `The user is currently viewing Card #${selectedCard.num} - ${selectedCard.name}`;
                        if (selectedCard.team) contextInfo += ` (${selectedCard.team})`;
                        contextInfo += `. This card is from the ${selectedCard.subset || 'Unknown'} subset.`;
                        
                        if (totalCount > 0) {
                            contextInfo += ` The user owns ${totalCount} cop${totalCount === 1 ? 'y' : 'ies'} of this card`;
                            const variants = Object.keys(cardData).filter(k => !k.startsWith('_') && cardData[k] > 0);
                            if (variants.length > 0) {
                                contextInfo += ` in these variants: ${variants.map(v => `${v} (${cardData[v]})`).join(', ')}`;
                            }
                            contextInfo += `.`;
                        } else {
                            contextInfo += ` The user does not currently own this card.`;
                        }

                        if (selectedCard.rookie) {
                            contextInfo += ` This is a rookie card.`;
                        }
                    }

                    // Add collection context
                    const totalCards = Object.keys(collection).filter(k => !k.startsWith('_')).length;
                    const totalCopies = Object.keys(collection).reduce((total, cardKey) => {
                        if (cardKey.startsWith('_')) return total;
                        const variants = collection[cardKey];
                        return total + Object.keys(variants).filter(k => !k.startsWith('_')).reduce((sum, v) => sum + (variants[v] || 0), 0);
                    }, 0);
                    
                    contextInfo += ` The user's collection contains ${totalCards} unique cards and ${totalCopies} total cards from the 2025 Topps Chrome F1 set.`;

                    // Add interface context
                    if (showImageUpload) {
                        contextInfo += ` The user currently has the AI Scanner open.`;
                    }
                    
                    contextInfo += ` Be helpful and knowledgeable about F1 cards, collecting, grading, and card values. Keep responses concise and relevant.`;
                    
                    return contextInfo;
                });
            }, [selectedCard, collection, showImageUpload]);

            // Check for card to open from dashboard
            useEffect(() => {
                const openCardData = localStorage.getItem('openCardOnLoad');
                if (openCardData) {
                    try {
                        const { cardNum, card, timestamp } = JSON.parse(openCardData);
                        // Only auto-open if timestamp is recent (within 5 seconds)
                        if (Date.now() - timestamp < 5000) {
                            const cardFromDatabase = cardData.find(c => c.num === cardNum);
                            if (cardFromDatabase) {
                                setSelectedCard(cardFromDatabase);
                            }
                        }
                        // Clear the localStorage item
                        localStorage.removeItem('openCardOnLoad');
                    } catch (error) {
                        console.error('Error parsing openCardOnLoad data:', error);
                        localStorage.removeItem('openCardOnLoad');
                    }
                }
            }, [cardData]);

            // Detect mobile device
            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth < 768);
                };
                
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            
            // Fuzzy string matching - returns similarity score 0-1
            const fuzzyMatch = (str1, str2) => {
                const s1 = str1.toLowerCase();
                const s2 = str2.toLowerCase();
                
                // Exact match
                if (s1 === s2) return 1.0;
                
                // Check if one contains the other
                if (s1.includes(s2) || s2.includes(s1)) return 0.9;
                
                // Levenshtein distance based similarity
                const longer = s1.length > s2.length ? s1 : s2;
                const shorter = s1.length > s2.length ? s2 : s1;
                
                if (longer.length === 0) return 1.0;
                
                const editDistance = getEditDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            };

            // Calculate Levenshtein distance
            const getEditDistance = (s1, s2) => {
                const costs = [];
                for (let i = 0; i <= s1.length; i++) {
                    let lastValue = i;
                    for (let j = 0; j <= s2.length; j++) {
                        if (i === 0) {
                            costs[j] = j;
                        } else if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                    if (i > 0) costs[s2.length] = lastValue;
                }
                return costs[s2.length];
            };

            // Find best matching variant or return null if no good match
            const findBestVariantMatch = (aiVariant) => {
                let bestMatch = null;
                let bestScore = 0;
                
                OFFICIAL_VARIANTS.forEach(official => {
                    const score = fuzzyMatch(aiVariant, official);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = official;
                    }
                });
                
                // Only return match if score is above 0.6 (60% similarity)
                return bestScore >= 0.6 ? bestMatch : null;
            };
            const importInputRef = useRef(null);
            const fileInputRef = useRef(null);
            const menuRef = useRef(null);

            useEffect(() => {
                loadCollection();
                checkServer();
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            function handleClickOutside(event) {
                if (menuRef.current && !menuRef.current.contains(event.target)) {
                    setShowMenuDropdown(false);
                }
            }

            useEffect(() => {
                // Calculate header height and set page label position
                const updatePageLabelPosition = () => {
                    const header = document.querySelector('.sticky.top-0.z-30');
                    if (header) {
                        const headerHeight = header.offsetHeight;
                        // Add 20px buffer below header
                        const pageNumberTop = headerHeight + 20;
                        const pageDividerTop = pageNumberTop + 16; // Additional spacing for divider
                        document.documentElement.style.setProperty('--page-number-top', `${pageNumberTop}px`);
                        document.documentElement.style.setProperty('--page-divider-top', `${pageDividerTop}px`);
                    }
                };

                // Initial calculation
                updatePageLabelPosition();

                // Recalculate on window resize
                window.addEventListener('resize', updatePageLabelPosition);
                
                // Small delay to ensure DOM is fully rendered
                setTimeout(updatePageLabelPosition, 100);

                return () => window.removeEventListener('resize', updatePageLabelPosition);
            }, [serverOnline]); // Recalculate when server status changes (affects header height)

            const checkServer = async () => {
                try {
                    const response = await fetch('https://f1-card-tracker-backend-1.onrender.com/api/test');
                    const data = await response.json();
                    setServerOnline(data.status === 'ok' && data.apiKeySet);
                } catch (error) {
                    setServerOnline(false);
                }
            };

            const [userId, setUserId] = useState(null);

            const loadCollection = async () => {
            try {
                // Load from localStorage FIRST (instant display)
                const saved = localStorage.getItem('f1-collection-pro-v2');
                if (saved) {
                    try {
                        setCollection(JSON.parse(saved));
                        console.log('‚úÖ Collection loaded from localStorage (instant)');
                    } catch (e) {
                        console.error('Error parsing localStorage:', e);
                        setCollection({});
                    }
                }

                // Set user ID
                let id = 'cincymed-f1-collection';
                localStorage.setItem('cincymed-f1-user-id', id);
                setUserId(id);

                // Sync from MongoDB in background (5 second timeout)
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(`https://f1-card-tracker-backend-1.onrender.com/api/collection/${id}`, {
                        method: 'GET',
                        headers: getAuthHeaders(),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                    if (data.cards && Object.keys(data.cards).length > 0) {
                        setCollection(data.cards);
                        // Also save to localStorage as backup
                        localStorage.setItem('f1-collection-pro-v2', JSON.stringify(data.cards));
                        console.log('‚úÖ Collection synced from MongoDB');
                    }
                } catch (error) {
                    console.log('MongoDB sync skipped (using localStorage):', error.message);
                }
            } catch (error) {
                console.error('Error loading collection:', error);
                setCollection({});
            }
            };

            const cleanupCollection = (coll) => {
                console.log('üßπ cleanupCollection input:', Object.keys(coll).length, 'keys');
                const cleaned = { ...coll };
                
                Object.keys(cleaned).forEach(cardKey => {
                    if (cardKey.startsWith('_')) return; // Skip metadata
                    
                    const cardData = cleaned[cardKey];
                    
                    // Remove variants with 0 or negative count
                    Object.keys(cardData).forEach(variant => {
                        if (variant.startsWith('_')) return; // Skip metadata like _analyses
                        
                        if (cardData[variant] <= 0) {
                            console.log(`Removing ${cardKey} ${variant} (count was ${cardData[variant]})`);
                            delete cardData[variant];
                        }
                    });
                    
                    // If card has no valid variants left (only metadata), remove the card entry
                    const hasVariants = Object.keys(cardData).some(key => !key.startsWith('_') && cardData[key] > 0);
                    if (!hasVariants) {
                        console.log(`Removing empty card entry: ${cardKey}`);
                        delete cleaned[cardKey];
                    }
                });
                
                console.log('üßπ cleanupCollection output:', Object.keys(cleaned).length, 'keys');
                if (Object.keys(cleaned).length === 0) {
                    console.error('‚ö†Ô∏è WARNING: cleanupCollection returned empty collection!');
                }
                return cleaned;
            };

            const saveCollection = (newCollection) => {
                try {
                    const cardCountBefore = Object.keys(newCollection).filter(k => k.startsWith('card-')).length;
                    console.log('üíæ saveCollection called with:', cardCountBefore, 'cards');
                    
                    const cleanedCollection = cleanupCollection(newCollection);
                    const cardCountAfter = Object.keys(cleanedCollection).filter(k => k.startsWith('card-')).length;
                    
                    // Count total copies across all variants
                    let totalCopies = 0;
                    Object.keys(cleanedCollection).forEach(key => {
                        if (key.startsWith('card-')) {
                            const card = cleanedCollection[key];
                            Object.keys(card).forEach(variant => {
                                if (!variant.startsWith('_') && card[variant] > 0) {
                                    totalCopies += card[variant];
                                }
                            });
                        }
                    });
                    
                    console.log('üßπ After cleanup:', cardCountAfter, 'cards');
                    console.log('üìä Total copies:', totalCopies);
                    console.log('‚ö†Ô∏è CARDS LOST IN CLEANUP:', cardCountBefore - cardCountAfter);
                    
                    setCollection(cleanedCollection);
                    console.log('üîÑ setCollection called');
                    
                    // Save to localStorage (backup)
                    const jsonStr = JSON.stringify(cleanedCollection);
                    localStorage.setItem('f1-collection-pro-v2', jsonStr);
                    console.log('‚úÖ Saved to localStorage:', jsonStr.length, 'bytes');
                    
                    // Save to MongoDB (async, don't wait)
                    const id = 'cincymed-f1-collection'; // Always use this ID
                    const authHeaders = getAuthHeaders();
                    
                    fetch(`https://f1-card-tracker-backend-1.onrender.com/api/collection/${id}`, {
                        method: 'POST',
                        headers: authHeaders,
                        body: JSON.stringify({ cards: cleanedCollection })
                    }).then(response => {
                        if (response.ok) {
                            console.log('‚úÖ Collection synced to MongoDB');
                        } else {
                            console.error('MongoDB sync failed - status:', response.status);
                        }
                    }).catch(error => {
                        console.error('MongoDB sync error:', error.message);
                    });
                    
                } catch (error) {
                    console.error('Error saving collection:', error);
                    alert('‚ùå Error saving collection:\n' + error.message);
                }
            };

            const getCardKey = (cardNum) => `card-${cardNum}`;
            
            const getCardInventory = (cardNum) => collection[getCardKey(cardNum)] || {};
            
            const getTotalCount = (cardNum) => {
                const inventory = getCardInventory(cardNum);
                return Object.keys(inventory)
                    .filter(key => !key.startsWith('_'))
                    .reduce((sum, variant) => sum + (inventory[variant] || 0), 0);
            };

            const getVariantBreakdown = (cardNum) => {
                const inventory = getCardInventory(cardNum);
                return Object.keys(inventory)
                    .filter(key => !key.startsWith('_') && inventory[key] > 0)
                    .map(variant => ({
                        variant: variant,
                        count: inventory[variant],
                        style: variantStyles[variant] || { bg: "bg-gray-500", text: "??", color: "#6b7280" }
                    }));
            };

            const getTotalCollectionCount = () => {
                return Object.keys(collection)
                    .filter(key => !key.startsWith('_'))
                    .reduce((sum, cardKey) => {
                        const cardInventory = collection[cardKey];
                        return sum + Object.keys(cardInventory)
                            .filter(key => !key.startsWith('_'))
                            .reduce((s, variant) => s + (cardInventory[variant] || 0), 0);
                    }, 0);
            };

            // Analyze card with LLM for value estimation
            const analyzeCardValue = async (cardNum, variant) => {
                const card = cardData.find(c => c.num === cardNum);
                if (!card) return null;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: "claude-sonnet-4-5-20250929",
                            max_tokens: 500,
                            messages: [{
                                role: "user",
                                content: `Provide a brief value analysis for this F1 trading card:
Card: #${card.num} ${card.name}
Team: ${card.team || 'N/A'}
Variant: ${variant}
Subset: ${card.subset}
${card.rookie ? 'This is a ROOKIE card' : ''}

Please provide:
1. Current market value range (Raw, PSA 9, PSA 10)
2. 1-3 credible sources with specific details:
   - Recent comparable sales (e.g., "eBay: 3 sales at $5-8 in last 30 days")
   - Include web source URLs or references
   - Show how averages were calculated
3. Brief explanation of market factors affecting value

Keep response under 150 words total, include source names and dates when available.`
                            }]
                        })
                    });

                    const data = await response.json();
                    if (data.content && data.content[0]?.text) {
                        return data.content[0].text.trim();
                    }
                    return null;
                } catch (error) {
                    console.error('Analysis error:', error);
                    return null;
                }
            };

            const reanalyzeCardValue = async (cardNum, variant) => {
                const card = cardData.find(c => c.num === cardNum);
                if (!card) return null;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: "claude-opus-4-5-20251101",
                            max_tokens: 2000,
                            tools: [{
                                type: "web_search_20250305",
                                name: "web_search"
                            }],
                            messages: [{
                                role: "user",
                                content: `You are a trading card expert. Analyze the current market value of this 2025 Topps Chrome F1 card:

Card #${card.num}: ${card.name}
Team: ${card.team || 'N/A'}
Variant: ${variant}
Subset: ${card.subset}
${card.rookie ? 'ROOKIE CARD' : ''}

CARD SET CONTEXT:
This card is from the 2025 Topps Chrome Formula 1 set. Even if imagery or data appears to be from a prior year, treat this as a 2025 Topps Chrome F1 card for valuation purposes.

IMPORTANT: Use web search to find CURRENT market data for similar 2025 Topps Chrome F1 cards, especially for this driver and variant.

Provide a comprehensive analysis including:

CARD IDENTIFICATION:
- Confirm driver, team, and variant details
- Note any special characteristics (rookie, serial numbered, etc.)

VARIANT & RARITY:
- Explain this specific variant and its rarity
- Compare to other variants in the set

VALUE ESTIMATES:
Provide current market values in this format:
Raw: $X-Y
PSA 9: $X-Y  
PSA 10: $X-Y

VALUE SOURCES & DERIVATION:
- List up to 3 credible sources with specific comparable sales data:
  * eBay completed sales: Include specific listings found (e.g., "3 Base cards sold $5-8 in last 30 days")
  * PSA Price Guide values with dates
  * TCGPlayer or other market data with URLs/references
- Show exact sales data: "Comparable card #XXX Refractor sold for $Y on [Date] on [Source]"
- Include calculation method: "Average of X comparable sales across Y sources"
- Note any market condition factors affecting the estimate

Example format: "Values based on 5 recent eBay sales ($5-8 avg, Feb 2025), PSA guide ($7-10), and TCGPlayer listings ($6-9). Card #161 Base shows strong demand due to rookie status."

IMPORTANT: Do NOT use trailing commas after value ranges.

COLLECTIBILITY:
- Why collectors want this card
- Investment potential
- Market trends

Base your analysis on current 2025 market data from web search.`
                            }]
                        })
                    });

                    const data = await response.json();
                    if (data.content) {
                        // Extract text from all content blocks (including after tool use)
                        const analysisText = data.content
                            .filter(block => block.type === 'text')
                            .map(block => block.text)
                            .join('\n\n')
                            .trim();
                        
                        return analysisText || null;
                    }
                    return null;
                } catch (error) {
                    console.error('Reanalysis error:', error);
                    return null;
                }
            };

            // Lookup card details (driver name, card title, value) from web search
            const lookupCardDetails = async (cardNum) => {
                try {
                    setLoadingCardDetails(true);
                    
                    // Use Claude API with web search to find card details
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'claude-opus-4-5-20251101',
                            max_tokens: 500,
                            tools: [
                                {
                                    type: 'web_search',
                                    name: 'web_search'
                                }
                            ],
                            messages: [{
                                role: 'user',
                                content: `Find information about 2025 Topps Chrome F1 card #${cardNum}. Respond ONLY with JSON in this format:
{
  "cardTitle": "Card title or driver name",
  "driverName": "Driver name if applicable",
  "value": "Current market value estimate e.g. $5-10"
}

If you cannot find the exact card, provide your best estimate based on similar cards in the set.`
                            }]
                        })
                    });

                    const data = await response.json();
                    let details = { cardTitle: '', driverName: '', value: '' };
                    
                    if (data.content) {
                        const fullText = data.content
                            .map(block => {
                                if (block.type === 'text') return block.text;
                                return '';
                            })
                            .join('');
                        
                        // Extract JSON from response
                        const jsonMatch = fullText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            try {
                                details = JSON.parse(jsonMatch[0]);
                            } catch (e) {
                                console.warn('Could not parse card details JSON');
                            }
                        }
                    }
                    
                    setLoadingCardDetails(false);
                    return details;
                } catch (error) {
                    console.error('Card details lookup error:', error);
                    setLoadingCardDetails(false);
                    return { cardTitle: '', driverName: '', value: '' };
                }
            };

            const addCard = async (cardNum, variant, analysis = null, gradeReport = null) => {
                console.log('üîç addCard called:', { cardNum, variant, analysisExists: !!analysis });
                console.log('üìä Current collection state:', Object.keys(collection).length, 'cards');
                console.log('üìä Current collection card count:', Object.keys(collection).filter(k => k.startsWith('card-')).length);
                
                const key = getCardKey(cardNum);
                const newCollection = { ...collection };
                if (!newCollection[key]) newCollection[key] = {};
                
                const isFirstOfVariant = !newCollection[key][variant] || newCollection[key][variant] === 0;
                
                if (!newCollection[key][variant]) {
                    newCollection[key][variant] = 0;
                }
                newCollection[key][variant]++;
                
                console.log('‚úÖ Updated collection:', { key, variant, count: newCollection[key][variant] });
                console.log('üìù BEFORE cleanup - total cards:', Object.keys(newCollection).filter(k => k.startsWith('card-')).length);
                console.log('üìù BEFORE cleanup - card #' + cardNum + ' variant "' + variant + '" count:', newCollection[key][variant]);
                
                if (analysis) {
                    if (!newCollection[key]._analyses) newCollection[key]._analyses = {};
                    if (!newCollection[key]._analyses[variant]) newCollection[key]._analyses[variant] = [];
                    newCollection[key]._analyses[variant].push({
                        id: Date.now(),
                        addedDate: new Date().toISOString(),
                        analysis: analysis
                    });
                }

                if (gradeReport) {
                    if (!newCollection[key]._gradeReports) newCollection[key]._gradeReports = {};
                    newCollection[key]._gradeReports[variant] = gradeReport;
                }
                
                saveCollection(newCollection);

                // If this is the first card of this variant and we have server, analyze it
                if (isFirstOfVariant && serverOnline && !analysis) {
                    const analyzeKey = `${cardNum}-${variant}`;
                    setAnalyzingCards(prev => ({ ...prev, [analyzeKey]: true }));
                    
                    const cardAnalysis = await analyzeCardValue(cardNum, variant);
                    
                    setAnalyzingCards(prev => {
                        const updated = { ...prev };
                        delete updated[analyzeKey];
                        return updated;
                    });
                    
                    if (cardAnalysis) {
                        const updatedCollection = { ...newCollection };
                        if (!updatedCollection[key]._analyses) updatedCollection[key]._analyses = {};
                        if (!updatedCollection[key]._analyses[variant]) updatedCollection[key]._analyses[variant] = [];
                        updatedCollection[key]._analyses[variant].push({
                            id: Date.now(),
                            addedDate: new Date().toISOString(),
                            analysis: cardAnalysis
                        });
                        saveCollection(updatedCollection);
                    }
                }
            };

            const removeCard = (cardNum, variant) => {
                const key = getCardKey(cardNum);
                const newCollection = { ...collection };
                if (newCollection[key] && newCollection[key][variant] > 0) {
                    newCollection[key][variant]--;
                    if (newCollection[key][variant] === 0) {
                        delete newCollection[key][variant];
                    }
                    saveCollection(newCollection);
                }
            };

            const exportCollection = () => {
                const dataStr = JSON.stringify(collection, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `f1-collection-backup-${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const importCollection = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        saveCollection(imported);
                        alert(`‚úÖ Collection imported successfully!\n\nCards restored: ${Object.keys(imported).filter(k => !k.startsWith('_')).length}`);
                    } catch (error) {
                        alert('‚ùå Error importing file. Make sure it\'s a valid backup file.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            };

            // Compress image to reduce file size for API
            const compressImage = async (dataUrl, maxWidth = 1200, quality = 0.8) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Resize if too large
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG with quality setting
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressed);
                    };
                    img.src = dataUrl;
                });
            };

            const handleImageUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                
                // Limit to 2 images (front and back)
                const filesToProcess = files.slice(0, 2);
                if (files.length > 2) {
                    alert(`üì∏ Multiple Images Selected\n\nProcessing first 2 images (front and back of card).\n\nTip: Upload front and back for best recognition accuracy!`);
                }
                
                setDeepAnalysis(null);
                setSelectedAnalysisSource('opus');
                setIsRecognizing(true);
                
                const processedImages = [];
                
                for (let file of filesToProcess) {
                    try {
                        // Check if file is HEIC/HEIF
                        const isHEIC = file.type === 'image/heic' || 
                                       file.type === 'image/heif' || 
                                       file.name.toLowerCase().endsWith('.heic') || 
                                       file.name.toLowerCase().endsWith('.heif');
                        
                        if (isHEIC) {
                            // Convert HEIC to JPEG automatically
                            try {
                                console.log(`Converting HEIC file: ${file.name}`);
                                
                                // Check if heic2any library is loaded
                                if (typeof window.heic2any === 'undefined') {
                                    throw new Error('heic2any library not loaded. Please refresh the page.');
                                }
                                
                                const convertedBlob = await window.heic2any({
                                    blob: file,
                                    toType: 'image/jpeg',
                                    quality: 0.9
                                });
                                
                                // heic2any might return array of blobs
                                const blob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;
                                
                                // Create a new File object with JPEG type
                                file = new File([blob], file.name.replace(/\.heic$/i, '.jpg'), {
                                    type: 'image/jpeg'
                                });
                                
                                console.log(`‚úì HEIC conversion successful: ${file.name}`);
                            } catch (conversionError) {
                                console.error('HEIC conversion error:', conversionError);
                                setIsRecognizing(false);
                                
                                // Provide helpful error message based on error type
                                let errorDetail = conversionError.message || 'Unknown error';
                                let suggestion = '';
                                
                                if (errorDetail.includes('format not supported')) {
                                    suggestion = '\n\nüí° This HEIC file uses a format variant that cannot be converted automatically.\n\n';
                                } else if (errorDetail.includes('library not loaded')) {
                                    suggestion = '\n\nüí° Please refresh the page and try again.\n\n';
                                } else {
                                    suggestion = '\n\n';
                                }
                                
                                alert(`üì± Cannot Auto-Convert HEIC File\n\nFile: ${file.name}${suggestion}QUICK FIX - Use iPhone Screenshot:\n\n1Ô∏è‚É£ Open the photo in Photos app\n2Ô∏è‚É£ Take a SCREENSHOT of the photo\n   (Press Side + Volume Up buttons)\n3Ô∏è‚É£ Upload the screenshot instead\n   (Screenshots are JPG format!)\n\nOR Convert Manually:\n\n1Ô∏è‚É£ Open Photos app\n2Ô∏è‚É£ Select the photo\n3Ô∏è‚É£ Tap Share (‚¨ÜÔ∏è)\n4Ô∏è‚É£ Scroll down ‚Üí "Save to Files"\n5Ô∏è‚É£ Upload the converted file\n\n‚ú® Screenshots work instantly!`);
                                event.target.value = '';
                                return;
                            }
                        }
                        
                        // Read file as data URL
                        const dataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        
                        // Compress image to reduce size
                        console.log(`Compressing image ${filesToProcess.indexOf(file) + 1}/${filesToProcess.length}...`);
                        const compressed = await compressImage(dataUrl, 1200, 0.75);
                        processedImages.push(compressed);
                    } catch (error) {
                        console.error('Error processing file:', file.name, error);
                        setIsRecognizing(false);
                        alert(`Error processing image: ${file.name}\n\nPlease try a different file.`);
                        event.target.value = '';
                        return;
                    }
                }
                
                if (processedImages.length > 0) {
                    // Combine with existing pending images if adding a second image
                    const allImages = [...(showSecondImagePrompt ? pendingImages : uploadedImages || []), ...processedImages];
                    
                    if (allImages.length === 1) {
                        // Still only 1 image - show prompt again
                        setPendingImages(allImages);
                        setShowSecondImagePrompt(true);
                        setIsRecognizing(false);
                    } else if (allImages.length >= 2) {
                        // 2 or more images - close prompt and proceed with analysis
                        setShowSecondImagePrompt(false);
                        setPendingImages([]);
                        setUploadedImages(allImages);
                        recognizeCard(allImages);
                    }
                } else {
                    setIsRecognizing(false);
                    event.target.value = '';
                }
            };

            const recognizeCard = async (base64Images) => {
                setIsRecognizing(true);
                setRecognizedCard(null);
                setRecognitionError(null);
                setSelectedAnalysisSource('opus');

                try {
                    // Handle both single image and array
                    const images = Array.isArray(base64Images) ? base64Images : [base64Images];
                    
                    // Build content array with images
                    const contentArray = [];
                    
                    images.forEach((base64Image, index) => {
                        const mediaTypeMatch = base64Image.match(/^data:(image\/[a-zA-Z]+);base64,/);
                        const mediaType = mediaTypeMatch ? mediaTypeMatch[1] : 'image/jpeg';
                        const imageData = base64Image.split(',')[1];
                        
                        contentArray.push({
                            type: "image",
                            source: { type: "base64", media_type: mediaType, data: imageData }
                        });
                    });
                    
                    // Add text prompt after images
                    const promptText = images.length > 1 
                        ? `Analyze these F1 trading card images (FRONT and BACK of the same card). 

CRITICAL: 
- Image 1: Front of card (driver photo)
- Image 2: Back of card (contains CARD NUMBER)

The BACK IMAGE is ESSENTIAL - extract the card number from it very carefully!`
                        : `Analyze this F1 trading card image.`;
                    
                    contentArray.push({
                        type: "text",
                        text: `${promptText}

CARD SET CONTEXT:
2025 Topps Chrome Formula 1 set. Treat all cards as 2025 edition even if imagery appears older.

CRITICAL - CARD NUMBER EXTRACTION (FROM BACK IMAGE):
${images.length > 1 ? `The BACK IMAGE contains the card number - extract it VERY carefully! Look for:
  ‚Ä¢ Small card number in bottom left or elsewhere on back
  ‚Ä¢ Format examples: "#1", "#42", "R-1", "CR-15", etc.
  ‚Ä¢ This is NOT the gold serial number (e.g., "63/299")
  ‚Ä¢ Back image card number guides analysis for accurate details` : 'Extract the card number from the card'}

TASK: Analyze this card thoroughly with web search for current market values.

Web Search Strategy:
1. Use card number to search for exact 2025 Topps Chrome F1 card listings
2. Find real eBay, Cardmarket, or PSA sales data for this specific card
3. Look for current market prices in Raw, PSA 9, and PSA 10 conditions
4. Use the card number to find accurate pricing data

Analyze this card THOROUGHLY with detailed structure using web search results for value estimates.

IMPORTANT: Return ONLY valid JSON with properly escaped newlines (use \\n for line breaks, not actual newlines). No markdown, no extra text.

{
  "cardNumber": "from back image if visible, else inferred",
  "cardNumberConfidence": "high/medium/low",
  "cardNumberSource": "${images.length > 1 ? 'back_image/front_image/inferred' : 'front_image/inferred'}",
  "serialNumber": "null or serial like 63/250",
  "driverName": "full name",
  "team": "full team",
  "subset": "subset name",
  "variant": "exact variant name",
  "isRookie": true or false,
  "confidence": "high/medium/low",
  "analysis": "CARD IDENTIFICATION:\\n[Driver name, team, card number verification, visual details]\\n\\nVARIANT & RARITY:\\n[Specific variant analysis, serial number details if present]\\n\\nVALUE ESTIMATES (2025 Topps Chrome F1 - from web search):\\nRaw: $X-Y\\nPSA 9: $X-Y\\nPSA 10: $X-Y\\n\\nVALUE SOURCES & DERIVATION:\\n[List 1-3 credible sources with comparable sales data]\\n[Include: eBay recent sales (e.g. 3 sold $5-8 Feb 2025), PSA guide ($X-Y), TCGPlayer listings]\\n[Show specific comparable: Card #XXX sold for $Y on [Date]]\\n[Calculation: Average of X comparable sales]\\nExample: 'eBay: 5 Base cards $5-8 avg (Feb), PSA guide $7-10, TCGPlayer $6-9. #161 Base up 15% due to rookie demand'\\n\\nCOLLECTIBILITY:\\n[Why collectors want this card, current market trends]"
}`
                    });
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: "claude-opus-4-5-20251101",
                            max_tokens: 3000,
                            tools: [{
                                type: "web_search_20250305",
                                name: "web_search"
                            }],
                            messages: [{
                                role: "user",
                                content: contentArray
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0]?.text) {
                        let fullText = data.content[0].text.trim();
                        
                        // Remove markdown code blocks
                        fullText = fullText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        
                        console.log('Opus response length:', fullText.length);
                        
                        // Strategy: Extract the analysis field first (which can contain newlines)
                        let recognized = {};
                        let analysisText = null;
                        
                        // Extract analysis field - handle newlines in the value
                        const analysisMatch = fullText.match(/"analysis":\s*"([\s\S]*?)"\s*(?:}|,)/);
                        if (analysisMatch && analysisMatch[1]) {
                            analysisText = analysisMatch[1]
                                .replace(/\\n/g, '\n')  // Convert escaped newlines to actual newlines
                                .trim();
                            console.log('‚úì Extracted analysis text, length:', analysisText.length);
                        }
                        
                        // Now try to extract the JSON object for other fields
                        let jsonMatch = fullText.match(/\{[\s\S]*\}(?=\s*$)/);
                        if (!jsonMatch) {
                            const startIdx = fullText.indexOf('{');
                            const endIdx = fullText.lastIndexOf('}');
                            if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
                                jsonMatch = [fullText.substring(startIdx, endIdx + 1)];
                            }
                        }
                        
                        if (jsonMatch && jsonMatch[0]) {
                            try {
                                // Try to parse the full JSON first
                                recognized = JSON.parse(jsonMatch[0]);
                                console.log('‚úì Successfully parsed full Opus response');
                            } catch (parseError) {
                                console.warn('Full JSON parse failed, attempting field extraction:', parseError.message);
                                
                                // Fallback: extract individual fields using regex
                                const cardNumberMatch = fullText.match(/"cardNumber":\s*"([^"]*)"/);
                                const confMatch = fullText.match(/"cardNumberConfidence":\s*"([^"]*)"/);
                                const sourceMatch = fullText.match(/"cardNumberSource":\s*"([^"]*)"/);
                                const driverMatch = fullText.match(/"driverName":\s*"([^"]*)"/);
                                const teamMatch = fullText.match(/"team":\s*"([^"]*)"/);
                                const subsetMatch = fullText.match(/"subset":\s*"([^"]*)"/);
                                const variantMatch = fullText.match(/"variant":\s*"([^"]*)"/);
                                const serialMatch = fullText.match(/"serialNumber":\s*(?:null|"([^"]*)")/);
                                const rookieMatch = fullText.match(/"isRookie":\s*(true|false)/);
                                
                                recognized = {
                                    cardNumber: cardNumberMatch?.[1] || 'Unknown',
                                    cardNumberConfidence: confMatch?.[1] || 'medium',
                                    cardNumberSource: sourceMatch?.[1] || 'inferred',
                                    driverName: driverMatch?.[1] || 'Unknown',
                                    team: teamMatch?.[1] || 'Unknown',
                                    subset: subsetMatch?.[1] || 'Unknown',
                                    variant: variantMatch?.[1] || 'Base',
                                    serialNumber: serialMatch?.[1] || null,
                                    isRookie: rookieMatch?.[1] === 'true'
                                };
                                console.log('‚úì Extracted fields via regex');
                            }
                        } else {
                            console.warn('No JSON structure found in response');
                        }
                        
                        // Validate/infer variant from serial number if present
                        if (recognized.serialNumber) {
                            const inferredVariants = inferVariantFromSerial(recognized.serialNumber);
                            if (inferredVariants) {
                                const originalVariant = recognized.variant;
                                recognized.variant = validateVariantWithSerial(recognized.variant, recognized.serialNumber);
                                if (originalVariant !== recognized.variant) {
                                    console.log(`üìä Serial number /${recognized.serialNumber} corrected variant from "${originalVariant}" to "${recognized.variant}"`);
                                } else {
                                    console.log(`‚úì Serial number /${recognized.serialNumber} confirms variant: ${recognized.variant}`);
                                }
                            }
                        }
                        
                        // Use the extracted analysis text if available
                        if (analysisText) {
                            recognized.analysis = analysisText;
                        }
                        
                        if (recognized && recognized.analysis) {
                            setRecognizedCard(recognized);
                            console.log('‚úì Card recognized with analysis');
                        } else {
                            throw new Error('Could not extract analysis from response');
                        }
                    } else {
                        throw new Error('Invalid response from API');
                    }
                } catch (error) {
                    console.error('Recognition error:', error);
                    setRecognitionError(error.message || 'Failed to recognize card');
                } finally {
                    setIsRecognizing(false);
                }
            };

            const performQuickGrade = async () => {
                if (!uploadedImages || uploadedImages.length === 0) {
                    alert('Please upload an image before grading.');
                    return;
                }

                setIsDeepAnalyzing(true);
                try {
                    const gradingPrompt = `You are an expert trading card grader analyzing 2025 Topps Chrome Formula 1 cards for potential PSA grading.

IMPORTANT - PROTECTIVE CONTAINERS:
If the card is in a penny sleeve, toploader, or other protective sleeve:
- Assess the card condition THROUGH the protective sleeve
- Make best effort to evaluate the card itself, not the container
- Note in the assessment that protective container was present
- Do NOT penalize the card for being in protective sleeve (it's standard practice)
- Assess the visible portions of the card condition

ANALYZE ALL PROVIDED IMAGES FOR COMPLETE ASSESSMENT:
Look at front, back, and any detail shots to form comprehensive evaluation.

ASSESSMENT CRITERIA:
Centering: left/right and top/bottom border ratios (55/45 or better = 10 potential)
Surface: scratches, print lines, dimples, roller marks, gloss uniformity
Corners: all four corners front/back for whitening, rounding, chipping
Edges: whitening, rough cuts, micro-chips
Print Quality: blur, misregistration, shadow text, color issues
Gloss & Cleanliness: uniformity, fingerprints, dust
Foil/Numbering: indentation, flaking, clarity

PROVIDE ASSESSMENT IN THIS FORMAT:

FINAL ASSESSMENT
[Driver/Card]: [Overall condition summary in 1-2 sentences]
Estimated PSA Grade: [X] with [Y]% confidence
Recommended for grading: Yes/No (only if 8+ probability)

GRADE PROBABILITY
PSA 10: [X]%
PSA 9: [X]%
PSA 8: [X]%
PSA 7 or below: [X]%

CONDITION CHECKLIST
Centering: [PASS/FAIL]
Surface: [PASS/FAIL]
Corners: [PASS/FAIL]
Edges: [PASS/FAIL]
Foil/Stamp: [PASS/FAIL]

DETAILED ANALYSIS
Centering: [Assessment]
Surface: [Findings]
Corners: [All 4 corners evaluation]
Edges: [Edge condition]
Print Quality: [Observations]
Gloss & Cleanliness: [Assessment]
Foil/Numbering: [Condition]

NOTES:
[Any protective sleeves detected, handling marks, or other observations]

GRADING SCALE FOR 2025 TOPPS CHROME F1:
- 5/5 checklist PASS = PSA 10 (90%+ confidence)
- 4/5 checklist PASS = PSA 9 (60-80% confidence)
- 3/5 checklist PASS = PSA 8-9 (40-60% confidence)
- 2/5 or less = PSA 8 or below

KEY FACTORS:
- Centering is primary PSA 9 vs 10 differentiator
- Any surface flaw = PSA 9 ceiling
- Chrome susceptibility to damage is factor
- Protective sleeve does NOT reduce grade`;

                    // Build content array with all images
                    const contentArray = [];
                    
                    // Add all uploaded images
                    uploadedImages.forEach((img, idx) => {
                        const imageBase64 = img.split(',')[1];
                        contentArray.push({
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: 'image/jpeg',
                                data: imageBase64
                            }
                        });
                    });
                    
                    // Add the grading prompt
                    contentArray.push({
                        type: 'text',
                        text: gradingPrompt
                    });

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: 'claude-opus-4-5-20251101',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: contentArray
                            }]
                        })
                    });

                    const data = await response.json();
                    console.log('Grade API Response:', data);
                    
                    if (data.content && data.content.length > 0) {
                        const gradeReport = data.content
                            .filter(block => block.type === 'text')
                            .map(block => block.text)
                            .join('\n\n');
                        
                        console.log('Grade Report Generated:', gradeReport.substring(0, 200));
                        
                        if (recognizedCard) {
                            setRecognizedCard(prev => ({
                                ...prev,
                                gradeReport: gradeReport
                            }));
                            alert('‚úÖ Grade Report Generated!\n\nScroll down to see full assessment.');
                        } else {
                            console.warn('recognizedCard not set, cannot store grade report');
                            alert('‚ö†Ô∏è Grade report created but card not recognized. Please ensure card is analyzed first.');
                        }
                    } else {
                        alert('‚ùå No response from grading API');
                    }
                } catch (error) {
                    console.error('Grade analysis error:', error);
                    alert('‚ùå Error generating grade report:\n' + error.message);
                } finally {
                    setIsDeepAnalyzing(false);
                }
            };

            // Quick grade function for individual variants in card detail view
            const performQuickGradeForVariant = async (cardNum, variant) => {
                if (!uploadedImages || uploadedImages.length === 0) {
                    alert('Please upload an image before grading this variant.');
                    return;
                }

                try {
                    const gradingPrompt = `You are an expert trading card grader analyzing 2025 Topps Chrome Formula 1 cards for potential PSA grading.

IMPORTANT - PROTECTIVE CONTAINERS:
Cards in protective containers (sleeves, toploaders, magnetic holders, etc.) can still be accurately assessed. Focus on visible card condition through the protection.

Please provide a detailed grading assessment for this ${variant} card #${cardNum} with these sections:

FINAL ASSESSMENT
- Overall condition summary
- Estimated PSA grade with confidence level
- Key factors affecting grade

GRADE PROBABILITY
- PSA 10: X% (probability)  
- PSA 9: X% (probability)
- PSA 8: X% (probability)
- Lower: X% (probability)

CONDITION CHECKLIST
- Centering: PASS/FAIL (detailed assessment)
- Corners: PASS/FAIL (detailed assessment)  
- Edges: PASS/FAIL (detailed assessment)
- Surface: PASS/FAIL (detailed assessment)

DETAILED ANALYSIS
- Specific observations about flaws or positive aspects
- Impact of any protective casing on assessment
- Recommendations for grading submission

Be thorough and specific in your assessment.`;

                    // Build content array with all images
                    const contentArray = [];
                    
                    uploadedImages.forEach((uploadedImage) => {
                        contentArray.push({
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: 'image/jpeg',
                                data: uploadedImage.split(',')[1]
                            }
                        });
                    });

                    contentArray.push({
                        type: 'text',
                        text: gradingPrompt
                    });

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: 'claude-opus-4-5-20251101',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: contentArray
                            }]
                        })
                    });

                    const data = await response.json();
                    console.log('QGA: Quick grade response received for variant', variant);
                    
                    if (data.content && data.content.length > 0) {
                        const gradeReport = data.content
                            .filter(block => block.type === 'text')
                            .map(block => block.text)
                            .join('\n\n');
                        
                        console.log('QGA: Grade report generated for variant', variant);
                        
                        // Save the grade report for this specific variant
                        const key = getCardKey(cardNum);
                        const updatedCollection = { ...collection };
                        
                        if (!updatedCollection[key]) updatedCollection[key] = {};
                        if (!updatedCollection[key]._gradeReports) updatedCollection[key]._gradeReports = {};
                        
                        updatedCollection[key]._gradeReports[variant] = gradeReport;
                        
                        setCollection(updatedCollection);
                        saveCollection(updatedCollection);
                        
                        console.log('QGA: Grade report saved for variant', variant);
                    } else {
                        console.error('QGA: No response from grading API');
                    }
                } catch (error) {
                    console.error('QGA: Quick grade error for variant:', error);
                    setRecognitionError('Failed to grade card variant. Please try again.');
                }
            };

            const performDeepAnalysis = async () => {
                if (!uploadedImages || uploadedImages.length === 0 || !recognizedCard) return;
                
                setIsDeepAnalyzing(true);
                setDeepAnalysis(null);

                try {
                    // Build content array with all images
                    const contentArray = [];
                    
                    uploadedImages.forEach((uploadedImage) => {
                        const mediaTypeMatch = uploadedImage.match(/^data:(image\/[a-zA-Z]+);base64,/);
                        const mediaType = mediaTypeMatch ? mediaTypeMatch[1] : 'image/jpeg';
                        const imageData = uploadedImage.split(',')[1];
                        
                        contentArray.push({
                            type: "image",
                            source: { type: "base64", media_type: mediaType, data: imageData }
                        });
                    });
                    
                    const promptText = uploadedImages.length > 1
                        ? `Perform DEEP analysis of these F1 card images (FRONT and BACK). The BACK image contains the card number which is KEY to accurate research.`
                        : `Perform DEEP analysis of this F1 card image.`;
                    
                    // Add text prompt
                    contentArray.push({
                        type: "text",
                        text: `${promptText}

CARD SET: 2025 Topps Chrome Formula 1 (treat all as 2025 regardless of imagery age)

Current Detection:
Card #${recognizedCard.cardNumber} (confidence: ${recognizedCard.cardNumberConfidence})
${recognizedCard.cardNumberSource ? `Source: ${recognizedCard.cardNumberSource}` : ''}
Driver: ${recognizedCard.driverName}
Team: ${recognizedCard.team}
Variant: ${recognizedCard.variant}
${recognizedCard.serialNumber ? `Serial: ${recognizedCard.serialNumber}` : ''}

TASK: Use the card number (especially from BACK IMAGE if available) to guide web search for accurate 2025 Topps Chrome F1 card details and current market values.

Web Search Strategy:
1. Use card number #${recognizedCard.cardNumber} as primary identifier
2. Search for "2025 Topps Chrome F1 card #${recognizedCard.cardNumber} ${recognizedCard.driverName}"
3. Find current market prices for this specific card and variant
4. Verify driver, team, rookie status, and subset from search results
5. Get accurate value ranges for Raw, PSA 9, PSA 10 conditions

IMPORTANT: Return ONLY valid JSON with properly escaped newlines (use \\n for line breaks, not actual newlines). No markdown, no extra text.

{
  "cardNumber": "verified via back image and web search",
  "cardNumberSource": "back_image/front_image/web_search/database",
  "serialNumber": "serial if visible, else null",
  "driverName": "full driver name",
  "team": "full team name",
  "subset": "subset category",
  "variant": "exact variant (Base, Refractor, Purple /299, Blue /150, Green /99, Gold /50, Orange /25, Red /5, SuperFractor 1/1, Black /10, Magenta /250, Gold Wave /75, Printing Plate 1/1)",
  "isRookie": true/false,
  "confidence": "high/medium/low",
  "analysis": "CARD IDENTIFICATION:\\n[Back image card number and driver verification]\\n\\nWEB SEARCH FINDINGS:\\n[2025 Topps Chrome F1 market data for this card and variant]\\n\\nVARIANT & RARITY:\\n[Specific variant analysis]\\n\\nVALUE ESTIMATES (2025 Topps Chrome F1):\\nRaw: $X-Y\\nPSA 9: $X-Y\\nPSA 10: $X-Y\\n\\nVALUE SOURCES & DERIVATION:\\n[List 1-3 credible sources with comparable sales data]\\n[Include: eBay recent sales (e.g. 3 sold $5-8 Feb 2025), PSA guide, TCGPlayer prices]\\n[Show specific comparable: Card #XXX variant sold for $Y on [Date]]\\n[Calculation: Average of X comparable sales]\\nExample: 'eBay: 5 Base cards $5-8 avg (Feb), PSA guide $7-10, TCGPlayer $6-9. #161 Base up 15% due to rookie demand'\\n\\nCOLLECTIBILITY:\\n[Why collectors want this, market trends]"
}`
                    });
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            model: "claude-sonnet-4-5-20250929",
                            max_tokens: 4000,
                            tools: [{
                                type: "web_search_20250305",
                                name: "web_search"
                            }],
                            messages: [{
                                role: "user",
                                content: contentArray
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content) {
                        console.log('Opus response blocks:', data.content.length);
                        
                        // Extract all text content blocks (may include web search results)
                        let fullText = data.content
                            .filter(block => block.type === 'text')
                            .map(block => block.text)
                            .join('\n\n')
                            .trim();
                        
                        console.log('Extracted text length:', fullText.length);
                        console.log('First 500 chars:', fullText.substring(0, 500));
                        
                        // Remove markdown code blocks
                        fullText = fullText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        
                        // Strategy: Extract the analysis field first (which can contain newlines)
                        // Then extract other fields from JSON
                        let opusData = {};
                        let analysisText = null;
                        
                        // Extract analysis field - handle newlines in the value
                        const analysisMatch = fullText.match(/"analysis":\s*"([\s\S]*?)"\s*(?:}|,)/);
                        if (analysisMatch && analysisMatch[1]) {
                            analysisText = analysisMatch[1]
                                .replace(/\\n/g, '\n')  // Convert escaped newlines to actual newlines
                                .trim();
                            console.log('‚úì Extracted analysis text, length:', analysisText.length);
                        }
                        
                        // Now try to extract the JSON object for other fields
                        let jsonMatch = fullText.match(/\{[\s\S]*\}(?=\s*$)/);
                        if (!jsonMatch) {
                            const startIdx = fullText.indexOf('{');
                            const endIdx = fullText.lastIndexOf('}');
                            if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
                                jsonMatch = [fullText.substring(startIdx, endIdx + 1)];
                            }
                        }
                        
                        if (jsonMatch && jsonMatch[0]) {
                            try {
                                // Try to parse the full JSON first
                                opusData = JSON.parse(jsonMatch[0]);
                                console.log('‚úì Successfully parsed full Opus JSON response');
                            } catch (parseError) {
                                console.warn('Full JSON parse failed, attempting field extraction:', parseError.message);
                                
                                // Fallback: extract individual fields using regex
                                const cardNumberMatch = fullText.match(/"cardNumber":\s*"([^"]*)"/);
                                const driverMatch = fullText.match(/"driverName":\s*"([^"]*)"/);
                                const teamMatch = fullText.match(/"team":\s*"([^"]*)"/);
                                const subsetMatch = fullText.match(/"subset":\s*"([^"]*)"/);
                                const variantMatch = fullText.match(/"variant":\s*"([^"]*)"/);
                                const serialMatch = fullText.match(/"serialNumber":\s*(?:null|"([^"]*)")/);
                                const rookieMatch = fullText.match(/"isRookie":\s*(true|false)/);
                                const confMatch = fullText.match(/"confidence":\s*"([^"]*)"/);
                                
                                opusData = {
                                    cardNumber: cardNumberMatch?.[1] || 'Unknown',
                                    driverName: driverMatch?.[1] || 'Unknown',
                                    team: teamMatch?.[1] || 'Unknown',
                                    subset: subsetMatch?.[1] || 'Unknown',
                                    variant: variantMatch?.[1] || 'Base',
                                    serialNumber: serialMatch?.[1] || null,
                                    isRookie: rookieMatch?.[1] === 'true',
                                    confidence: confMatch?.[1] || 'medium'
                                };
                                console.log('‚úì Extracted fields via regex:', Object.keys(opusData));
                            }
                        } else {
                            console.warn('No JSON structure found in response');
                        }
                        
                        // Validate/infer variant from serial number if present
                        if (opusData.serialNumber) {
                            const inferredVariants = inferVariantFromSerial(opusData.serialNumber);
                            if (inferredVariants) {
                                const originalVariant = opusData.variant;
                                opusData.variant = validateVariantWithSerial(opusData.variant, opusData.serialNumber);
                                if (originalVariant !== opusData.variant) {
                                    console.log(`üìä Serial number /${opusData.serialNumber} corrected variant from "${originalVariant}" to "${opusData.variant}"`);
                                } else {
                                    console.log(`‚úì Serial number /${opusData.serialNumber} confirms variant: ${opusData.variant}`);
                                }
                            }
                        }
                        
                        // Use the extracted analysis text if available
                        if (analysisText) {
                            opusData.analysis = analysisText;
                        }
                        
                        if (opusData && opusData.analysis) {
                            // Successfully parsed - set ONLY the analysis field
                            setDeepAnalysis(opusData.analysis);
                            
                            // Update card with Opus findings
                            const updatedCard = {
                                ...recognizedCard,
                                cardNumber: manualCardNumber || opusData.cardNumber,
                                _opusData: opusData,
                                _differences: {
                                    cardNumber: manualCardNumber ? false : (opusData.cardNumber !== recognizedCard.cardNumber),
                                    serialNumber: opusData.serialNumber !== recognizedCard.serialNumber,
                                    driverName: opusData.driverName !== recognizedCard.driverName,
                                    team: opusData.team !== recognizedCard.team,
                                    subset: opusData.subset !== recognizedCard.subset,
                                    variant: opusData.variant !== recognizedCard.variant
                                }
                            };
                            
                            setRecognizedCard(updatedCard);
                            console.log('‚úì Deep analysis complete');
                        } else {
                            // Could not parse or extract analysis
                            console.error('Could not extract analysis from Opus response');
                            console.error('opusData:', opusData);
                            console.error('Has analysis field:', opusData?.analysis ? 'yes' : 'no');
                            setDeepAnalysis('Error: Could not extract analysis. Please try again or check server logs.');
                        }
                    } else {
                        throw new Error('Invalid response from API - no content blocks');
                    }
                } catch (error) {
                    console.error('Deep analysis error:', error);
                    setDeepAnalysis('Error performing deep analysis. Please try again.');
                } finally {
                    setIsDeepAnalyzing(false);
                }
            };

            const handleDoneEditing = () => {
                setRecognizedCard(editedCard);
                setIsEditing(false);
            };

            const handleAddRecognizedCard = () => {
                if (recognizedCard) {
                    try {
                        // Use the selected analysis source
                        const analysisToUse = selectedAnalysisSource === 'opus' && deepAnalysis 
                            ? deepAnalysis 
                            : recognizedCard.analysis;
                        
                        let aiVariant = recognizedCard.variant;
                        if (aiVariant === "Base Chrome") aiVariant = "Base";
                        
                        // Validate variant against official list
                        const validVariant = findBestVariantMatch(aiVariant);
                        
                        if (validVariant) {
                            // Good match found - proceed with adding
                            console.log(`Variant validated: "${aiVariant}" ‚Üí "${validVariant}"`);
                            addCardWithVariant(recognizedCard.cardNumber, validVariant, analysisToUse);
                        } else {
                            // No good match - show user a selection modal
                            console.warn(`‚ö†Ô∏è Unknown variant: "${aiVariant}" - asking user to select`);
                            setVariantValidationModal({
                                cardNum: recognizedCard.cardNumber,
                                aiVariant: aiVariant,
                                pendingAnalysis: analysisToUse
                            });
                            return; // Don't close scanner yet
                        }
                    } catch (error) {
                        console.error('Error adding card:', error);
                        alert('‚ùå Error adding card: ' + error.message);
                    }
                }
            };

            // Helper function to add card after variant is confirmed
            const addCardWithVariant = (cardNum, variant, analysis) => {
                console.log(`Adding card: #${cardNum} (${variant})`);
                
                // Pass gradeReport if it exists on recognizedCard
                const gradeReport = recognizedCard?.gradeReport || null;
                addCard(cardNum, variant, analysis, gradeReport);
                
                // Get card title from cardData
                const card = cardData.find(c => c.num === cardNum);
                const cardTitle = card ? card.name || card.driver || 'Unknown' : 'Unknown';
                
                // Get collection stats using the proper count function
                const jsonStr = JSON.stringify(collection);
                const totalCards = getTotalCollectionCount();
                
                // Show enhanced confirmation alert
                alert(`‚úÖ Added: Card #${cardNum}
${cardTitle}
Variant: ${variant}

üì¶ Collection Updated!
Total Cards: ${totalCards}
Storage: ${(jsonStr.length / 1024).toFixed(1)}KB`);
                
                // Set 5-second cooldown to prevent rate limit errors
                setAddCardCooldown(5);
                const cooldownInterval = setInterval(() => {
                    setAddCardCooldown(prev => {
                        if (prev <= 1) {
                            clearInterval(cooldownInterval);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                
                setShowImageUpload(false);
                setUploadedImages([]);
                setPendingImages([]);
                setShowSecondImagePrompt(false);
                setRecognizedCard(null);
                setEditedCard(null);
                setIsEditing(false);
                setRecognitionError(null);
                setDeepAnalysis(null);
                setSelectedAnalysisSource('opus'); // Reset to default
                setVariantValidationModal(null);
            };

            const handleLogout = () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('f1-token');
                    localStorage.removeItem('f1-email');
                    window.location.href = 'login.html';
                }
            };

            const forceReloadCollection = async () => {
                try {
                    console.log('Starting force reload...');
                    
                    // Try MongoDB first with short timeout
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                        
                        const response = await fetch(`https://f1-card-tracker-backend-1.onrender.com/api/collection/cincymed-f1-collection`, {
                            method: 'GET',
                            headers: getAuthHeaders(),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.cards && Object.keys(data.cards).length > 0) {
                                setCollection(data.cards);
                                // Also save to localStorage as backup
                                localStorage.setItem('f1-collection-pro-v2', JSON.stringify(data.cards));
                                const cardCount = Object.keys(data.cards).filter(k => k.startsWith('card-')).length;
                                alert(`‚úÖ Synced from MongoDB!\n${cardCount} cards loaded`);
                                console.log('‚úÖ Successfully synced from MongoDB');
                                return;
                            }
                        }
                    } catch (mongoError) {
                        console.log('MongoDB sync failed, using localStorage:', mongoError.message);
                    }
                    
                    // Fallback to localStorage
                    const saved = localStorage.getItem('f1-collection-pro-v2');
                    if (saved) {
                        const collection = JSON.parse(saved);
                        setCollection(collection);
                        const cardCount = Object.keys(collection).filter(k => k.startsWith('card-')).length;
                        alert(`üì± Reloaded from local storage!\n${cardCount} cards found`);
                        console.log('‚úÖ Reloaded from localStorage');
                    } else {
                        alert('‚ö†Ô∏è No collection found in storage');
                    }
                } catch (error) {
                    console.error('Force reload error:', error);
                    alert('‚ùå Error reloading collection');
                }
                setShowMenuDropdown(false);
            };

            const needsVerification = (confidence) => {
                return confidence === 'medium' || confidence === 'low';
            };

            const extractValueEstimates = (analysisText) => {
                if (!analysisText) return null;
                
                // Updated regex to not capture trailing punctuation like commas
                const rawMatch = analysisText.match(/Raw[:\s]*\$?([\d,]+)\s*-\s*\$?([\d,]+)(?:[,.\s]|$)/i);
                const psa9Match = analysisText.match(/PSA\s*9[:\s]*\$?([\d,]+)\s*-\s*\$?([\d,]+)(?:[,.\s]|$)/i);
                const psa10Match = analysisText.match(/PSA\s*10[:\s]*\$?([\d,]+)\s*-\s*\$?([\d,]+)(?:[,.\s]|$)/i);
                
                if (!rawMatch && !psa9Match && !psa10Match) return null;
                
                return {
                    raw: rawMatch ? `$${rawMatch[1]}-$${rawMatch[2]}` : 'N/A',
                    psa9: psa9Match ? `$${psa9Match[1]}-$${psa9Match[2]}` : 'N/A',
                    psa10: psa10Match ? `$${psa10Match[1]}-$${psa10Match[2]}` : 'N/A'
                };
            };

            const calculateCardValue = (cardNum) => {
                const cardKey = getCardKey(cardNum);
                const cardInventory = collection[cardKey] || {};
                const analyses = cardInventory._analyses || {};
                
                let totalMaxValue = 0;
                
                // Get all variants for this card
                Object.keys(cardInventory).forEach(variant => {
                    if (variant === '_analyses') return; // Skip metadata
                    
                    const count = cardInventory[variant];
                    if (count === 0) return; // Skip if no cards
                    
                    // Get latest analysis for this variant
                    const variantAnalyses = analyses[variant] || [];
                    if (variantAnalyses.length === 0) return; // No analysis available
                    
                    const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                    
                    // Parse Raw value (using maximum)
                    const rawMatch = latestAnalysis.analysis.match(/Raw[:\s]*\$?([\d,]+)\s*-\s*\$?([\d,]+)(?:[,.\s]|$)/i);
                    
                    if (rawMatch) {
                        // Get max raw value and remove commas
                        const maxValue = parseInt(rawMatch[2].replace(/,/g, ''));
                        // Multiply by count and add to total
                        totalMaxValue += maxValue * count;
                    }
                });
                
                // Return emoji based on total value
                if (totalMaxValue === 0) return '';
                if (totalMaxValue < 5) return '$';
                if (totalMaxValue <= 40) return '$$';
                if (totalMaxValue <= 100) return '$$$';
                if (totalMaxValue <= 500) return '$$$$';
                return '$$$$$';
            };

            const resetCollection = () => {
                if (window.confirm('‚ö†Ô∏è Are you absolutely sure?\n\nThis will DELETE your entire collection.\n\nThis action CANNOT be undone!')) {
                    localStorage.removeItem('f1-collection-pro-v2');
                    setCollection({});
                    setShowResetConfirm(false);
                    alert('üóëÔ∏è Collection has been reset.');
                }
            };

            // Get value tier for a card based on $ indicators
            const getCardValueTier = (cardNum) => {
                const valueStr = calculateCardValue(cardNum);
                if (!valueStr) return null;
                const dollarCount = valueStr.length;
                if (dollarCount === 1) return '$';
                if (dollarCount === 2) return '$$';
                if (dollarCount === 3) return '$$$';
                if (dollarCount === 4) return '$$$$';
                if (dollarCount === 5) return '$$$$$';
                return null;
            };

            // Use predefined variant list for filter dropdown
            const allVariants = OFFICIAL_VARIANTS;

            const filteredCards = cardData.filter(card => {
                const matchesSearch = !searchTerm || 
                    card.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    card.num.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (card.team && card.team.toLowerCase().includes(searchTerm.toLowerCase()));
                
                const matchesSubset = filterSubset === 'all' || card.subset === filterSubset;
                const matchesRookie = filterRookie === 'all' || 
                    (filterRookie === 'rookie' && card.rookie) ||
                    (filterRookie === 'veteran' && !card.rookie);
                
                // Owned only filter
                const matchesOwned = !showOwnedOnly || getTotalCount(card.num) > 0;
                
                // Variant filtering (multi-select)
                const matchesVariant = filterVariants.length === 0 || (() => {
                    const cardKey = getCardKey(card.num);
                    const cardInventory = collection[cardKey];
                    if (!cardInventory) return false; // Card not in collection
                    
                    // Get all variants for this card
                    const cardVariants = Object.keys(cardInventory)
                        .filter(key => key !== '_analyses')
                        .map(variant => {
                            // Normalize variant names for comparison
                            if (variant.includes('Chrome') && !variant.includes('Refractor')) {
                                return 'Base';
                            }
                            return variant;
                        });
                    
                    // Check if any of the card's variants match the filter
                    return cardVariants.some(variant => filterVariants.includes(variant));
                })();
                
                // Value-based filtering (multi-select)
                const matchesValue = filterValues.length === 0 || (() => {
                    const totalCount = getTotalCount(card.num);
                    if (totalCount === 0) return false; // Don't show cards not in collection when filtering by value
                    const tier = getCardValueTier(card.num);
                    return tier && filterValues.includes(tier);
                })();
                
                return matchesSearch && matchesSubset && matchesRookie && matchesVariant && matchesValue && matchesOwned;
            });

            const stats = {
                totalCards: cardData.length,
                cardsOwned: Object.keys(collection).filter(k => !k.startsWith('_')).length,
                totalCopies: getTotalCollectionCount()
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
                    {/* Anchored Header - Fixed at Top on Desktop */}
                    <div className={`${isMobile ? 'sticky' : 'fixed'} top-0 left-0 right-0 z-40 bg-slate-900/95 backdrop-blur-sm shadow-xl`}>
                        <div className={`${isMobile ? 'p-2' : 'max-w-7xl mx-auto p-3'}`}>
                            {!serverOnline && (
                                <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-2 mb-2">
                                    <p className={`font-semibold ${isMobile ? 'text-xs' : 'text-sm'} mb-1`}>‚ö†Ô∏è Server Offline - AI Scanner Disabled</p>
                                    <p className="text-xs text-red-200 mb-1">
                                        {isMobile ? 'Scanner disabled' : 'The AI card scanner requires a local server'}
                                    </p>
                                    <button onClick={checkServer} className="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs">
                                        Check Again
                                    </button>
                                </div>
                            )}

                            <div className="mb-2">
                                <div className={`flex ${isMobile ? 'flex-col gap-2' : 'justify-between items-start'} mb-1 relative`}>
                                    {/* Hamburger Menu + Title */}
                                    <div className="flex items-center gap-2 md:gap-3 w-full">
                                        {/* Hamburger Menu */}
                                        <div ref={menuRef} className="relative flex-shrink-0">
                                            <button
                                                onClick={() => setShowMenuDropdown(!showMenuDropdown)}
                                                className="hamburger text-white hover:text-blue-400 transition text-4xl md:text-3xl"
                                                title="Open menu"
                                            >
                                                ‚ò∞
                                            </button>
                                            {showMenuDropdown && (
                                                <div className="dropdown-menu">
                                                    <div className="dropdown-item" onClick={() => { importInputRef.current?.click(); setShowMenuDropdown(false); }}>
                                                        üì• Import
                                                    </div>
                                                    <div className="dropdown-item" onClick={() => { exportCollection(); setShowMenuDropdown(false); }}>
                                                        üì§ Export
                                                    </div>
                                                    <div className="dropdown-item" onClick={forceReloadCollection} style={{borderTop: '1px solid #475569', marginTop: '8px', paddingTop: '8px'}}>
                                                        üîÑ Force Reload Collection
                                                    </div>
                                                    <div className="dropdown-item" onClick={() => { window.location.reload(); }} style={{borderTop: '1px solid #475569', marginTop: '8px', paddingTop: '8px'}}>
                                                        üîÉ Refresh Page
                                                    </div>
                                                    <div className="dropdown-item" onClick={handleLogout}>
                                                        üö™ Logout
                                                    </div>
                                                    {/* Danger Zone - Delete Collection */}
                                                    <button
                                                        onClick={() => { setShowExportBeforeDelete(true); setShowMenuDropdown(false); }}
                                                        className="dropdown-item-delete"
                                                    >
                                                        üóëÔ∏è Delete
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <h1 className={`font-bold bg-gradient-to-r from-blue-400 via-red-500 to-yellow-400 bg-clip-text text-transparent pb-2 ${isMobile ? 'text-lg' : 'text-5xl'}`}>
                                            {isMobile ? '2025 Topps Chrome F1 Cards' : '2025 Topps Chrome F1 Collection'}
                                        </h1>
                                    </div>

                                    <div className={`${isMobile ? 'flex gap-4 w-full' : 'flex gap-8 ml-auto justify-end'}`}>
                                        <div className={`flex flex-col ${isMobile ? 'items-start gap-1' : 'items-start gap-1'}`} title="Total number of cards in your collection (including duplicates)">
                                            <span className={`font-bold text-green-400 ${isMobile ? 'text-lg' : 'text-2xl'}`}>{stats.totalCopies}</span>
                                            <span className="text-xs text-slate-400 text-left">Total Cards</span>
                                        </div>
                                        <div className={`flex flex-col ${isMobile ? 'items-start gap-1' : 'items-start gap-1'}`} title="Number of different cards you own out of total cards in set">
                                            <span className={`font-semibold text-blue-400 ${isMobile ? 'text-base' : 'text-lg'}`}>{stats.cardsOwned}/{stats.totalCards}</span>
                                            <span className="text-xs text-slate-400 text-left">Unique Cards</span>
                                        </div>
                                        <div className={`flex flex-col ${isMobile ? 'items-start gap-1' : 'items-start gap-1'}`} title="Percentage of the complete set you own">
                                            <span className={`font-semibold text-purple-400 ${isMobile ? 'text-base' : 'text-lg'}`}>{((stats.cardsOwned/stats.totalCards)*100).toFixed(1)}%</span>
                                            <span className="text-xs text-slate-400 text-left">Complete Set</span>
                                        </div>
                                    </div>
                                </div>
                                <p className="text-slate-400 text-sm">
                                    Pro Tracker {serverOnline && <span className="text-green-400">‚úì Online</span>}
                                </p>
                            </div>

                            {isMobile ? (
                                // MOBILE: Search + Filters button
                                <div className="space-y-2">
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <input
                                                type="text"
                                                placeholder="Search..."
                                                title="Search by driver name or card number"
                                                className="px-3 py-2 pr-10 bg-slate-800 border border-slate-700 rounded-lg focus:border-blue-500 focus:outline-none text-sm w-full"
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                            />
                                            {searchTerm && (
                                                <button
                                                    onClick={() => setSearchTerm('')}
                                                    className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors"
                                                    title="Clear search"
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}
                                            className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-700 transition-colors flex items-center gap-2 whitespace-nowrap"
                                            title="Open filters menu"
                                        >
                                            üîΩ Filters
                                        </button>
                                    </div>
                                    {showFiltersDropdown && (
                                        <div className="bg-slate-800 border border-slate-700 rounded-lg p-3 space-y-3">
                                            {/* Subset Filter - Now First */}
                                            {/* Variant Filter - Now First */}
                                            <div>
                                                <label className="text-xs font-semibold text-slate-400 block mb-2">Variant Type</label>
                                                <select
                                                    className="w-full px-2 py-2 bg-slate-700 border border-slate-600 rounded text-sm"
                                                    title="Filter by variant type"
                                                    value={filterVariants.length > 0 ? filterVariants[0] : ''}
                                                    onChange={(e) => {
                                                        setFilterVariants(e.target.value ? [e.target.value] : []);
                                                    }}
                                                >
                                                    <option value="">All Variants</option>
                                                    <optgroup label="Standard">
                                                        <option value="Base">Base</option>
                                                        <option value="Refractor">Refractor</option>
                                                    </optgroup>
                                                    <optgroup label="Numbered Refractors">
                                                        <option value="Teal Refractor /299">Teal Refractor /299</option>
                                                        <option value="Pink Refractor /250">Pink Refractor /250</option>
                                                        <option value="Aqua Refractor /199">Aqua Refractor /199</option>
                                                        <option value="Blue Refractor /150">Blue Refractor /150</option>
                                                        <option value="Green Refractor /99">Green Refractor /99</option>
                                                        <option value="F1 75th Anniversary Refractor /75">F1 75th Anniversary Refractor /75</option>
                                                        <option value="Gold Refractor /50">Gold Refractor /50</option>
                                                        <option value="Orange Refractor /25">Orange Refractor /25</option>
                                                        <option value="Black Refractor /10">Black Refractor /10</option>
                                                        <option value="Red Refractor /5">Red Refractor /5</option>
                                                    </optgroup>
                                                    <optgroup label="Checker Flag Parallels">
                                                        <option value="Checker Flag">Checker Flag</option>
                                                        <option value="Pink Checker Flag /250">Pink Checker Flag /250</option>
                                                        <option value="Aqua Checker Flag /199">Aqua Checker Flag /199</option>
                                                        <option value="Blue Checker Flag /150">Blue Checker Flag /150</option>
                                                        <option value="Green Checker Flag /99">Green Checker Flag /99</option>
                                                        <option value="Gold Checker Flag /50">Gold Checker Flag /50</option>
                                                        <option value="Orange Checker Flag /25">Orange Checker Flag /25</option>
                                                        <option value="Black Checker Flag /10">Black Checker Flag /10</option>
                                                        <option value="Red Checker Flag /5">Red Checker Flag /5</option>
                                                    </optgroup>
                                                    <optgroup label="RayWave Parallels">
                                                        <option value="B&W RayWave">B&W RayWave</option>
                                                        <option value="Pink RayWave /250">Pink RayWave /250</option>
                                                        <option value="Aqua RayWave /199">Aqua RayWave /199</option>
                                                        <option value="Blue RayWave /150">Blue RayWave /150</option>
                                                        <option value="Forest Green RayWave /140">Forest Green RayWave /140</option>
                                                        <option value="Green RayWave /99">Green RayWave /99</option>
                                                        <option value="Gold RayWave /50">Gold RayWave /50</option>
                                                        <option value="Orange RayWave /25">Orange RayWave /25</option>
                                                        <option value="Black RayWave /10">Black RayWave /10</option>
                                                        <option value="Red RayWave /5">Red RayWave /5</option>
                                                    </optgroup>
                                                    <optgroup label="Lazer & Special">
                                                        <option value="B&W Lazer">B&W Lazer</option>
                                                        <option value="SuperFractor 1/1">SuperFractor 1/1</option>
                                                        <option value="Logofractor">Logofractor</option>
                                                        <option value="Sapphire Edition">Sapphire Edition</option>
                                                        <option value="Padparadscha Sapphire 1/1">Padparadscha Sapphire 1/1</option>
                                                    </optgroup>
                                                    <optgroup label="Printing Plates">
                                                        <option value="Printing Plate Cyan 1/1">Printing Plate Cyan 1/1</option>
                                                        <option value="Printing Plate Magenta 1/1">Printing Plate Magenta 1/1</option>
                                                        <option value="Printing Plate Yellow 1/1">Printing Plate Yellow 1/1</option>
                                                        <option value="Printing Plate Black 1/1">Printing Plate Black 1/1</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            {/* Subset Filter - Now Second */}
                                            <div>
                                                <label className="text-xs font-semibold text-slate-400 block mb-2">Subset</label>
                                                <select
                                                    className="w-full px-2 py-2 bg-slate-700 border border-slate-600 rounded text-sm"
                                                    title="Filter cards by subset (F1¬Æ Drivers, Inserts, etc.)"
                                                    value={filterSubset}
                                                    onChange={(e) => setFilterSubset(e.target.value)}
                                                >
                                                    <option value="all">All Subsets</option>
                                                    {allSubsets.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </div>
                                            {/* Rookies Filter */}
                                            <div>
                                                <label className="text-xs font-semibold text-slate-400 block mb-2">Card Type</label>
                                                <select
                                                    className="w-full px-2 py-2 bg-slate-700 border border-slate-600 rounded text-sm"
                                                    title="Show all cards or only rookies/veterans"
                                                    value={filterRookie}
                                                    onChange={(e) => setFilterRookie(e.target.value)}
                                                >
                                                    <option value="all">Rookies & Veterans</option>
                                                    <option value="rookie">Rookies Only</option>
                                                    <option value="veteran">Veterans Only</option>
                                                </select>
                                            </div>
                                            {/* Value Filter */}
                                            <div>
                                                <label className="text-xs font-semibold text-slate-400 block mb-2">Value Estimate</label>
                                                <select
                                                    className="w-full px-2 py-2 bg-slate-700 border border-slate-600 rounded text-sm"
                                                    title="Value Estimate ($)"
                                                    value={filterValues.length > 0 ? filterValues[0] : ''}
                                                    onChange={(e) => {
                                                        setFilterValues(e.target.value ? [e.target.value] : []);
                                                    }}
                                                >
                                                    <option value="">All Values</option>
                                                    <option value="$$$$$">$$$$$ (&gt;$500)</option>
                                                    <option value="$$$$">$$$$ ($100-$500)</option>
                                                    <option value="$$$">$$$ ($40-$100)</option>
                                                    <option value="$$">$$ ($5-$40)</option>
                                                    <option value="$">$ (&lt;$5)</option>
                                                </select>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                // DESKTOP: All filters in grid
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <select
                                        className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm"
                                        title="Filter cards by subset (F1¬Æ Drivers, Inserts, etc.)"
                                        value={filterSubset}
                                        onChange={(e) => setFilterSubset(e.target.value)}
                                    >
                                        <option value="all">All Subsets</option>
                                        {allSubsets.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <select
                                        className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm"
                                        title="Filter by variant type"
                                        value={filterVariants.length > 0 ? filterVariants[0] : ''}
                                        onChange={(e) => {
                                            setFilterVariants(e.target.value ? [e.target.value] : []);
                                        }}
                                    >
                                        <option value="">All Variants</option>
                                        <optgroup label="Standard">
                                            <option value="Base">Base</option>
                                            <option value="Refractor">Refractor</option>
                                        </optgroup>
                                        <optgroup label="Numbered Refractors">
                                            <option value="Teal Refractor /299">Teal Refractor /299</option>
                                            <option value="Pink Refractor /250">Pink Refractor /250</option>
                                            <option value="Aqua Refractor /199">Aqua Refractor /199</option>
                                            <option value="Blue Refractor /150">Blue Refractor /150</option>
                                            <option value="Green Refractor /99">Green Refractor /99</option>
                                            <option value="F1 75th Anniversary Refractor /75">F1 75th Anniversary Refractor /75</option>
                                            <option value="Gold Refractor /50">Gold Refractor /50</option>
                                            <option value="Orange Refractor /25">Orange Refractor /25</option>
                                            <option value="Black Refractor /10">Black Refractor /10</option>
                                            <option value="Red Refractor /5">Red Refractor /5</option>
                                        </optgroup>
                                        <optgroup label="Checker Flag Parallels">
                                            <option value="Checker Flag">Checker Flag</option>
                                            <option value="Pink Checker Flag /250">Pink Checker Flag /250</option>
                                            <option value="Aqua Checker Flag /199">Aqua Checker Flag /199</option>
                                            <option value="Blue Checker Flag /150">Blue Checker Flag /150</option>
                                            <option value="Green Checker Flag /99">Green Checker Flag /99</option>
                                            <option value="Gold Checker Flag /50">Gold Checker Flag /50</option>
                                            <option value="Orange Checker Flag /25">Orange Checker Flag /25</option>
                                            <option value="Black Checker Flag /10">Black Checker Flag /10</option>
                                            <option value="Red Checker Flag /5">Red Checker Flag /5</option>
                                        </optgroup>
                                        <optgroup label="RayWave Parallels">
                                            <option value="B&W RayWave">B&W RayWave</option>
                                            <option value="Pink RayWave /250">Pink RayWave /250</option>
                                            <option value="Aqua RayWave /199">Aqua RayWave /199</option>
                                            <option value="Blue RayWave /150">Blue RayWave /150</option>
                                            <option value="Forest Green RayWave /140">Forest Green RayWave /140</option>
                                            <option value="Green RayWave /99">Green RayWave /99</option>
                                            <option value="Gold RayWave /50">Gold RayWave /50</option>
                                            <option value="Orange RayWave /25">Orange RayWave /25</option>
                                            <option value="Black RayWave /10">Black RayWave /10</option>
                                            <option value="Red RayWave /5">Red RayWave /5</option>
                                        </optgroup>
                                        <optgroup label="Lazer & Special">
                                            <option value="B&W Lazer">B&W Lazer</option>
                                            <option value="SuperFractor 1/1">SuperFractor 1/1</option>
                                            <option value="Logofractor">Logofractor</option>
                                            <option value="Sapphire Edition">Sapphire Edition</option>
                                            <option value="Padparadscha Sapphire 1/1">Padparadscha Sapphire 1/1</option>
                                        </optgroup>
                                        <optgroup label="Printing Plates">
                                            <option value="Printing Plate Cyan 1/1">Printing Plate Cyan 1/1</option>
                                            <option value="Printing Plate Magenta 1/1">Printing Plate Magenta 1/1</option>
                                            <option value="Printing Plate Yellow 1/1">Printing Plate Yellow 1/1</option>
                                            <option value="Printing Plate Black 1/1">Printing Plate Black 1/1</option>
                                        </optgroup>
                                    </select>
                                    <select
                                        className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm"
                                        title="Show all cards or only rookies/veterans"
                                        value={filterRookie}
                                        onChange={(e) => setFilterRookie(e.target.value)}
                                    >
                                        <option value="all">Rookies vs Veterans</option>
                                        <option value="rookie">Rookies</option>
                                        <option value="veteran">Veterans</option>
                                    </select>
                                    <select
                                        className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm"
                                        title="Value Estimate ($)"
                                        value={filterValues.length > 0 ? filterValues[0] : ''}
                                        onChange={(e) => {
                                            setFilterValues(e.target.value ? [e.target.value] : []);
                                        }}
                                    >
                                        <option value="">Value Estimate ($)</option>
                                        <option value="$$$$$">$$$$$ (&gt;$500)</option>
                                        <option value="$$$$">$$$$ ($100-$500)</option>
                                        <option value="$$$">$$$ ($40-$100)</option>
                                        <option value="$$">$$ ($5-$40)</option>
                                        <option value="$">$ (&lt;$5)</option>
                                    </select>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            placeholder="Search..."
                                            title="Search by driver name or card number"
                                            className="px-3 py-2 pr-10 bg-slate-800 border border-slate-700 rounded-lg focus:border-blue-500 focus:outline-none text-sm w-full"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                        {searchTerm && (
                                            <button
                                                onClick={() => setSearchTerm('')}
                                                className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors"
                                                title="Clear search"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* All/Owned Toggles - Always Visible at Bottom of Header */}
                            <div className={`flex items-center justify-between ${isMobile ? 'mt-3 pt-2 border-t border-slate-700' : 'mt-4 pt-3 border-t border-slate-700'}`}>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setShowOwnedOnly(false)}
                                        className={`px-3 py-1 rounded text-xs font-semibold transition-colors ${
                                            !showOwnedOnly 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        All
                                    </button>
                                    <button
                                        onClick={() => setShowOwnedOnly(true)}
                                        className={`px-3 py-1 rounded text-xs font-semibold transition-colors ${
                                            showOwnedOnly 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        Owned
                                    </button>
                                </div>

                                {/* Card Count Text */}
                                <div className="text-slate-400 text-sm">
                                    {showOwnedOnly ? (
                                        (() => {
                                            const ownedInSubset = filteredCards.filter(card => getTotalCount(card.num) > 0).length;
                                            // Calculate total unique cards in selected subset (or entire collection if "all")
                                            const totalInSubset = filterSubset === 'all' 
                                                ? cardData.length  // Total unique cards in entire collection
                                                : cardData.filter(card => card.subset === filterSubset).length;  // Total unique cards in selected subset
                                            return `Showing ${ownedInSubset} of ${totalInSubset} cards`;
                                        })()
                                    ) : (
                                        `Showing ${filteredCards.length} cards`
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className={`${isMobile ? 'p-3 pb-24 pt-4' : 'max-w-7xl mx-auto p-4 pt-64'}`}>
                        {/* Card Grid with page numbers and separators every 12 cards */}
                        <div className="space-y-6">
                            {Array.from({ length: Math.ceil(filteredCards.length / 12) }).map((_, groupIndex) => {
                                const startIdx = groupIndex * 12;
                                const groupCards = filteredCards.slice(startIdx, startIdx + 12);
                                const startCardNum = startIdx + 1;
                                const endCardNum = Math.min(startIdx + 12, filteredCards.length);
                                
                                return (
                                    <div key={groupIndex}>
                                        <div className="page-container flex items-start">
                                            {/* Large page number in left margin with long-press menu */}
                                            <div 
                                                className="page-number flex-shrink-0 relative"
                                                title="Long-press to jump to any page"
                                                onMouseDown={() => {
                                                    const pressTimer = setTimeout(() => {
                                                        // Show page selection menu
                                                        const pageCount = Math.ceil(filteredCards.length / 12);
                                                        const pageMenuItems = Array.from({length: pageCount}).map((_, i) => `
                                                            <div class="page-menu-item" data-page="${i}" style="${i === groupIndex ? 'background: #1e40af; color: white; font-weight: bold;' : 'background: #1e293b;'}">
                                                                Page ${i + 1}
                                                            </div>
                                                        `).join('');
                                                        
                                                        const menuHtml = `
                                                            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;" id="pageMenuOverlay">
                                                                <div style="position: fixed; left: 80px; top: 280px; background: #1e293b; border: 1px solid #475569; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; max-height: 400px; overflow-y: auto; min-width: 130px;" id="pageMenu">
                                                                    ${pageMenuItems}
                                                                </div>
                                                            </div>
                                                        `;
                                                        document.body.insertAdjacentHTML('beforeend', menuHtml);
                                                        
                                                        // Add event listeners to menu items
                                                        document.querySelectorAll('.page-menu-item').forEach(item => {
                                                            item.addEventListener('click', function(e) {
                                                                e.stopPropagation();
                                                                const pageNum = parseInt(this.dataset.page);
                                                                const pageElements = document.querySelectorAll('.page-container');
                                                                if (pageElements[pageNum]) {
                                                                    pageElements[pageNum].scrollIntoView({behavior: 'smooth', block: 'start'});
                                                                }
                                                                document.getElementById('pageMenuOverlay')?.remove();
                                                            });
                                                        });
                                                        
                                                        // Close menu on overlay click
                                                        document.getElementById('pageMenuOverlay')?.addEventListener('click', (e) => {
                                                            if (e.target.id === 'pageMenuOverlay') document.getElementById('pageMenuOverlay')?.remove();
                                                        });
                                                    }, 500);
                                                    
                                                    const cleanup = () => clearTimeout(pressTimer);
                                                    document.addEventListener('mouseup', cleanup, {once: true});
                                                }}
                                            >
                                                Page {groupIndex + 1}
                                            </div>
                                            
                                            <div className="flex-1">
                                            <div className="card-grid mb-4">
                                                {groupCards.map(card => {
                                                    const totalCount = getTotalCount(card.num);
                                                    const hasCard = totalCount > 0;
                                                    const variantBreakdown = getVariantBreakdown(card.num);
                                                    const cardKey = getCardKey(card.num);
                                                    const cardInventory = collection[cardKey] || {};
                                                    const analyses = cardInventory._analyses || {};

                                                    return (
                                                        <div
                                                            key={card.num}
                                                            className={`bg-slate-800/50 rounded-xl p-4 border-2 cursor-pointer hover:scale-105 transition-all relative ${
                                                                hasCard ? 'border-green-500 shadow-lg shadow-green-500/20' : 'border-slate-700'
                                                            }`}
                                                            onClick={() => setSelectedCard(card)}
                                                        >
                                                            <div className="mb-2">
                                                                <div className="flex items-center gap-2 mb-1">
                                                                    <span className="text-lg font-bold text-blue-400">#{card.num}</span>
                                                                    <span className="text-lg font-semibold text-white line-clamp-1 flex-1">{card.name}</span>
                                                                    {card.rookie && (
                                                                        <span className="bg-yellow-500 text-black text-xs px-2 py-0.5 rounded-full font-bold" title="Rookie Card - Driver's first official trading card">RC</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            {card.team && <p className="text-xs text-slate-400 mb-2 line-clamp-1">{card.team}</p>}
                                                            <p className="text-xs text-slate-500 bg-slate-900/50 px-2 py-1 rounded mb-3">{card.subset}</p>
                                                            
                                                            {/* Variant breakdown without analysis on main page */}
                                                            {hasCard && (
                                                                <div className="mb-2">
                                                                    {(() => {
                                                                        // Sort variants by PSA 10 max value in ascending order (highest value first)
                                                                        const sortedVariants = [...variantBreakdown].sort((a, b) => {
                                                                            const aAnalyses = analyses[a.variant] || [];
                                                                            const bAnalyses = analyses[b.variant] || [];
                                                                            
                                                                            let aValue = 0;
                                                                            let bValue = 0;
                                                                            
                                                                            if (aAnalyses.length > 0) {
                                                                                const aValues = extractValueEstimates(aAnalyses[aAnalyses.length - 1].analysis);
                                                                                if (aValues && aValues.psa10 !== 'N/A') {
                                                                                    const aMatch = aValues.psa10.match(/\$?([\d,]+)-\$?([\d,]+)/);
                                                                                    if (aMatch) {
                                                                                        aValue = parseInt(aMatch[2].replace(/,/g, ''));
                                                                                    }
                                                                                }
                                                                            }
                                                                            
                                                                            if (bAnalyses.length > 0) {
                                                                                const bValues = extractValueEstimates(bAnalyses[bAnalyses.length - 1].analysis);
                                                                                if (bValues && bValues.psa10 !== 'N/A') {
                                                                                    const bMatch = bValues.psa10.match(/\$?([\d,]+)-\$?([\d,]+)/);
                                                                                    if (bMatch) {
                                                                                        bValue = parseInt(bMatch[2].replace(/,/g, ''));
                                                                                    }
                                                                                }
                                                                            }
                                                                            
                                                                            return bValue - aValue; // Descending (highest value first)
                                                                        });
                                                                        
                                                                        // Find the most expensive variant by Raw max value
                                                                        let mostExpensiveVariant = null;
                                                                        let maxRawValue = 0;
                                                                        
                                                                        variantBreakdown.forEach(v => {
                                                                            const variantAnalyses = analyses[v.variant] || [];
                                                                            if (variantAnalyses.length > 0) {
                                                                                const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                                                                                const values = extractValueEstimates(latestAnalysis.analysis);
                                                                                if (values && values.raw !== 'N/A') {
                                                                                    const rawMatch = values.raw.match(/\$?([\d,]+)-\$?([\d,]+)/);
                                                                                    if (rawMatch) {
                                                                                        const rawMax = parseInt(rawMatch[2].replace(/,/g, ''));
                                                                                        if (rawMax > maxRawValue) {
                                                                                            maxRawValue = rawMax;
                                                                                            mostExpensiveVariant = v.variant;
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        });
                                                                        
                                                                        return sortedVariants.map((v, idx) => {
                                                                            const isExpensive = v.variant === mostExpensiveVariant;
                                                                            
                                                                            return (
                                                                                <div key={idx} className="mb-2">
                                                                                    <div className={`flex items-center justify-between bg-slate-900/30 rounded px-2 py-1 ${isExpensive ? 'ring-2 ring-green-700' : ''}`}>
                                                                                        <div className="flex items-center gap-2">
                                                                                            <div
                                                                                                className={`relative w-7 h-7 rounded-full shadow-sm overflow-hidden ${!v.style.svg ? v.style.bg : ''}`}
                                                                                                title={v.variant}
                                                                                            >
                                                                                                {v.style.svg ? (
                                                                                                    renderCheckerBadge(v.style, v.style.text)
                                                                                                ) : (
                                                                                                    <div className="flex items-center justify-center w-full h-full text-white text-xs font-bold">
                                                                                                        {v.style.text}
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                            <span className="text-xs text-slate-300">{v.variant}</span>
                                                                                        </div>
                                                                                        <span className="text-xs font-bold text-green-400" title="Number of this variant in your collection">√ó{v.count}</span>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        });
                                                                    })()}
                                                                </div>
                                                            )}
                                                            
                                                            {/* Value Estimates Below Variants - Most Expensive Variant */}
                                                            {hasCard && (() => {
                                                                // Find the most expensive variant by Raw max value
                                                                let mostExpensiveVariant = null;
                                                                let maxRawValue = 0;
                                                                let mostExpensiveValues = null;
                                                                
                                                                variantBreakdown.forEach(v => {
                                                                    const variantAnalyses = analyses[v.variant] || [];
                                                                    if (variantAnalyses.length > 0) {
                                                                        const latestAnalysis = variantAnalyses[variantAnalyses.length - 1];
                                                                        const values = extractValueEstimates(latestAnalysis.analysis);
                                                                        if (values && values.raw !== 'N/A') {
                                                                            const rawMatch = values.raw.match(/\$?([\d,]+)-\$?([\d,]+)/);
                                                                            if (rawMatch) {
                                                                                const rawMax = parseInt(rawMatch[2].replace(/,/g, ''));
                                                                                if (rawMax > maxRawValue) {
                                                                                    maxRawValue = rawMax;
                                                                                    mostExpensiveVariant = v.variant;
                                                                                    mostExpensiveValues = values;
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                });
                                                                
                                                                if (!mostExpensiveValues) return null;
                                                                
                                                                return (
                                                                    <div className="mt-3 flex items-center gap-3 justify-between">
                                                                        <div className="flex items-center gap-3">
                                                                            {/* $ Indicator - Vertically Centered */}
                                                                            <span className="text-lg font-bold text-green-400" style={{textShadow: '0 0 10px rgba(34, 197, 94, 0.5)'}} title="Estimated total collection value (Raw max values): $ = <$5, $$ = $5-40, $$$ = $40-100, $$$$ = $100-500, $$$$$ = >$500">
                                                                                {calculateCardValue(card.num)}
                                                                            </span>
                                                                            
                                                                            {/* Value Box */}
                                                                            <div className="text-xs space-y-0.5 bg-slate-900/80 rounded px-2 py-1 ring-2 ring-green-700">
                                                                                <div className="text-slate-300" title="Most expensive variant - Raw value range">Raw: {mostExpensiveValues.raw}</div>
                                                                                <div className="text-blue-400" title="Most expensive variant - PSA 9 value range">PSA 9: {mostExpensiveValues.psa9}</div>
                                                                                <div className="text-yellow-400" title="Most expensive variant - PSA 10 value range">PSA 10: {mostExpensiveValues.psa10}</div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* Count Badge - Same Row */}
                                                                        <span className="bg-green-500 text-white text-sm px-3 py-1.5 rounded-full font-bold shadow-lg" title="Total number of this card in your collection">
                                                                            {totalCount}
                                                                        </span>
                                                                    </div>
                                                                );
                                                            })()}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        
                                        {/* Horizontal separator between pages */}
                                        {groupIndex < Math.ceil(filteredCards.length / 12) - 1 && (
                                            <div className="my-9 relative">
                                                <div className="absolute inset-0 flex items-center">
                                                    <div className="w-full border-t-4 border-slate-700"></div>
                                                </div>
                                                <div className="relative flex justify-center page-divider">
                                                    <span className="bg-slate-900 px-4 py-1 text-xs text-slate-500 font-semibold">
                                                        Page {groupIndex + 1} / {Math.ceil(filteredCards.length / 12)}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Hidden import input - referenced by hamburger menu */}
                        <input
                            ref={importInputRef}
                            type="file"
                            accept=".json"
                            onChange={importCollection}
                            className="hidden"
                        />

                        {/* Right Sidebar - Fixed buttons at bottom */}
                        {/* AI Scanner & Dashboard - Bottom Right */}
                        <div className={`fixed ${isMobile ? 'bottom-4 left-4 right-4' : 'bottom-6 right-6'} z-40 ${isMobile ? 'flex gap-2' : 'flex flex-col gap-3'}`}>
                            <button
                                onClick={() => setShowImageUpload(true)}
                                disabled={!serverOnline}
                                title={serverOnline ? "Open AI Scanner to analyze card images (upload front and back)" : "Server offline - start server to enable AI scanning"}
                                className={`bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-semibold shadow-lg disabled:opacity-50 flex flex-col items-center justify-center gap-2 transition-all ${isMobile ? 'flex-1 py-3' : 'px-4 py-3 w-24'}`}
                                style={isMobile ? {height: '60px'} : {height: '60px'}}
                            >
                                <span className={isMobile ? 'text-3xl' : 'text-2xl'}>üì∑</span>
                                <span className={isMobile ? 'text-xs' : 'text-sm'}>Scanner</span>
                                {!serverOnline && <span className="text-xs text-red-300">Offline</span>}
                            </button>

                            {/* Dashboard Button */}
                            <a 
                                href="dashboard.html" 
                                className={`bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold shadow-lg flex flex-col items-center justify-center gap-2 transition-all ${isMobile ? 'flex-1 py-3' : 'px-4 py-3 w-24'}`}
                                style={isMobile ? {height: '60px'} : {height: '60px'}}
                                title="View your collection dashboard and analytics"
                            >
                                <span className={isMobile ? 'text-2xl' : 'text-2xl'}>üìä</span>
                                <span className={isMobile ? 'text-xs' : 'text-sm'}>Dashboard</span>
                            </a>
                        </div>

                        {selectedCard && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => {
                                setSelectedCard(null);
                                setCardDetailEdit(null);
                                setOriginalCardDetail(null);
                            }}>
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full max-h-[95vh]' : 'max-w-4xl w-full max-h-[90vh]'} overflow-y-auto scrollbar-hide`} onClick={(e) => e.stopPropagation()}>
                                    <div className={`flex ${isMobile ? 'flex-col gap-4' : 'justify-between items-start'} mb-6`}>
                                        <div className="flex-1">
                                            <h2 className={`${isMobile ? 'text-2xl' : 'text-3xl'} font-bold mb-2`}>#{selectedCard.num} {selectedCard.name}</h2>
                                            {selectedCard.team && <p className="text-slate-400 text-sm">{selectedCard.team}</p>}
                                            <p className="text-xs text-slate-500">{selectedCard.subset}</p>
                                        </div>
                                        <div className={`flex ${isMobile ? 'w-full gap-2' : 'gap-2 items-start'}`}>
                                            <button 
                                                onClick={() => {
                                                    // Save changes
                                                    if (cardDetailEdit) {
                                                        saveCollection(collection);
                                                    }
                                                    setCardDetailEdit(null);
                                                    setOriginalCardDetail(null);
                                                    setSelectedCard(null);
                                                }}
                                                title="Save changes and close"
                                                className={`bg-green-600 hover:bg-green-700 rounded-lg font-semibold ${isMobile ? 'flex-1 py-3 text-base' : 'px-4 py-2 text-sm'}`}
                                            >
                                                ‚úì Done
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    // Cancel changes and restore original
                                                    if (originalCardDetail) {
                                                        // Restore original data
                                                        const key = getCardKey(selectedCard.num);
                                                        const newCollection = { ...collection };
                                                        newCollection[key] = originalCardDetail;
                                                        setCollection(newCollection);
                                                        saveCollection(newCollection);
                                                    }
                                                    setCardDetailEdit(null);
                                                    setOriginalCardDetail(null);
                                                    setSelectedCard(null);
                                                }}
                                                title="Discard changes and close"
                                                className={`bg-red-600 hover:bg-red-700 rounded-lg font-semibold ${isMobile ? 'flex-1 py-3 text-base' : 'px-4 py-2 text-sm'}`}
                                            >
                                                ‚úï Cancel
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-xl font-semibold mb-4">Inventory</h3>
                                        <div className="space-y-2">
                                            {(() => {
                                                const cardKey = getCardKey(selectedCard.num);
                                                const cardInventory = collection[cardKey] || {};
                                                // Get variants that actually exist in the collection for this card
                                                const existingVariants = Object.keys(cardInventory)
                                                    .filter(key => !key.startsWith('_') && cardInventory[key] > 0)
                                                    .sort((a, b) => OFFICIAL_VARIANTS.indexOf(a) - OFFICIAL_VARIANTS.indexOf(b));
                                                
                                                return existingVariants.map(variant => {
                                                    const count = cardInventory[variant] || 0;
                                                    const analyses = cardInventory._analyses || {};
                                                    const variantAnalyses = analyses[variant] || [];
                                                    const latestAnalysis = variantAnalyses.length > 0 ? variantAnalyses[variantAnalyses.length - 1] : null;
                                                    const isAnalyzing = analyzingCards[`${selectedCard.num}-${variant}`];
                                                    
                                                    return (
                                                        <div key={variant} className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                                            <div className="flex items-center justify-between mb-2">
                                                                <span className="text-sm font-medium">{variant}</span>
                                                                <div className="flex items-center gap-4">
                                                                    <button
                                                                        onClick={() => {
                                                                            // Track original state before first change
                                                                            if (!originalCardDetail) {
                                                                                const key = getCardKey(selectedCard.num);
                                                                                setOriginalCardDetail(JSON.parse(JSON.stringify(collection[key])));
                                                                            }
                                                                            setCardDetailEdit(true);
                                                                            removeCard(selectedCard.num, variant);
                                                                        }}
                                                                        disabled={count === 0}
                                                                        title="Remove one card from collection"
                                                                        className={`bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-30 font-bold ${isMobile ? 'w-12 h-12 text-lg' : 'w-10 h-10'}`}
                                                                    >‚àí</button>
                                                                    <span className={`text-center font-bold text-green-400 ${isMobile ? 'text-xl' : 'text-lg'}`} title="Number of this variant in your collection">{count}</span>
                                                                    <button
                                                                        onClick={() => {
                                                                            // Track original state before first change
                                                                            if (!originalCardDetail) {
                                                                                const key = getCardKey(selectedCard.num);
                                                                                setOriginalCardDetail(JSON.parse(JSON.stringify(collection[key] || {})));
                                                                            }
                                                                            setCardDetailEdit(true);
                                                                            addCard(selectedCard.num, variant);
                                                                        }}
                                                                        title="Add one card to collection"
                                                                        className={`bg-green-600 hover:bg-green-700 rounded-lg font-bold ${isMobile ? 'w-12 h-12 text-lg' : 'w-10 h-10'}`}
                                                                    >+</button>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Show analysis if available */}
                                                            {isAnalyzing && (
                                                                <div className="mt-2 text-xs text-slate-400 italic">
                                                                    ‚ü≥ Analyzing value...
                                                                </div>
                                                            )}
                                                            
                                                            {latestAnalysis && !isAnalyzing && count > 0 && (
                                                                <div className="mt-2 bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <button 
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                const collapseKey = `analysis-${selectedCard.num}-${variant}`;
                                                                                setCollapsedSections(prev => ({...prev, [collapseKey]: !prev[collapseKey]}));
                                                                            }}
                                                                            className="font-semibold text-blue-400 text-sm flex items-center gap-1 hover:text-blue-300 transition-colors"
                                                                        >
                                                                            üíé Card Value Analysis
                                                                            <span className="text-xs">{collapsedSections[`analysis-${selectedCard.num}-${variant}`] ? '‚ñº' : '‚ñ≤'}</span>
                                                                        </button>
                                                                        <div className="flex gap-1">
                                                                            <button
                                                                                onClick={async (e) => {
                                                                                    e.stopPropagation();
                                                                                    const analyzeKey = `${selectedCard.num}-${variant}`;
                                                                                    setAnalyzingCards(prev => ({ ...prev, [analyzeKey]: true }));
                                                                                    
                                                                                    try {
                                                                                        const newAnalysis = await reanalyzeCardValue(selectedCard.num, variant, 'claude-3-5-sonnet-20241022');
                                                                                        
                                                                                        if (newAnalysis) {
                                                                                            const key = getCardKey(selectedCard.num);
                                                                                            const updatedCollection = { ...collection };
                                                                                            if (!updatedCollection[key]._analyses) updatedCollection[key]._analyses = {};
                                                                                            if (!updatedCollection[key]._analyses[variant]) updatedCollection[key]._analyses[variant] = [];
                                                                                            updatedCollection[key]._analyses[variant].push({
                                                                                                id: Date.now(),
                                                                                                addedDate: new Date().toISOString(),
                                                                                                analysis: newAnalysis
                                                                                            });
                                                                                            setCollection(updatedCollection);
                                                                                            saveCollection(updatedCollection);
                                                                                        }
                                                                                    } catch (error) {
                                                                                        console.error('Analysis error:', error);
                                                                                    } finally {
                                                                                        setAnalyzingCards(prev => {
                                                                                            const updated = { ...prev };
                                                                                            delete updated[analyzeKey];
                                                                                            return updated;
                                                                                        });
                                                                                    }
                                                                                }}
                                                                                disabled={isAnalyzing}
                                                                                className="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded font-semibold disabled:opacity-50"
                                                                                title="Reanalyze with Sonnet model"
                                                                            >
                                                                                {isAnalyzing ? '‚ü≥' : '‚ö°'}
                                                                            </button>
                                                                            <button
                                                                                onClick={async (e) => {
                                                                                    e.stopPropagation();
                                                                                    const analyzeKey = `${selectedCard.num}-${variant}`;
                                                                                    setAnalyzingCards(prev => ({ ...prev, [analyzeKey]: true }));
                                                                                    
                                                                                    try {
                                                                                        const newAnalysis = await reanalyzeCardValue(selectedCard.num, variant, 'claude-3-opus-20240229');
                                                                                        
                                                                                        if (newAnalysis) {
                                                                                            const key = getCardKey(selectedCard.num);
                                                                                            const updatedCollection = { ...collection };
                                                                                            if (!updatedCollection[key]._analyses) updatedCollection[key]._analyses = {};
                                                                                            if (!updatedCollection[key]._analyses[variant]) updatedCollection[key]._analyses[variant] = [];
                                                                                            updatedCollection[key]._analyses[variant].push({
                                                                                                id: Date.now(),
                                                                                                addedDate: new Date().toISOString(),
                                                                                                analysis: newAnalysis
                                                                                            });
                                                                                            setCollection(updatedCollection);
                                                                                            saveCollection(updatedCollection);
                                                                                        }
                                                                                    } catch (error) {
                                                                                        console.error('Analysis error:', error);
                                                                                    } finally {
                                                                                        setAnalyzingCards(prev => {
                                                                                            const updated = { ...prev };
                                                                                            delete updated[analyzeKey];
                                                                                            return updated;
                                                                                        });
                                                                                    }
                                                                                }}
                                                                                disabled={isAnalyzing}
                                                                                className="bg-purple-600 hover:bg-purple-700 text-white text-xs px-2 py-1 rounded font-semibold disabled:opacity-50"
                                                                                title="Reanalyze with Opus model"
                                                                            >
                                                                                {isAnalyzing ? '‚ü≥' : 'üîç'}
                                                                            </button>
                                                                            <button
                                                                                onClick={async (e) => {
                                                                                    e.stopPropagation();
                                                                                    const analyzeKey = `${selectedCard.num}-${variant}`;
                                                                                    setAnalyzingCards(prev => ({ ...prev, [analyzeKey]: true }));
                                                                                    
                                                                                    try {
                                                                                        await performQuickGradeForVariant(selectedCard.num, variant);
                                                                                    } catch (error) {
                                                                                        console.error('Quick grade error:', error);
                                                                                    } finally {
                                                                                        setAnalyzingCards(prev => {
                                                                                            const updated = { ...prev };
                                                                                            delete updated[analyzeKey];
                                                                                            return updated;
                                                                                        });
                                                                                    }
                                                                                }}
                                                                                disabled={isAnalyzing}
                                                                                className="bg-amber-600 hover:bg-amber-700 text-white text-xs px-2 py-1 rounded font-semibold disabled:opacity-50"
                                                                                title="Quick Grade this variant"
                                                                            >
                                                                                {isAnalyzing ? '‚ü≥' : 'üìä'}
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    {!collapsedSections[`analysis-${selectedCard.num}-${variant}`] && (
                                                                        <>
                                                                            <div className="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">{latestAnalysis.analysis}</div>
                                                                            <div className="text-xs text-slate-500 mt-2">
                                                                                Added: {new Date(latestAnalysis.addedDate).toLocaleDateString()}
                                                                            </div>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            )}

                                                        {/* Quick Grade Assessment Section */}
                                                        {variant && collection[getCardKey(selectedCard.num)]?._gradeReports?.[variant] && (
                                                            <div className="mt-2 bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <button 
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            const collapseKey = `grade-${selectedCard.num}-${variant}`;
                                                                            setCollapsedSections(prev => ({...prev, [collapseKey]: !prev[collapseKey]}));
                                                                        }}
                                                                        className="font-semibold text-blue-400 text-sm flex items-center gap-1 hover:text-blue-300 transition-colors"
                                                                    >
                                                                        üìä Quick Grade Assessment
                                                                        <span className="text-xs">{collapsedSections[`grade-${selectedCard.num}-${variant}`] ? '‚ñº' : '‚ñ≤'}</span>
                                                                    </button>
                                                                </div>
                                                                {!collapsedSections[`grade-${selectedCard.num}-${variant}`] && (
                                                                    <div className="text-slate-300 leading-relaxed">
                                                                        {formatQuickGradeReport(collection[getCardKey(selectedCard.num)]._gradeReports[variant])}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                                });
                                            })()}
                                        </div>

                                        {/* Add a Card Button */}
                                        <div className="mt-4 mb-2">
                                            <button
                                                onClick={async () => {
                                                    const cardNum = selectedCard.num.toString();
                                                    setManualCardData({ 
                                                        cardNumber: cardNum, 
                                                        variant: 'Base', 
                                                        serialNumber: '',
                                                        cardTitle: '',
                                                        driverName: '',
                                                        value: ''
                                                    });
                                                    setShowAddCardManual(true);
                                                    
                                                    // Fetch card details in the background
                                                    const details = await lookupCardDetails(cardNum);
                                                    if (details) {
                                                        setManualCardData(prev => ({
                                                            ...prev,
                                                            cardTitle: details.cardTitle || '',
                                                            driverName: details.driverName || '',
                                                            value: details.value || ''
                                                        }));
                                                    }
                                                }}
                                                className="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-3 px-4 rounded-lg font-semibold text-sm transition-all shadow-lg"
                                            >
                                                ‚ûï Add a Card
                                            </button>
                                        </div>

                                        {/* Add New Variant Section */}
                                        <div className="mt-6 pt-6 border-t border-slate-700">
                                            <h4 className="text-sm font-semibold text-slate-300 mb-3">‚ûï Add New Card Variant</h4>
                                            <p className="text-xs text-slate-400 mb-3">Don't see a variant you want to add? Select from the list below:</p>
                                            <select
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none mb-3"
                                                title="Select a variant to add"
                                                onChange={(e) => {
                                                    if (e.target.value) {
                                                        // Track original state before first change
                                                        if (!originalCardDetail) {
                                                            const key = getCardKey(selectedCard.num);
                                                            setOriginalCardDetail(JSON.parse(JSON.stringify(collection[key] || {})));
                                                        }
                                                        setCardDetailEdit(true);
                                                        addCard(selectedCard.num, e.target.value);
                                                        e.target.value = '';  // Reset dropdown
                                                    }
                                                }}
                                                defaultValue=""
                                            >
                                                <option value="">Select a variant...</option>
                                                {(() => {
                                                    const cardKey = getCardKey(selectedCard.num);
                                                    const cardInventory = collection[cardKey] || {};
                                                    return OFFICIAL_VARIANTS
                                                        .filter(v => !(cardInventory[v] > 0))  // Only show variants not in collection
                                                        .map(variant => (
                                                            <option key={variant} value={variant}>{variant}</option>
                                                        ));
                                                })()}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showImageUpload && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50"
                                onClick={() => {
                                    setShowImageUpload(false);
                                    setUploadedImages([]);
                                    setPendingImages([]);
                                    setShowSecondImagePrompt(false);
                                    setRecognizedCard(null);
                                    setEditedCard(null);
                                    setIsEditing(false);
                                    setRecognitionError(null);
                                    setDeepAnalysis(null);
                                    setSelectedAnalysisSource('opus');
                                }}>
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full max-h-[95vh]' : 'max-w-4xl w-full max-h-[90vh]'} overflow-y-auto scrollbar-hide`} onClick={(e) => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">üì∑ AI Scanner</h2>
                                        <button
                                            onClick={() => {
                                                setShowImageUpload(false);
                                                setUploadedImages([]);
                                                setPendingImages([]);
                                                setShowSecondImagePrompt(false);
                                                setRecognizedCard(null);
                                                setEditedCard(null);
                                                setIsEditing(false);
                                                setRecognitionError(null);
                                                setDeepAnalysis(null);
                                                setSelectedAnalysisSource('opus');
                                            }}
                                            className="bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold px-4 py-2 text-sm"
                                            title="Close scanner"
                                        >
                                            ‚úï Cancel
                                        </button>
                                    </div>
                                    <input ref={fileInputRef} type="file" accept="image/*" capture="environment" onChange={handleImageUpload} multiple className="hidden" />
                                    
                                    <>
                                    {!uploadedImages || uploadedImages.length === 0 && !recognizedCard ? (
                                        <>
                                            <button onClick={() => fileInputRef.current?.click()} className={`w-full border-2 border-dashed border-slate-600 rounded-xl flex flex-col items-center justify-center hover:border-blue-500 transition-colors bg-slate-900/50 ${isMobile ? 'h-48' : 'h-80'}`}>
                                                <span className={`text-slate-300 mb-3 font-semibold ${isMobile ? 'text-sm' : 'text-base'}`}>üì∏ Upload Card Images</span>
                                                <span className="text-7xl mb-3">üì∑</span>
                                                <span className="text-slate-400 text-sm text-center px-4 font-semibold">Upload BOTH front and back images</span>
                                                <span className="text-slate-500 text-xs text-center px-4 mt-2">The back image's card number guides AI analysis</span>
                                            </button>
                                            <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mt-4">
                                                <p className="text-sm font-semibold text-blue-400 mb-2">
                                                    ‚ú® How to Get Best Results:
                                                </p>
                                                <ul className="text-xs text-slate-300 space-y-1">
                                                    <li>‚úì <strong>Upload 2 images:</strong> First the front, then the back</li>
                                                    <li>‚úì <strong>Back image is crucial:</strong> Contains the card number</li>
                                                    <li>‚úì <strong>Good lighting:</strong> Ensures card details are visible</li>
                                                    <li>‚úì <strong>iPhone users:</strong> Use screenshots (JPG) for instant upload</li>
                                                </ul>
                                            </div>
                                        </>
                                    ) : (!uploadedImages || uploadedImages.length === 0) && recognizedCard ? (
                                        <div className="space-y-4">
                                            <div className="relative bg-slate-900 rounded-xl p-8 flex items-center justify-center h-80">
                                                <div className="text-center">
                                                    <div className="text-8xl mb-4">üèéÔ∏è</div>
                                                    <p className="text-slate-400 text-lg font-semibold">2025 Topps Chrome F1</p>
                                                    <p className="text-slate-500 text-sm mt-2">No image available</p>
                                                    <button 
                                                        onClick={() => fileInputRef.current?.click()} 
                                                        className="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold"
                                                    >
                                                        üì∑ Upload Image
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ) : uploadedImages && uploadedImages.length > 0 ? (
                                        <div className="space-y-4">
                                            {/* Show all uploaded images */}
                                            <div className={`grid ${isMobile ? 'grid-cols-1' : uploadedImages.length > 1 ? 'grid-cols-2' : 'grid-cols-1'} gap-4`}>
                                                {uploadedImages.map((img, idx) => (
                                                    <div key={idx} className="relative group cursor-pointer" onClick={() => {
                                                        setCurrentImageIndex(idx);
                                                        setImageViewerZoom(1);
                                                        setImageViewerPosition({ x: 0, y: 0 });
                                                        setShowImageViewer(true);
                                                    }}>
                                                        <img src={img} alt={`Card image ${idx + 1}`} className="w-full max-h-96 object-contain bg-slate-900 rounded-xl" />
                                                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/50 transition-all rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                            <span className="text-white text-lg font-semibold">üîç Click to enlarge</span>
                                                        </div>
                                                        <div className="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                                            {uploadedImages.length === 2 ? (idx === 0 ? 'Front' : 'Back') : `Image ${idx + 1}/${uploadedImages.length}`}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {isRecognizing && (
                                                <div className="text-center py-8 bg-slate-900/50 rounded-xl">
                                                    <div className="animate-spin text-5xl mb-4">‚ü≥</div>
                                                    <p className="text-slate-300">AI analyzing card...</p>
                                                    <p className="text-xs text-slate-400 mt-2">This may take 5-10 seconds</p>
                                                </div>
                                            )}
                                            
                                            {recognitionError && (
                                                <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                                                    <p className="text-red-300 font-semibold mb-2">Recognition Error</p>
                                                    <p className="text-sm text-red-200 mb-3">{recognitionError}</p>
                                                    <button
                                                        onClick={() => {
                                                            setUploadedImages([]);
                                                            setPendingImages([]);
                                                            setShowSecondImagePrompt(false);
                                                            setRecognitionError(null);
                                                            setDeepAnalysis(null);
                                                            setSelectedAnalysisSource('opus');
                                                        }}
                                                        className="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm mb-2"
                                                    >
                                                        Try Different Photo
                                                    </button>
                                                    <p className="text-xs text-red-300">
                                                        üí° Tips: Ensure card number is clearly visible, good lighting, try a different angle
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    ) : null}
                                    
                                    {recognizedCard && (
                                        <div className="space-y-4">
                                            {/* Action Buttons - Above Card Analyzed Section */}
                                            <div className={isMobile ? 'space-y-2' : 'flex gap-2 flex-wrap'}>
                                                {/* Row 1: Re-analyze + Quick Grade */}
                                                <div className={`flex gap-2 ${isMobile ? 'w-full' : ''}`}>
                                                    <button
                                                        onClick={performDeepAnalysis}
                                                        disabled={isDeepAnalyzing}
                                                        className={`rounded-lg font-semibold bg-purple-600 hover:bg-purple-700 disabled:opacity-50 ${isMobile ? 'flex-1 py-2 text-sm' : 'px-4 py-2 text-sm'}`}
                                                    >
                                                        {isDeepAnalyzing ? '‚ü≥ Analyzing...' : 'üîç Re-analyze'}
                                                    </button>
                                                    <button
                                                        onClick={performQuickGrade}
                                                        disabled={isDeepAnalyzing}
                                                        className={`rounded-lg font-semibold bg-amber-600 hover:bg-amber-700 disabled:opacity-50 ${isMobile ? 'flex-1 py-2 text-sm' : 'px-4 py-2 text-sm'}`}
                                                    >
                                                        {isDeepAnalyzing ? '‚ü≥ Grading...' : 'üìä Grade'}
                                                    </button>
                                                </div>
                                                
                                                {/* Row 2: Edit, Cancel, Add */}
                                                {isMobile && (
                                                    <div className="flex gap-2 w-full">
                                                        <button
                                                            onClick={() => {
                                                                if (isEditing) {
                                                                    handleDoneEditing();
                                                                } else {
                                                                    setIsEditing(true);
                                                                    setEditedCard({...recognizedCard});
                                                                }
                                                            }}
                                                            className={`flex-1 py-2 rounded-lg text-sm font-semibold ${
                                                                isEditing ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'
                                                            }`}
                                                        >
                                                            {isEditing ? '‚úì Done' : '‚úé Edit'}
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setShowImageUpload(false);
                                                                setUploadedImages([]);
                                                                setPendingImages([]);
                                                                setShowSecondImagePrompt(false);
                                                                setRecognizedCard(null);
                                                                setEditedCard(null);
                                                                setIsEditing(false);
                                                                setRecognitionError(null);
                                                                setDeepAnalysis(null);
                                                                setSelectedAnalysisSource('opus');
                                                            }}
                                                            className="flex-1 py-2 rounded-lg text-sm font-semibold bg-slate-600 hover:bg-slate-700"
                                                        >
                                                            ‚úï Cancel
                                                        </button>
                                                        <button
                                                            onClick={handleAddRecognizedCard}
                                                            disabled={addCardCooldown > 0}
                                                            className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                                addCardCooldown > 0 
                                                                    ? 'bg-gray-600 text-gray-300 cursor-not-allowed opacity-50' 
                                                                    : 'bg-green-600 hover:bg-green-700'
                                                            }`}
                                                            title={addCardCooldown > 0 ? `Wait ${addCardCooldown}s before adding another card` : 'Add card to collection'}
                                                        >
                                                            {addCardCooldown > 0 ? `‚è±Ô∏è ${addCardCooldown}s` : '‚úì Add'}
                                                        </button>
                                                    </div>
                                                )}
                                                
                                                {/* Desktop buttons - single row */}
                                                {!isMobile && (
                                                    <>
                                                        <button
                                                            onClick={() => {
                                                                if (isEditing) {
                                                                    handleDoneEditing();
                                                                } else {
                                                                    setIsEditing(true);
                                                                    setEditedCard({...recognizedCard});
                                                                }
                                                            }}
                                                            className={`px-4 py-2 rounded-lg text-sm font-semibold ${
                                                                isEditing ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'
                                                            }`}
                                                        >
                                                            {isEditing ? '‚úì Done' : '‚úé Edit'}
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setShowImageUpload(false);
                                                                setUploadedImages([]);
                                                                setPendingImages([]);
                                                                setShowSecondImagePrompt(false);
                                                                setRecognizedCard(null);
                                                                setEditedCard(null);
                                                                setIsEditing(false);
                                                                setRecognitionError(null);
                                                                setDeepAnalysis(null);
                                                                setSelectedAnalysisSource('opus');
                                                            }}
                                                            className="px-4 py-2 rounded-lg text-sm font-semibold bg-slate-600 hover:bg-slate-700"
                                                        >
                                                            ‚úï Cancel
                                                        </button>
                                                        <button
                                                            onClick={handleAddRecognizedCard}
                                                            disabled={addCardCooldown > 0}
                                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                                addCardCooldown > 0 
                                                                    ? 'bg-gray-600 text-gray-300 cursor-not-allowed opacity-50' 
                                                                    : 'bg-green-600 hover:bg-green-700'
                                                            }`}
                                                            title={addCardCooldown > 0 ? `Wait ${addCardCooldown}s before adding another card` : 'Add card to collection'}
                                                        >
                                                            {addCardCooldown > 0 ? `‚è±Ô∏è Wait ${addCardCooldown}s` : '‚úì Done'}
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                            
                                            <div className="bg-gradient-to-br from-green-900/20 to-blue-900/20 border border-green-500/30 rounded-xl p-5">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h3 className="font-semibold text-lg">‚ú® Card Analyzed</h3>
                                                </div>
                                        
                                        <div className="grid grid-cols-2 gap-3 p-4 bg-slate-900/50 rounded-lg">
                                            <div className={needsVerification(recognizedCard.cardNumberConfidence) ? 'needs-verification rounded p-2' : ''}>
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    Card #
                                                    {needsVerification(recognizedCard.cardNumberConfidence) && (
                                                        <span className="text-yellow-400">‚ö†Ô∏è</span>
                                                    )}
                                                    {recognizedCard._differences?.cardNumber && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <input
                                                        type="text"
                                                        value={editedCard.cardNumber}
                                                        onChange={(e) => {
                                                            const newValue = e.target.value;
                                                            setEditedCard({...editedCard, cardNumber: newValue});
                                                            // Mark as manually entered
                                                            setManualCardNumber(newValue);
                                                        }}
                                                        onBlur={(e) => {
                                                            const newValue = e.target.value;
                                                            if (newValue !== recognizedCard.cardNumber && uploadedImages && !isDeepAnalyzing) {
                                                                // Trigger Opus re-analysis
                                                                setTimeout(() => performDeepAnalysis(), 100);
                                                            }
                                                        }}
                                                        className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1"
                                                    />
                                                ) : (
                                                    <div>
                                                        <p className="font-bold">{recognizedCard.cardNumber}</p>
                                                        {recognizedCard._differences?.cardNumber && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.cardNumber}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.cardNumber}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="bg-yellow-900/20 border border-yellow-500/30 rounded p-2">
                                                <span className="text-xs text-yellow-400 flex items-center gap-1">
                                                    üèÜ Serial #
                                                    {recognizedCard._differences?.serialNumber && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <input
                                                        type="text"
                                                        value={editedCard.serialNumber || ''}
                                                        onChange={(e) => setEditedCard({...editedCard, serialNumber: e.target.value})}
                                                        placeholder="e.g., 63/250 or N/A"
                                                        className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1 text-yellow-300 font-bold"
                                                    />
                                                ) : (
                                                    <div>
                                                        <p className="font-bold text-yellow-300">{recognizedCard.serialNumber || 'N/A'}</p>
                                                        {recognizedCard._differences?.serialNumber && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.serialNumber || 'N/A'}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.serialNumber || 'N/A'}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            <div>
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    Driver
                                                    {recognizedCard._differences?.driverName && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <div className="space-y-2">
                                                        {recognizedCard._differences?.driverName && recognizedCard._opusData ? (
                                                            <div className="space-y-2">
                                                                <div className="text-xs text-slate-400 mb-1">Select detected value:</div>
                                                                <label className="flex items-center gap-2 p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:bg-slate-700">
                                                                    <input
                                                                        type="radio"
                                                                        name="driverName"
                                                                        checked={editedCard.driverName === recognizedCard.driverName}
                                                                        onChange={() => setEditedCard({...editedCard, driverName: recognizedCard.driverName})}
                                                                    />
                                                                    <span className="text-sm">‚ö° Sonnet: {recognizedCard.driverName}</span>
                                                                </label>
                                                                <label className="flex items-center gap-2 p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:bg-slate-700">
                                                                    <input
                                                                        type="radio"
                                                                        name="driverName"
                                                                        checked={editedCard.driverName === recognizedCard._opusData.driverName}
                                                                        onChange={() => setEditedCard({...editedCard, driverName: recognizedCard._opusData.driverName})}
                                                                    />
                                                                    <span className="text-sm">üîç Opus: {recognizedCard._opusData.driverName}</span>
                                                                </label>
                                                                <div className="text-xs text-slate-500">Or type custom:</div>
                                                            </div>
                                                        ) : null}
                                                        <input
                                                            type="text"
                                                            value={editedCard.driverName}
                                                            onChange={(e) => setEditedCard({...editedCard, driverName: e.target.value})}
                                                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1"
                                                        />
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <p className="font-bold">{recognizedCard.driverName}</p>
                                                        {recognizedCard._differences?.driverName && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.driverName}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.driverName}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    Team
                                                    {recognizedCard._differences?.team && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <div className="space-y-2">
                                                        {recognizedCard._differences?.team && recognizedCard._opusData ? (
                                                            <div className="space-y-2">
                                                                <div className="text-xs text-slate-400 mb-1">Select detected value:</div>
                                                                <label className="flex items-center gap-2 p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:bg-slate-700">
                                                                    <input
                                                                        type="radio"
                                                                        name="team"
                                                                        checked={editedCard.team === recognizedCard.team}
                                                                        onChange={() => setEditedCard({...editedCard, team: recognizedCard.team})}
                                                                    />
                                                                    <span className="text-sm">‚ö° Sonnet: {recognizedCard.team}</span>
                                                                </label>
                                                                <label className="flex items-center gap-2 p-2 bg-slate-800 border border-slate-600 rounded cursor-pointer hover:bg-slate-700">
                                                                    <input
                                                                        type="radio"
                                                                        name="team"
                                                                        checked={editedCard.team === recognizedCard._opusData.team}
                                                                        onChange={() => setEditedCard({...editedCard, team: recognizedCard._opusData.team})}
                                                                    />
                                                                    <span className="text-sm">üîç Opus: {recognizedCard._opusData.team}</span>
                                                                </label>
                                                                <div className="text-xs text-slate-500">Or type custom:</div>
                                                            </div>
                                                        ) : null}
                                                        <input
                                                            type="text"
                                                            value={editedCard.team}
                                                            onChange={(e) => setEditedCard({...editedCard, team: e.target.value})}
                                                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1"
                                                        />
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <p className="font-bold">{recognizedCard.team}</p>
                                                        {recognizedCard._differences?.team && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.team}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.team}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    Subset
                                                    {recognizedCard._differences?.subset && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <select
                                                        value={editedCard.subset || ''}
                                                        onChange={async (e) => {
                                                            const newSubset = e.target.value;
                                                            setEditedCard({...editedCard, subset: newSubset});
                                                            
                                                            // Trigger Opus re-analysis when subset changes
                                                            if (uploadedImages && !isDeepAnalyzing) {
                                                                setTimeout(() => performDeepAnalysis(), 100);
                                                            }
                                                        }}
                                                        className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1"
                                                    >
                                                        {/* AI-detected values first if both analyses exist */}
                                                        {recognizedCard.subset && deepAnalysis && recognizedCard._opusData && (
                                                            <>
                                                                <option value={recognizedCard.subset}>‚ö° Sonnet: {recognizedCard.subset}</option>
                                                                <option value={recognizedCard._opusData.subset}>üîç Opus: {recognizedCard._opusData.subset}</option>
                                                                <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                                            </>
                                                        )}
                                                        {allSubsets.map(s => <option key={s} value={s}>{s}</option>)}
                                                    </select>
                                                ) : (
                                                    <div>
                                                        <p className="font-bold">{recognizedCard.subset || 'Unknown'}</p>
                                                        {recognizedCard._differences?.subset && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.subset}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.subset}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-400 flex items-center gap-1">
                                                    Variant
                                                    {recognizedCard._differences?.variant && (
                                                        <span className="text-purple-400" title="Opus updated this value">üîç</span>
                                                    )}
                                                </span>
                                                {isEditing ? (
                                                    <select
                                                        value={editedCard.variant}
                                                        onChange={(e) => setEditedCard({...editedCard, variant: e.target.value})}
                                                        className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mt-1"
                                                    >
                                                        {/* AI-detected values first if both analyses exist */}
                                                        {recognizedCard.variant && deepAnalysis && recognizedCard._opusData && (
                                                            <>
                                                                <option value={recognizedCard.variant}>‚ö° Sonnet: {recognizedCard.variant}</option>
                                                                <option value={recognizedCard._opusData.variant}>üîç Opus: {recognizedCard._opusData.variant}</option>
                                                                <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                                            </>
                                                        )}
                                                        {variants.map(v => <option key={v} value={v}>{v}</option>)}
                                                    </select>
                                                ) : (
                                                    <div>
                                                        <p className="font-bold">{recognizedCard.variant}</p>
                                                        {recognizedCard._differences?.variant && (
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <span className="line-through">Sonnet: {recognizedCard.variant}</span>
                                                                <br/>
                                                                <span className="text-purple-400">Opus: {recognizedCard._opusData.variant}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {(recognizedCard.analysis || deepAnalysis) && (
                                            <div className="mt-4 space-y-4">
                                                {/* Value Estimates Row */}
                                                {(() => {
                                                    const sonnetValues = extractValueEstimates(recognizedCard.analysis);
                                                    const opusValues = extractValueEstimates(deepAnalysis);
                                                    const valuesToShow = selectedAnalysisSource === 'opus' && opusValues ? opusValues : sonnetValues;
                                                    
                                                    return valuesToShow && (
                                                        <div className="bg-gradient-to-r from-green-900/20 to-blue-900/20 border border-green-500/30 rounded-lg p-4">
                                                            <h4 className="font-semibold text-green-400 mb-3 text-center">üí∞ Value Estimates (2025 Topps Chrome F1)</h4>
                                                            <div className={`grid ${isMobile ? 'grid-cols-1' : 'grid-cols-3'} gap-4`}>
                                                                <div className="text-center">
                                                                    <div className="text-xs text-slate-400 mb-1">Raw</div>
                                                                    <div className="text-xl font-bold text-green-400">{valuesToShow.raw}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-xs text-slate-400 mb-1">PSA 9</div>
                                                                    <div className="text-xl font-bold text-blue-400">{valuesToShow.psa9}</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="text-xs text-slate-400 mb-1">PSA 10</div>
                                                                    <div className="text-xl font-bold text-purple-400">{valuesToShow.psa10}</div>
                                                                </div>
                                                            </div>
                                                            {deepAnalysis && (
                                                                <div className="mt-3 text-xs text-center text-slate-400">
                                                                    Using {selectedAnalysisSource === 'opus' ? '(Opus)' : '(Sonnet)'} analysis values
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })()}
                                                
                                                {/* Analysis Source Selection (only show if both exist) */}
                                                {recognizedCard.analysis && deepAnalysis && (
                                                    <div className="flex gap-2 justify-center">
                                                        <span className="text-sm text-slate-400 self-center">Use analysis from:</span>
                                                        <button
                                                            onClick={() => setSelectedAnalysisSource('opus')}
                                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                                selectedAnalysisSource === 'opus' 
                                                                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50' 
                                                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                            }`}
                                                        >
                                                            ‚ö° Opus
                                                        </button>
                                                        <button
                                                            onClick={() => setSelectedAnalysisSource('sonnet')}
                                                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                                selectedAnalysisSource === 'sonnet' 
                                                                    ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/50' 
                                                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                            }`}
                                                        >
                                                            üîç Sonnet
                                                        </button>
                                                    </div>
                                                )}
                                                
                                                {/* Analysis Comparison */}
                                                <div>
                                                    <h4 className="font-semibold text-slate-200 mb-3">üìä Analysis Comparison</h4>
                                                    <div className={`grid ${isMobile ? 'grid-cols-1' : deepAnalysis ? 'grid-cols-2' : 'grid-cols-1'} gap-4`}>
                                                        {/* Analysis (Opus) */}
                                                        {recognizedCard.analysis && (
                                                            <div className={`p-4 rounded-lg transition-all ${
                                                                selectedAnalysisSource === 'sonnet' && deepAnalysis
                                                                    ? 'bg-purple-900/20 border border-purple-500/30'
                                                                    : 'bg-blue-900/40 border-2 border-blue-400 shadow-lg shadow-blue-500/30'
                                                            }`}>
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <h5 className="font-semibold text-blue-400">‚ö° Analysis (Opus)</h5>
                                                                    {selectedAnalysisSource === 'opus' && deepAnalysis && (
                                                                        <span className="text-xs bg-blue-600 text-white px-2 py-1 rounded-full">SELECTED</span>
                                                                    )}
                                                                </div>
                                                                <div className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{recognizedCard.analysis ? recognizedCard.analysis.replace(/\\n/g, '\n') : ''}</div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Analysis (Sonnet) */}
                                                        {deepAnalysis && (
                                                            <div className={`p-4 rounded-lg transition-all ${
                                                                selectedAnalysisSource === 'sonnet'
                                                                    ? 'bg-purple-900/40 border-2 border-purple-400 shadow-lg shadow-purple-500/30'
                                                                    : 'bg-purple-900/20 border border-purple-500/30'
                                                            }`}>
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <h5 className="font-semibold text-purple-400">üîç Analysis (Sonnet)</h5>
                                                                    {selectedAnalysisSource === 'sonnet' && (
                                                                        <span className="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">SELECTED</span>
                                                                    )}
                                                                </div>
                                                                <div className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{deepAnalysis ? deepAnalysis.replace(/\\n/g, '\n') : ''}</div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Quick Grade Report */}
                                                    {recognizedCard?.gradeReport && (
                                                        <div className="mt-2 bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                                            <div className="flex items-center justify-between mb-3">
                                                                <button 
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        const collapseKey = 'scanner-grade-report';
                                                                        setCollapsedSections(prev => ({...prev, [collapseKey]: !prev[collapseKey]}));
                                                                    }}
                                                                    className="font-semibold text-blue-400 text-sm flex items-center gap-1 hover:text-blue-300 transition-colors"
                                                                >
                                                                    üìä Quick Grade Assessment
                                                                    <span className="text-xs">{collapsedSections['scanner-grade-report'] ? '‚ñº' : '‚ñ≤'}</span>
                                                                </button>
                                                            </div>
                                                            {!collapsedSections['scanner-grade-report'] && (
                                                                <div className="text-slate-300 leading-relaxed">
                                                                    {formatQuickGradeReport(recognizedCard.gradeReport)}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                            </div>
                                        </div>
                                    )}
                                    </>
                                </div>
                            </div>
                        )}

                        {showSecondImagePrompt && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                                <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full">
                                    <h2 className="text-2xl font-bold mb-4">üì∏ Upload Second Image?</h2>
                                    <p className="text-slate-300 mb-4">
                                        You've uploaded <strong>1 image</strong>. For best results, upload both:
                                    </p>
                                    <ul className="text-sm text-slate-400 mb-6 space-y-2 ml-4">
                                        <li>‚úì <strong>Front</strong> of the card</li>
                                        <li>‚úì <strong>Back</strong> of the card (contains card number)</li>
                                    </ul>
                                    <p className="text-xs text-slate-500 mb-6 italic">
                                        The back image's card number guides AI analysis for better accuracy.
                                    </p>
                                    
                                    {/* Show the uploaded image */}
                                    {pendingImages.length > 0 && (
                                        <div className="mb-6">
                                            <p className="text-xs text-slate-400 mb-2">Current image:</p>
                                            <img 
                                                src={pendingImages[0]} 
                                                alt="Uploaded card" 
                                                className="w-full max-h-48 object-contain bg-slate-900/50 rounded-lg"
                                            />
                                        </div>
                                    )}
                                    
                                    <div className="flex flex-col gap-3">
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full bg-green-600 hover:bg-green-700 px-4 py-6 rounded-lg font-semibold text-white"
                                        >
                                            üì∑ Add Second Image
                                        </button>
                                        <button
                                            onClick={() => {
                                                setUploadedImages(pendingImages);
                                                setPendingImages([]);
                                                setShowSecondImagePrompt(false);
                                                recognizeCard(pendingImages);
                                            }}
                                            className="w-full bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg font-semibold text-white"
                                        >
                                            ‚ûú Proceed with 1 Image
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowSecondImagePrompt(false);
                                                setPendingImages([]);
                                            }}
                                            className="w-full bg-slate-600 hover:bg-slate-700 px-4 py-3 rounded-lg font-semibold text-white"
                                        >
                                            ‚úï Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Export Before Delete Modal */}
                        {showExportBeforeDelete && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full' : 'max-w-md w-full'}`}>
                                    <h2 className={`font-bold mb-4 ${isMobile ? 'text-xl' : 'text-2xl'} text-center`}>üì§ Backup Your Collection?</h2>
                                    <p className="text-slate-300 mb-6 text-sm text-center">
                                        Before deleting your collection, would you like to export a backup file? You can import it later to restore your cards.
                                    </p>
                                    <div className={`flex ${isMobile ? 'flex-col' : 'gap-3'} gap-3`}>
                                        <button
                                            onClick={() => {
                                                exportCollection();
                                                setShowExportBeforeDelete(false);
                                                setShowResetConfirm(true);
                                            }}
                                            className={`flex-1 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold py-3 ${isMobile ? 'text-base' : 'px-4'}`}
                                        >
                                            üì• Export First
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowExportBeforeDelete(false);
                                                setShowResetConfirm(true);
                                            }}
                                            className={`flex-1 bg-slate-600 hover:bg-slate-700 rounded-lg font-semibold py-3 ${isMobile ? 'text-base' : 'px-4'}`}
                                        >
                                            Skip Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showResetConfirm && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full' : 'max-w-md w-full'}`}>
                                    <h2 className={`font-bold mb-4 text-red-400 text-center ${isMobile ? 'text-xl' : 'text-2xl'}`}>‚ö†Ô∏è Delete Collection?</h2>
                                    <p className="text-slate-300 mb-6 text-sm text-center">
                                        This will PERMANENTLY DELETE your entire collection. This action CANNOT be undone!
                                    </p>
                                    <div className={`flex ${isMobile ? 'flex-col' : 'gap-3'} gap-3`}>
                                        <button
                                            onClick={() => setShowResetConfirm(false)}
                                            className={`flex-1 bg-slate-600 hover:bg-slate-700 rounded-lg font-semibold py-3 ${isMobile ? 'text-base' : 'px-4'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={resetCollection}
                                            className={`flex-1 bg-red-600 hover:bg-red-700 rounded-lg font-semibold py-3 ${isMobile ? 'text-base' : 'px-4'}`}
                                        >
                                            Yes, Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Manual Card Addition Modal */}
                        {showAddCardManual && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50"
                                onClick={() => {
                                    setShowAddCardManual(false);
                                    setManualCardData({ cardNumber: '', variant: 'Base', serialNumber: '', cardTitle: '', driverName: '', value: '' });
                                }}>
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full max-h-[95vh]' : 'max-w-2xl w-full max-h-[90vh]'} overflow-y-auto scrollbar-hide`} onClick={(e) => e.stopPropagation()}>
                                    <h2 className="text-2xl font-bold mb-2">‚ûï Add a Card</h2>
                                    <p className="text-slate-300 mb-6 text-sm">Enter card details below. Serial number is optional.</p>
                                    
                                    <div className="space-y-4">
                                        {/* Card Number */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Card Number *</label>
                                            <input
                                                type="text"
                                                value={manualCardData.cardNumber}
                                                onChange={(e) => setManualCardData({...manualCardData, cardNumber: e.target.value})}
                                                placeholder="e.g., 1, 5, 25"
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            />
                                        </div>
                                        
                                        {/* Variant Selector */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Variant</label>
                                            <select
                                                value={manualCardData.variant}
                                                onChange={(e) => setManualCardData({...manualCardData, variant: e.target.value})}
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            >
                                                {OFFICIAL_VARIANTS.map(variant => (
                                                    <option key={variant} value={variant}>{variant}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        {/* Serial Number */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Serial Number (Optional)</label>
                                            <input
                                                type="text"
                                                value={manualCardData.serialNumber}
                                                onChange={(e) => setManualCardData({...manualCardData, serialNumber: e.target.value})}
                                                placeholder="e.g., 63/250, /99, N/A"
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            />
                                            <p className="text-xs text-slate-500 mt-1">The serial number helps identify the correct variant.</p>
                                        </div>
                                        
                                        {/* Driver/Card Title Section */}
                                        {loadingCardDetails && (
                                            <div className="bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                                <p className="text-xs text-blue-300">
                                                    üîç Looking up card details...
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Driver Name */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Driver Name (Optional)</label>
                                            <input
                                                type="text"
                                                value={manualCardData.driverName}
                                                onChange={(e) => setManualCardData({...manualCardData, driverName: e.target.value})}
                                                placeholder="e.g., Max Verstappen, Lewis Hamilton"
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            />
                                        </div>
                                        
                                        {/* Card Title */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Card Title (Optional)</label>
                                            <input
                                                type="text"
                                                value={manualCardData.cardTitle}
                                                onChange={(e) => setManualCardData({...manualCardData, cardTitle: e.target.value})}
                                                placeholder="e.g., F1 Drivers, F2 Drivers, F1 Cars"
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            />
                                        </div>
                                        
                                        {/* Card Value */}
                                        <div>
                                            <label className="text-sm font-semibold text-slate-300 block mb-2">Estimated Value (Optional)</label>
                                            <input
                                                type="text"
                                                value={manualCardData.value}
                                                onChange={(e) => setManualCardData({...manualCardData, value: e.target.value})}
                                                placeholder="e.g., $2-5, $10-15"
                                                className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:border-blue-500 focus:outline-none text-white"
                                            />
                                            <p className="text-xs text-slate-500 mt-1">Market value estimate for reference.</p>
                                        </div>
                                        
                                        {/* Info box */}
                                        <div className="bg-blue-900/20 border border-blue-500/30 rounded p-3 mt-4">
                                            <p className="text-xs text-blue-300">
                                                <strong>‚ÑπÔ∏è Tip:</strong> If you have the physical card, take a photo of the back to get the exact serial number.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Action Buttons */}
                                    <div className="flex gap-3 mt-6">
                                        <button
                                            onClick={() => {
                                                if (manualCardData.cardNumber.trim()) {
                                                    addCard(manualCardData.cardNumber, manualCardData.variant, null, null);
                                                    setShowAddCardManual(false);
                                                    setManualCardData({ cardNumber: '', variant: 'Base', serialNumber: '', cardTitle: '', driverName: '', value: '' });
                                                } else {
                                                    alert('Please enter a card number');
                                                }
                                            }}
                                            className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold text-sm transition-all"
                                        >
                                            ‚úì Add Card
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowAddCardManual(false);
                                                setManualCardData({ cardNumber: '', variant: 'Base', serialNumber: '', cardTitle: '', driverName: '', value: '' });
                                            }}
                                            className="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg font-semibold text-sm transition-all"
                                        >
                                            ‚úï Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Variant Selection Modal */}
                        {variantValidationModal && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                                <div className={`bg-slate-800 rounded-2xl p-6 ${isMobile ? 'w-full max-h-[90vh]' : 'max-w-md w-full max-h-96'} overflow-y-auto`}>
                                    <h2 className="text-2xl font-bold mb-2">‚ö†Ô∏è Confirm Card Variant</h2>
                                    <p className="text-slate-300 mb-4 text-sm">
                                        The AI detected "<span className="font-semibold text-blue-300">{variantValidationModal.aiVariant}</span>" but this doesn't match our official variants list.
                                    </p>
                                    <p className="text-slate-400 mb-4 text-sm">
                                        Please select the correct variant for Card #{variantValidationModal.cardNum}:
                                    </p>
                                    <div className="space-y-3 mb-4 max-h-96 overflow-y-auto">
                                        {/* Standard */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">Standard</p>
                                            {['Base', 'Refractor'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Numbered Color Refractors */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">Numbered Refractors</p>
                                            {['Teal Refractor /299', 'Pink Refractor /250', 'Aqua Refractor /199', 'Blue Refractor /150', 'Green Refractor /99', 'F1 75th Anniversary Refractor /75', 'Gold Refractor /50', 'Orange Refractor /25', 'Black Refractor /10', 'Red Refractor /5'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Checker Flag Parallels */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">Checker Flag Parallels</p>
                                            {['Checker Flag', 'Pink Checker Flag /250', 'Aqua Checker Flag /199', 'Blue Checker Flag /150', 'Green Checker Flag /99', 'Gold Checker Flag /50', 'Orange Checker Flag /25', 'Black Checker Flag /10', 'Red Checker Flag /5'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>

                                        {/* RayWave Parallels */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">RayWave Parallels</p>
                                            {['B&W RayWave', 'Pink RayWave /250', 'Aqua RayWave /199', 'Blue RayWave /150', 'Forest Green RayWave /140', 'Green RayWave /99', 'Gold RayWave /50', 'Orange RayWave /25', 'Black RayWave /10', 'Red RayWave /5'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Lazer & Special Types */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">Lazer & Special</p>
                                            {['B&W Lazer', 'SuperFractor 1/1', 'Logofractor', 'Sapphire Edition', 'Padparadscha Sapphire 1/1'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Printing Plates */}
                                        <div>
                                            <p className="text-xs font-bold text-slate-400 px-3 py-2 uppercase">Printing Plates</p>
                                            {['Printing Plate Cyan 1/1', 'Printing Plate Magenta 1/1', 'Printing Plate Yellow 1/1', 'Printing Plate Black 1/1'].map(variant => (
                                                <button
                                                    key={variant}
                                                    onClick={() => {
                                                        addCardWithVariant(
                                                            variantValidationModal.cardNum,
                                                            variant,
                                                            variantValidationModal.pendingAnalysis
                                                        );
                                                    }}
                                                    className="w-full text-left p-3 rounded-lg bg-slate-700 hover:bg-blue-600 transition-colors mb-1"
                                                >
                                                    {variant}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setVariantValidationModal(null)}
                                        className="w-full bg-slate-600 hover:bg-slate-700 px-4 py-2 rounded-lg font-semibold"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                        {showImageViewer && uploadedImages && uploadedImages.length > 0 && (
                            <div className="fixed inset-0 bg-black/95 flex items-center justify-center z-50">
                                {/* Top Controls */}
                                <div className="absolute top-4 right-4 flex gap-2 z-10">
                                    <button
                                        onClick={() => setImageViewerZoom(Math.max(0.5, imageViewerZoom - 0.25))}
                                        className="bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-semibold px-4 py-2"
                                        title="Zoom Out"
                                    >
                                        ‚àí
                                    </button>
                                    <button
                                        onClick={() => setImageViewerZoom(1)}
                                        className="bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-semibold px-4 py-2"
                                        title="Reset Zoom"
                                    >
                                        {Math.round(imageViewerZoom * 100)}%
                                    </button>
                                    <button
                                        onClick={() => setImageViewerZoom(Math.min(5, imageViewerZoom + 0.25))}
                                        className="bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-semibold px-4 py-2"
                                        title="Zoom In"
                                    >
                                        +
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowImageViewer(false);
                                            setImageViewerZoom(1);
                                            setImageViewerPosition({ x: 0, y: 0 });
                                            setCurrentImageIndex(0);
                                        }}
                                        className="bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold px-4 py-2"
                                        title="Close"
                                    >
                                        ‚úï
                                    </button>
                                </div>

                                {/* Image Counter */}
                                {uploadedImages.length > 1 && (
                                    <div className="absolute top-4 left-4 bg-slate-800/90 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                        {uploadedImages.length === 2 ? (currentImageIndex === 0 ? 'üì∑ Front' : 'üì∑ Back') : `üì∑ Image ${currentImageIndex + 1}/${uploadedImages.length}`}
                                    </div>
                                )}

                                {/* Main Image Container */}
                                <div 
                                    className="w-full h-full flex items-center justify-center overflow-hidden p-8 select-none"
                                    onWheel={(e) => {
                                        e.preventDefault();
                                        const delta = e.deltaY > 0 ? -0.1 : 0.1;
                                        setImageViewerZoom(Math.max(0.5, Math.min(5, imageViewerZoom + delta)));
                                    }}
                                    onTouchStart={(e) => {
                                        if (e.touches.length === 2) {
                                            const touch1 = e.touches[0];
                                            const touch2 = e.touches[1];
                                            const distance = Math.hypot(
                                                touch2.clientX - touch1.clientX,
                                                touch2.clientY - touch1.clientY
                                            );
                                            setImageViewerTouchStart({ x: 0, y: 0, distance });
                                        } else if (e.touches.length === 1) {
                                            setImageViewerTouchStart({ 
                                                x: e.touches[0].clientX, 
                                                y: e.touches[0].clientY, 
                                                distance: 0 
                                            });
                                        }
                                    }}
                                    onTouchMove={(e) => {
                                        if (e.touches.length === 2) {
                                            const touch1 = e.touches[0];
                                            const touch2 = e.touches[1];
                                            const distance = Math.hypot(
                                                touch2.clientX - touch1.clientX,
                                                touch2.clientY - touch1.clientY
                                            );
                                            
                                            if (imageViewerTouchStart.distance > 0) {
                                                const scale = distance / imageViewerTouchStart.distance;
                                                const newZoom = Math.max(0.5, Math.min(5, imageViewerZoom * scale));
                                                setImageViewerZoom(newZoom);
                                            }
                                            setImageViewerTouchStart({ ...imageViewerTouchStart, distance });
                                        } else if (e.touches.length === 1 && imageViewerZoom > 1) {
                                            const deltaX = e.touches[0].clientX - imageViewerTouchStart.x;
                                            const deltaY = e.touches[0].clientY - imageViewerTouchStart.y;
                                            setImageViewerPosition({
                                                x: imageViewerPosition.x + deltaX,
                                                y: imageViewerPosition.y + deltaY
                                            });
                                            setImageViewerTouchStart({ 
                                                x: e.touches[0].clientX, 
                                                y: e.touches[0].clientY, 
                                                distance: 0 
                                            });
                                        }
                                    }}
                                >
                                    <img 
                                        src={uploadedImages[currentImageIndex]} 
                                        alt={`Card image ${currentImageIndex + 1}`}
                                        style={{
                                            transform: `scale(${imageViewerZoom}) translate(${imageViewerPosition.x}px, ${imageViewerPosition.y}px)`,
                                            maxWidth: '90vw',
                                            maxHeight: '90vh',
                                            objectFit: 'contain',
                                            transition: imageViewerZoom === 1 ? 'transform 0.2s ease-out' : 'none'
                                        }}
                                        draggable={false}
                                    />
                                </div>

                                {/* Navigation Buttons - Show only if multiple images */}
                                {uploadedImages.length > 1 && (
                                    <>
                                        <button
                                            onClick={() => {
                                                setCurrentImageIndex((prev) => (prev === 0 ? uploadedImages.length - 1 : prev - 1));
                                                setImageViewerZoom(1);
                                                setImageViewerPosition({ x: 0, y: 0 });
                                            }}
                                            className="absolute left-4 top-1/2 -translate-y-1/2 bg-slate-800/80 hover:bg-slate-700 text-white rounded-lg font-bold px-4 py-3 text-2xl transition-all"
                                            title="Previous image"
                                        >
                                            ‚Äπ
                                        </button>
                                        <button
                                            onClick={() => {
                                                setCurrentImageIndex((prev) => (prev === uploadedImages.length - 1 ? 0 : prev + 1));
                                                setImageViewerZoom(1);
                                                setImageViewerPosition({ x: 0, y: 0 });
                                            }}
                                            className="absolute right-4 top-1/2 -translate-y-1/2 bg-slate-800/80 hover:bg-slate-700 text-white rounded-lg font-bold px-4 py-3 text-2xl transition-all"
                                            title="Next image"
                                        >
                                            ‚Ä∫
                                        </button>
                                    </>
                                )}

                                {/* Instructions */}
                                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-6 py-3 rounded-lg text-sm">
                                    <p>üì± Pinch to zoom ‚Ä¢ üëÜ Drag to pan ‚Ä¢ üñ±Ô∏è Scroll to zoom ‚Ä¢ Buttons to zoom</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
