<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Card Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="card-database.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .hamburger { cursor: pointer; font-size: 1.5rem; }
        .dropdown-menu { position: absolute; top: 60px; left: 16px; background: #1e293b; border: 1px solid #475569; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 1000; min-width: 180px; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; color: #fff; border-bottom: 1px solid #475569; transition: background 0.2s; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #334155; }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>
    
    <script src="card-database.js"></script>
    
    <script>
        // Authentication check
        const token = localStorage.getItem('f1-token');
        if (!token) {
          window.location.href = 'login.html';
        }
        
        const userEmail = localStorage.getItem('f1-email') || 'User';
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE = "https://f1-card-tracker-backend-1.onrender.com";
        const API_URL = API_BASE + "/api/recognize";
        const cardData = COMPLETE_CARD_DATABASE || [];

        // Helper to add auth header
        function getAuthHeaders() {
          return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          };
        }

        const variants = [
            "Base", "Refractor", "Purple Refractor /299", "Blue Refractor /150",
            "Green Refractor /99", "Gold Refractor /50", "Orange Refractor /25",
            "Red Refractor /5", "SuperFractor 1/1", "Printing Plate 1/1",
            "Black Refractor /10", "Magenta/Pink Refractor /250", "Gold Wave /75"
        ];

        function CardTracker() {
            const [collection, setCollection] = useState({});
            const [uploadedImages, setUploadedImages] = useState([]);
            const [recognitionResult, setRecognitionResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [showScanner, setShowScanner] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [selectedModel, setSelectedModel] = useState('sonnet');
            const [showMenuDropdown, setShowMenuDropdown] = useState(false);
            const menuRef = useRef(null);

            const userId = 'cincymed-f1-collection';

            useEffect(() => {
                loadCollection();
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            function handleClickOutside(event) {
                if (menuRef.current && !menuRef.current.contains(event.target)) {
                    setShowMenuDropdown(false);
                }
            }

            const loadCollection = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/collection/${userId}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();
                    
                    if (data.cards && Object.keys(data.cards).length > 0) {
                        setCollection(data.cards);
                        return;
                    }
                } catch (error) {
                    console.log('MongoDB not available, using localStorage');
                }

                const saved = localStorage.getItem('f1-collection-pro-v2');
                if (saved) {
                    setCollection(JSON.parse(saved));
                }
            };

            const saveCollection = (newCollection) => {
                try {
                    const cleanedCollection = cleanupCollection(newCollection);
                    setCollection(cleanedCollection);
                    
                    localStorage.setItem('f1-collection-pro-v2', JSON.stringify(cleanedCollection));
                    
                    if (token) {
                        fetch(`${API_BASE}/api/collection/${userId}`, {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({ cards: cleanedCollection })
                        }).then(() => {
                            console.log('‚úÖ Collection synced to MongoDB');
                        }).catch(error => {
                            console.log('Sync to MongoDB failed, using localStorage backup');
                        });
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                }
            };

            const cleanupCollection = (coll) => {
                const cleaned = { ...coll };
                Object.keys(cleaned).forEach(cardKey => {
                    const variants = cleaned[cardKey];
                    Object.keys(variants).forEach(variant => {
                        if (variant !== '_analyses' && !variant.startsWith('_')) {
                            if (!variants[variant] || variants[variant] <= 0) {
                                delete variants[variant];
                            }
                        }
                    });
                    if (Object.keys(variants).every(k => k === '_analyses' || !variants[k])) {
                        delete cleaned[cardKey];
                    }
                });
                return cleaned;
            };

            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files || []);
                const imagePromises = files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            resolve({ name: file.name, data: reader.result });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(imagePromises).then(images => {
                    setUploadedImages([...uploadedImages, ...images]);
                    setShowScanner(true);
                });
            };

            const handleCameraCapture = async (canvas) => {
                const data = canvas.toDataURL('image/jpeg');
                setUploadedImages([...uploadedImages, { name: 'Camera Capture', data }]);
                setShowScanner(true);
            };

            const analyzeImage = async (imageData) => {
                setIsLoading(true);
                setRecognitionResult(null);

                try {
                    const messages = [{
                        role: 'user',
                        content: [
                            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: imageData.split(',')[1] } },
                            { type: 'text', text: 'Analyze this F1 trading card image. Return ONLY valid JSON with: cardNumber (exact number), variant (from list: Base, Refractor, Purple Refractor /299, Blue Refractor /150, Green Refractor /99, Gold Refractor /50, Orange Refractor /25, Red Refractor /5, SuperFractor 1/1, Printing Plate 1/1, Black Refractor /10, Magenta/Pink Refractor /250, Gold Wave /75), driverName, team, cardCondition (Mint/NearMint/Excellent/Good), estimatedValue (numeric USD), confidence (0-100). If invalid, return {"error":"description"}' }
                        ]
                    }];

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            messages,
                            model: selectedModel === 'opus' ? 'claude-opus-4-20250805' : 'claude-sonnet-4-20250514',
                            max_tokens: 500
                        })
                    });

                    if (!response.ok) throw new Error('API error');

                    const data = await response.json();
                    const content = data.content[0]?.text || '';
                    
                    try {
                        const parsed = JSON.parse(content);
                        setAnalysis(parsed);
                        setRecognitionResult(parsed);
                    } catch {
                        setRecognitionResult({ error: 'Invalid response from API' });
                    }
                } catch (error) {
                    setRecognitionResult({ error: 'Recognition error: ' + error.message });
                } finally {
                    setIsLoading(false);
                }
            };

            const addCard = () => {
                if (!recognitionResult || recognitionResult.error) return;

                const { cardNumber, variant } = recognitionResult;
                let normalizedVariant = variant;
                if (normalizedVariant === 'Base Chrome') normalizedVariant = 'Base';

                const newCollection = { ...collection };
                const cardKey = `card-${cardNumber}`;

                if (!newCollection[cardKey]) {
                    newCollection[cardKey] = { _analyses: [] };
                }

                newCollection[cardKey][normalizedVariant] = (newCollection[cardKey][normalizedVariant] || 0) + 1;

                if (!newCollection[cardKey]._analyses) {
                    newCollection[cardKey]._analyses = [];
                }
                newCollection[cardKey]._analyses.push({ ...recognitionResult, timestamp: new Date().toISOString() });

                setUploadedImages(uploadedImages.filter((_, i) => i !== 0));
                setRecognitionResult(null);
                setAnalysis(null);
                saveCollection(newCollection);
            };

            const removeCard = (cardNumber, variant) => {
                const newCollection = { ...collection };
                const cardKey = `card-${cardNumber}`;
                if (newCollection[cardKey]?.[variant]) {
                    newCollection[cardKey][variant]--;
                }
                saveCollection(newCollection);
            };

            const exportCollection = () => {
                const dataStr = JSON.stringify(collection, null, 2);
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(dataStr));
                element.setAttribute('download', 'f1-collection.json');
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const importCollection = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            setCollection(imported);
                            saveCollection(imported);
                            alert('‚úÖ Collection imported successfully!');
                        } catch {
                            alert('‚ùå Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const resetCollection = () => {
                if (confirm('Are you sure? This will delete ALL cards.')) {
                    setCollection({});
                    saveCollection({});
                    alert('‚úÖ Collection reset');
                }
            };

            const handleLogout = () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('f1-token');
                    localStorage.removeItem('f1-email');
                    window.location.href = 'login.html';
                }
            };

            const getCardsInCollection = () => {
                return Object.keys(collection)
                    .filter(key => !key.startsWith('_'))
                    .map(key => key.replace('card-', ''))
                    .sort((a, b) => {
                        const numA = parseInt(a) || 999999;
                        const numB = parseInt(b) || 999999;
                        return numA - numB;
                    });
            };

            const getTotalCards = () => {
                let count = 0;
                Object.values(collection).forEach(variants => {
                    Object.entries(variants).forEach(([variant, qty]) => {
                        if (variant !== '_analyses' && !variant.startsWith('_')) {
                            count += qty || 0;
                        }
                    });
                });
                return count;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-4">
                    {/* Header with Hamburger Menu */}
                    <div className="mb-8 relative">
                        <div className="flex justify-between items-start mb-6">
                            {/* Hamburger Menu */}
                            <div ref={menuRef} className="relative">
                                <button
                                    onClick={() => setShowMenuDropdown(!showMenuDropdown)}
                                    className="hamburger text-white hover:text-blue-400 transition"
                                >
                                    ‚ò∞
                                </button>
                                {showMenuDropdown && (
                                    <div className="dropdown-menu">
                                        <div className="dropdown-item" onClick={importCollection}>
                                            üì• Import
                                        </div>
                                        <div className="dropdown-item" onClick={exportCollection}>
                                            üì§ Export
                                        </div>
                                        <div className="dropdown-item" onClick={resetCollection}>
                                            üîÑ Reset
                                        </div>
                                        <div className="dropdown-item" onClick={handleLogout}>
                                            üö™ Logout
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Title and Dashboard Button */}
                            <div className="text-center flex-1">
                                <div className="mb-2">
                                    <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 via-red-500 to-yellow-400 bg-clip-text text-transparent">
                                        2025 Topps Chrome F1 Collection
                                    </h1>
                                </div>
                            </div>

                            {/* Dashboard Link */}
                            <a href="dashboard.html" className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
                                üìä Dashboard
                            </a>
                        </div>
                    </div>

                    {/* Main Content */}
                    {showScanner ? (
                        <div className="max-w-4xl mx-auto">
                            {/* Scanner Section */}
                            <div className="bg-slate-800 rounded-lg border border-slate-700 p-8 mb-8">
                                <h2 className="text-2xl font-bold mb-6">üì∑ AI Scanner</h2>

                                {uploadedImages.length > 0 && (
                                    <div className="mb-6">
                                        <img 
                                            src={uploadedImages[0].data} 
                                            alt="Uploaded" 
                                            className="max-w-full h-auto rounded-lg mb-4 max-h-96"
                                        />

                                        {!recognitionResult && !isLoading && (
                                            <button
                                                onClick={() => analyzeImage(uploadedImages[0].data)}
                                                className="w-full bg-green-600 hover:bg-green-700 font-semibold py-3 rounded-lg"
                                            >
                                                ü§ñ Analyze Card
                                            </button>
                                        )}

                                        {isLoading && (
                                            <div className="text-center text-blue-400">
                                                <p>Analyzing card...</p>
                                            </div>
                                        )}

                                        {recognitionResult && !recognitionResult.error && (
                                            <div className="bg-slate-700 p-6 rounded-lg mb-4">
                                                <h3 className="font-bold mb-4">Card Details</h3>
                                                <div className="grid grid-cols-2 gap-4 mb-4">
                                                    <div>
                                                        <label className="text-sm text-slate-400">Card #</label>
                                                        <input
                                                            type="text"
                                                            value={recognitionResult.cardNumber}
                                                            onChange={(e) => setRecognitionResult({...recognitionResult, cardNumber: e.target.value})}
                                                            className="w-full bg-slate-600 px-3 py-2 rounded text-white"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-sm text-slate-400">Variant</label>
                                                        <select
                                                            value={recognitionResult.variant}
                                                            onChange={(e) => setRecognitionResult({...recognitionResult, variant: e.target.value})}
                                                            className="w-full bg-slate-600 px-3 py-2 rounded text-white"
                                                        >
                                                            {variants.map(v => <option key={v} value={v}>{v}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button
                                                        onClick={addCard}
                                                        className="bg-blue-600 hover:bg-blue-700 font-semibold py-2 rounded-lg"
                                                    >
                                                        ‚úì Done
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            setUploadedImages(uploadedImages.slice(1));
                                                            setRecognitionResult(null);
                                                        }}
                                                        className="bg-red-600 hover:bg-red-700 font-semibold py-2 rounded-lg"
                                                    >
                                                        ‚úó Skip
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        {recognitionResult?.error && (
                                            <div className="bg-red-900 p-4 rounded-lg text-red-200 mb-4">
                                                {recognitionResult.error}
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="flex gap-4">
                                    <label className="flex-1 bg-blue-600 hover:bg-blue-700 font-semibold py-3 rounded-lg text-center cursor-pointer">
                                        üì± Take Photo
                                        <input type="file" accept="image/*" capture="environment" onChange={handleImageUpload} className="hidden" />
                                    </label>
                                    <label className="flex-1 bg-purple-600 hover:bg-purple-700 font-semibold py-3 rounded-lg text-center cursor-pointer">
                                        üñºÔ∏è Upload Image
                                        <input type="file" accept="image/*" multiple onChange={handleImageUpload} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="max-w-4xl mx-auto">
                            {/* Collection Summary */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                    <div className="text-slate-400 text-sm">Total Cards</div>
                                    <div className="text-3xl font-bold text-green-400">{getTotalCards()}</div>
                                </div>
                                <div className="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                    <div className="text-slate-400 text-sm">Unique Cards</div>
                                    <div className="text-3xl font-bold text-blue-400">{getCardsInCollection().length}</div>
                                </div>
                                <div className="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                    <div className="text-slate-400 text-sm">Completion</div>
                                    <div className="text-3xl font-bold text-purple-400">
                                        {((getCardsInCollection().length / cardData.length) * 100).toFixed(1)}%
                                    </div>
                                </div>
                                <div className="bg-slate-800 rounded-lg p-6 border border-slate-700">
                                    <div className="text-slate-400 text-sm">Model</div>
                                    <select
                                        value={selectedModel}
                                        onChange={(e) => setSelectedModel(e.target.value)}
                                        className="bg-slate-700 text-white px-3 py-1 rounded mt-2"
                                    >
                                        <option value="sonnet">Sonnet 4</option>
                                        <option value="opus">Opus 4</option>
                                    </select>
                                </div>
                            </div>

                            {/* Start Scanning Button */}
                            <button
                                onClick={() => setShowScanner(true)}
                                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 font-bold py-4 rounded-lg text-lg mb-8"
                            >
                                üì∑ Start Scanning Cards
                            </button>

                            {/* Collection Grid */}
                            {getCardsInCollection().length > 0 && (
                                <div className="bg-slate-800 rounded-lg border border-slate-700 p-6">
                                    <h3 className="text-xl font-bold mb-6">Your Collection</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {getCardsInCollection().map(cardNum => {
                                            const card = cardData.find(c => c.num === cardNum);
                                            const cardKey = `card-${cardNum}`;
                                            const cardVariants = collection[cardKey];
                                            const totalCount = Object.entries(cardVariants)
                                                .filter(([k]) => !k.startsWith('_'))
                                                .reduce((sum, [_, qty]) => sum + (qty || 0), 0);

                                            return (
                                                <div key={cardNum} className="bg-slate-700 rounded-lg p-4 border border-slate-600 hover:border-blue-500 transition">
                                                    <h4 className="font-bold text-lg mb-2">#{card?.num} {card?.name}</h4>
                                                    <p className="text-sm text-slate-400 mb-3">{card?.team}</p>
                                                    <div className="space-y-2 mb-4">
                                                        {Object.entries(cardVariants)
                                                            .filter(([k]) => !k.startsWith('_'))
                                                            .map(([variant, qty]) => (
                                                                <div key={variant} className="flex justify-between items-center text-sm">
                                                                    <span>{variant}</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-bold">{qty}</span>
                                                                        <button
                                                                            onClick={() => removeCard(cardNum, variant)}
                                                                            className="text-red-400 hover:text-red-300"
                                                                        >
                                                                            ‚úï
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                    </div>
                                                    <div className="text-center text-green-400 font-semibold">
                                                        Total: {totalCount}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<CardTracker />, document.getElementById('root'));
    </script>
</body>
</html>